{% extends 'base.html' %}

{% block title %}{{ module.title }} - ModuLearn{% endblock %}

{% block content %}
<div class="module-content">
  <h1>{{ module.title }}</h1>
  <p>{{ module.description }}</p>

  <a href="{% url 'courses:course_detail' module.unit.course.id %}" class="btn btn-dark text-light mb-3">Return to Course</a>

  <iframe id="module-iframe" src="{% url 'courses:launch_iframe_module' module.id %}" width="100%" height="800px" frameborder="0" allowfullscreen style="background-color: white; border: 2px solid #ccc;">
    Your browser doesn't support iframes.
  </iframe>

  <a href="{% url 'courses:course_detail' module.unit.course.id %}" class="btn btn-dark mt-3">Return to Course</a>
</div>

<script>
  // Add a listener for messages from the iframe
  console.log("TEST")
  window.addEventListener('message', function(event) {
    console.log("Message received from:", event.origin);

    // Validate the origin for security
    const expectedOrigins = ['http://pawscomp2.sis.pitt.edu', 'http://127.0.0.1:8000'];
    if (!expectedOrigins.includes(event.origin)) {
      console.warn('Unexpected message origin:', event.origin);
      return;
    }

    // Parse and handle the message data
    const data = event.data;
    if (data) {
      console.log("LTI Response:", data);

      // Example: Display the response in an alert (or handle it in another way)
      alert(`Exercise Result: ${JSON.stringify(data)}`);

      // Optional: Send the data to the server for logging or processing
      fetch('{% url "courses:log_lti_response" %}', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({ result: data })
      })
      .then(response => response.json())
      .then(serverResponse => {
        console.log('Response logged to the server:', serverResponse);
      })
      .catch(error => {
        console.error('Error logging response to server:', error);
      });
    }
  });
</script>

{% endblock %}