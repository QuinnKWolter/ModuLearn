{% extends 'content_base.html' %}

{% block content %}
<div id="module-frame-container">
  {{ state_data|json_script:"state-data" }}

  <!-- Debug template variables -->
  <!-- selected_protocol: {{ selected_protocol }} -->
  <!-- content_url: {{ content_url }} -->
  <!-- use_proxy: {{ use_proxy }} -->

  <!-- Fallback UI for tools that refuse iframe embedding -->
  <div id="iframe-blocked-notice" class="{% if not refuses_iframe %}hidden{% endif %} p-8 text-center bg-gray-50 dark:bg-gray-800 rounded-lg mx-4 my-4">
    <h3 class="text-red-500 text-xl font-bold mb-4">⚠️ This tool cannot be embedded</h3>
    <p class="text-gray-500 dark:text-gray-400 mb-4">
      {% if refuses_iframe_reason %}
        {{ refuses_iframe_reason }}
      {% else %}
        The external tool has security restrictions that prevent it from loading in an iframe.
      {% endif %}
    </p>
    <button id="open-in-new-window"
            onclick="window.open('{{ iframe_src|escapejs }}', '_blank')"
            class="btn btn-primary btn-lg">
      Open in New Window →
    </button>
    <p class="text-gray-400 text-sm mt-4">
      Note: Progress may not be tracked when opened in a new window.
    </p>
  </div>

  <iframe id="content-iframe"
          src="{% if not refuses_iframe %}{{ iframe_src }}{% endif %}"
          width="100%"
          height="800px"
          frameborder="0"
          allowfullscreen
          allow="clipboard-write *"
          {% if refuses_iframe %}class="hidden"{% endif %}>
    Your browser doesn't support iframes.
  </iframe>
</div>

<script>
  const selectedProtocol = "{{ selected_protocol|default:'' }}";
  const contentUrl = "{{ content_url|escapejs }}";
  const useProxy = {{ use_proxy|yesno:"true,false" }};
  const iframeSrc = "{{ iframe_src|escapejs }}";

  console.log("Selected module protocol:", selectedProtocol || "(none)");
  console.log("Content URL:", contentUrl);
  console.log("Use proxy:", useProxy);
  console.log("Iframe src:", iframeSrc);
  console.log("Current iframe src:", document.getElementById('content-iframe').src);

  const isPreview = {{ preview_mode|yesno:"true,false" }};

  // CSP / Iframe Load Error Detection
  let iframeLoaded = false;
  const iframe = document.getElementById('content-iframe');
  const blockedNotice = document.getElementById('iframe-blocked-notice');

  iframe.addEventListener('load', function() {
    iframeLoaded = true;
    probeSplice();
    setTimeout(probeSplice, 1000);
    setTimeout(probeSplice, 3000);
  });

  document.addEventListener('securitypolicyviolation', function(e) {
    console.log('CSP Violation detected:', e);
    // Check if this is a frame-ancestors violation (iframe blocking)
    if (e.violatedDirective === 'frame-ancestors' || 
        e.violatedDirective.includes('frame-ancestors') ||
        (e.blockedURI && iframeSrc && e.blockedURI.includes(new URL(iframeSrc).hostname))) {
      console.log('Frame-ancestors violation - showing blocked notice');
      showBlockedNotice(
        `This tool cannot be embedded in an iframe due to Content Security Policy restrictions. ` +
        `The tool only allows framing from specific origins. ` +
        `Please use the "Open in New Window" button below to access this activity.`
      );
    }
  });
  
  // Also check for iframe load errors
  iframe.addEventListener('error', function(e) {
    console.log('Iframe load error:', e);
    // Check if iframe is still empty after a delay
    setTimeout(function() {
      try {
        const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
        if (!iframeDoc || !iframeDoc.body || iframeDoc.body.innerHTML.trim() === '') {
          console.log('Iframe appears empty - may be blocked by CSP');
          showBlockedNotice(
            `The tool failed to load. This may be due to Content Security Policy restrictions. ` +
            `Please use the "Open in New Window" button below to access this activity.`
          );
        }
      } catch (e) {
        // Cross-origin - can't check, but if we get here and iframe is empty, it might be blocked
        console.log('Cannot check iframe content (cross-origin)');
      }
    }, 2000);
  });

  setTimeout(function() {
    try {
      const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
      if (iframeDoc && iframeDoc.body && iframeDoc.body.innerHTML.trim() === '') {
        console.warn("Iframe appears empty - may be blocked by CSP");
      }
    } catch (e) {
      console.log("Iframe cross-origin (expected for external tools)");
    }
  }, 3000);

  function showBlockedNotice(reason) {
    blockedNotice.classList.remove('hidden');
    iframe.classList.add('hidden');
  }

  function uuid() {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
      const r = (Math.random() * 16) | 0;
      const v = c === 'x' ? r : (r & 0x3) | 0x8;
      return v.toString(16);
    });
  }

  function probeSplice() {
    const iframe = document.getElementById('content-iframe');
    if (!iframe || !iframe.contentWindow) return;
    const probes = [
      { subject: 'SPLICE.getState', message_id: uuid() },
      { subject: 'SPLICE.ping', message_id: uuid() },
      { subject: 'SPLICE.hello', message_id: uuid() },
    ];
    for (const msg of probes) {
      iframe.contentWindow.postMessage(msg, '*');
    }
  }

  window.addEventListener('message', function(event) {
    const expectedOrigins = new Set([
      window.location.origin,
      'https://codecheck.me', 'https://codecheck.io',
      'http://adapt2.sis.pitt.edu', 'http://pawscomp2.sis.pitt.edu', 'http://columbus.exp.sis.pitt.edu',
      'https://adapt2.sis.pitt.edu', 'https://pawscomp2.sis.pitt.edu', 'https://columbus.exp.sis.pitt.edu',
      'https://pcrs.utm.utoronto.ca/',
    ]);

    if (!expectedOrigins.has(event.origin)) return;

    if (event.data.subject === 'SPLICE.getState') {
      const stateScript = document.getElementById('state-data');
      let storedState = stateScript ? JSON.parse(stateScript.textContent) : null;
      if (storedState) {
        if (typeof storedState === 'string') storedState = JSON.parse(storedState);
        document.getElementById('content-iframe').contentWindow.postMessage({
          subject: 'SPLICE.getState.response',
          message_id: event.data.message_id,
          state: storedState
        }, event.origin);
      }
    }

    if (event.data.subject === 'lti.frameResize') return;

    if (event.data.subject === 'SPLICE.reportScoreAndState') {
      if (isPreview) return;
      let progress = 0;
      if (event.data.state && event.data.state.scoreText) {
        const scoreText = event.data.state.scoreText;
        if (scoreText.includes('/')) {
          const [completed, total] = scoreText.split('/').map(num => parseInt(num));
          progress = (completed / total) * 100;
        }
      }

      fetch('{% url "courses:update_module_progress" module.id %}', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
        body: JSON.stringify({
          data: [{
            activityId: '{{ module.id }}',
            completion: event.data.score === 1.0,
            score: event.data.score * 100,
            success: event.data.score >= 0.7,
            progress: progress,
            response: event.data.state
          }]
        })
      })
      .then(response => response.json())
      .then(json => console.log('Progress updated:', json))
      .catch(error => console.error('Error updating progress:', error));
    }
  });
</script>

{% csrf_token %}
{% endblock %}
