{% extends 'base.html' %}
{% load tailwind_filters %}

{% block title %}Profile - ModuLearn{% endblock %}

{% block content %}
<div class="py-8">
  <h1 class="text-3xl font-bold mb-6">Your Profile</h1>

  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
    <!-- User Information Card -->
    <div class="card overflow-hidden">
      <div class="bg-blue-600 dark:bg-blue-700 text-white px-6 py-3">
        <h5 class="font-semibold flex items-center gap-2 m-0">
          <i class="bi bi-person-circle"></i> User Information
        </h5>
      </div>
      <div class="p-6 space-y-2">
        <p><strong>Username:</strong> {{ user.username }}</p>
        {% if user.email %}
          <p><strong>Email:</strong> {{ user.email }}</p>
        {% endif %}
        {% if user.full_name %}
          <p><strong>Full Name:</strong> {{ user.full_name }}</p>
        {% endif %}
        <p><strong>Role:</strong>
          {% if user.is_instructor and user.is_student %}
            Instructor &amp; Student
          {% elif user.is_instructor %}
            Instructor
          {% elif user.is_student %}
            Student
          {% else %}
            None
          {% endif %}
        </p>
        {% if user.kt_login or user.kt_user_id %}
          <hr class="border-gray-200 dark:border-gray-700 my-3">
          <h6 class="text-sm font-semibold text-gray-500 dark:text-gray-400">KnowledgeTree Integration</h6>
          {% if user.kt_login %}
            <p class="text-sm text-gray-500 dark:text-gray-400"><strong>KT Login:</strong> {{ user.kt_login }}</p>
          {% endif %}
          {% if user.kt_user_id %}
            <p class="text-sm text-gray-500 dark:text-gray-400"><strong>KT User ID:</strong> {{ user.kt_user_id }}</p>
          {% endif %}
          {% if user.kt_groups %}
            <div class="mt-3">
              <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#ktGroupsCollapse" aria-expanded="false" aria-controls="ktGroupsCollapse">
                <i class="bi bi-chevron-down accordion-arrow"></i> View KT Groups ({{ user.kt_groups|length }})
              </button>
              <div class="hidden mt-3" id="ktGroupsCollapse">
                <div class="card p-3">
                  <!-- Search/Filter Box -->
                  <div class="mb-3 flex gap-2">
                    <input type="text" class="form-control" id="ktGroupsSearch" placeholder="Search groups...">
                    <button class="btn btn-sm btn-outline-secondary hidden" type="button" id="clearKtGroupsSearch">
                      <i class="bi bi-x-circle"></i>
                    </button>
                  </div>
                  <div class="max-h-72 overflow-y-auto">
                    <ul class="divide-y divide-gray-100 dark:divide-gray-700" id="ktGroupsList">
                      {% if legacy_groups %}
                        {% for group in legacy_groups %}
                          <li class="py-2 px-1 flex justify-between items-center kt-group-item" data-group-name="{{ group.group_name|lower }}">
                            <span class="truncate flex-1 text-sm">{{ group.group_name }}</span>
                            <div class="flex gap-1 ml-2 shrink-0">
                              <a href="{% url 'dashboard:legacy_dashboard' %}?grp={{ group.group_login }}" class="btn btn-sm btn-primary" title="View Legacy Dashboard">
                                <i class="bi bi-arrow-right-circle"></i> Dashboard
                              </a>
                              {% if group.course_ids %}
                                <button type="button"
                                        class="btn btn-sm btn-outline-primary"
                                        data-group-login="{{ group.group_login }}"
                                        data-group-name="{{ group.group_name }}"
                                        onclick="openCourseResourcesModal('{{ group.group_login }}', '{{ group.group_name|escapejs }}')"
                                        title="View all course resources">
                                  <i class="bi bi-folder"></i>
                                </button>
                              {% endif %}
                            </div>
                          </li>
                        {% endfor %}
                      {% else %}
                        {% for group in user.kt_groups %}
                          <li class="py-2 px-1 flex justify-between items-center kt-group-item" data-group-name="{{ group|lower }}">
                            <span class="truncate flex-1 text-sm">{{ group }}</span>
                            <a href="{% url 'dashboard:legacy_dashboard' %}?grp={{ group }}" class="btn btn-sm btn-primary ml-2" title="View Legacy Dashboard">
                              <i class="bi bi-arrow-right-circle"></i> View
                            </a>
                          </li>
                        {% endfor %}
                      {% endif %}
                    </ul>
                    <div id="ktGroupsEmpty" class="hidden text-center py-4 text-gray-400 text-sm">
                      <i class="bi bi-search mr-1"></i>No groups match your search.
                    </div>
                  </div>
                </div>
              </div>
            </div>
          {% endif %}
        {% endif %}
        {% if user.lti_data %}
          <hr class="border-gray-200 dark:border-gray-700 my-3">
          <h6 class="text-sm font-semibold text-gray-500 dark:text-gray-400">LTI Information</h6>
          <p class="text-sm text-gray-500 dark:text-gray-400"><strong>LTI Data:</strong> {{ user.lti_data }}</p>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Profile Edit Form -->
  <div class="card overflow-hidden mb-6">
    <div class="bg-gray-600 dark:bg-gray-700 text-white px-6 py-3">
      <h5 class="font-semibold flex items-center gap-2 m-0">
        <i class="bi bi-pencil-square"></i> Edit Profile Information
      </h5>
    </div>
    <div class="p-6">
      <form method="post" novalidate>
        {% csrf_token %}
        <input type="hidden" name="update_profile" value="1">
        {% include 'includes/tailwind_form.html' with form=profile_form %}
        <button type="submit" class="btn btn-primary">
          <i class="bi bi-check-circle"></i> Update Profile
        </button>
      </form>
    </div>
  </div>

  <!-- Password Change Form (only for non-KT users) -->
  {% if not is_kt_user %}
  <div class="card overflow-hidden mb-6">
    <div class="bg-green-600 dark:bg-green-700 text-white px-6 py-3">
      <h5 class="font-semibold flex items-center gap-2 m-0">
        <i class="bi bi-key"></i> Change Password
      </h5>
    </div>
    <div class="p-6">
      <div class="alert alert-info mb-4">
        <i class="bi bi-info-circle mr-1"></i>
        <strong>Password Security</strong><br>
        Your password must meet ModuLearn's security standards. Make sure to use a strong, unique password.
      </div>
      <form method="post" novalidate>
        {% csrf_token %}
        <input type="hidden" name="change_password" value="1">
        {% include 'includes/tailwind_form.html' with form=password_form %}
        <button type="submit" class="btn btn-success">
          <i class="bi bi-arrow-clockwise"></i> Change Password
        </button>
      </form>
    </div>
  </div>
  {% endif %}

  <!-- KnowledgeTree Password Reset (only for KT users) -->
  {% if is_kt_user and kt_password_form %}
  <div class="card overflow-hidden mb-6">
    <div class="bg-cyan-500 dark:bg-cyan-600 text-white px-6 py-3">
      <h5 class="font-semibold flex items-center gap-2 m-0">
        <i class="bi bi-key"></i> Reset Password
      </h5>
    </div>
    <div class="p-6">
      <div class="alert alert-info mb-4">
        <i class="bi bi-info-circle mr-1"></i>
        <strong>KnowledgeTree User</strong><br>
        This will reset your password in <strong>both</strong> ModuLearn and KnowledgeTree to keep them synchronized.
        Your password must meet ModuLearn's security standards before it can be reset.
      </div>
      <form method="post" novalidate>
        {% csrf_token %}
        <input type="hidden" name="reset_kt_password" value="1">
        {% include 'includes/tailwind_form.html' with form=kt_password_form %}
        <button type="submit" class="btn btn-warning">
          <i class="bi bi-arrow-clockwise"></i> Reset Password
        </button>
      </form>
    </div>
  </div>
  {% endif %}

  <div class="mb-4">
    <a href="{% url 'accounts:logout' %}" class="btn btn-danger" onclick="event.preventDefault(); document.getElementById('logout-form-profile').submit();">
      <i class="bi bi-box-arrow-right"></i> Logout
    </a>
    <form id="logout-form-profile" action="{% url 'accounts:logout' %}" method="post" class="hidden">
      {% csrf_token %}
    </form>
  </div>
</div>
{% endblock %}

{% if user.kt_groups %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  const searchInput = document.getElementById('ktGroupsSearch');
  const clearBtn = document.getElementById('clearKtGroupsSearch');
  const emptyMsg = document.getElementById('ktGroupsEmpty');
  const groupsList = document.getElementById('ktGroupsList');
  const collapseElement = document.getElementById('ktGroupsCollapse');

  if (!searchInput) return;

  function filterGroups() {
    const searchTerm = searchInput.value.toLowerCase().trim();
    let visibleCount = 0;

    const container = collapseElement || document;
    const currentGroupItems = container.querySelectorAll('.kt-group-item');

    if (currentGroupItems.length === 0) return;

    currentGroupItems.forEach(item => {
      let groupName = (item.getAttribute('data-group-name') || '').toLowerCase();
      if (!groupName) {
        const textSpan = item.querySelector('span.truncate');
        if (textSpan) groupName = textSpan.textContent.trim().toLowerCase();
      }

      const matches = !searchTerm || groupName.includes(searchTerm);
      if (matches) {
        item.style.display = '';
        item.classList.remove('hidden');
        visibleCount++;
      } else {
        item.style.display = 'none';
        item.classList.add('hidden');
      }
    });

    if (visibleCount === 0 && searchTerm) {
      if (emptyMsg) { emptyMsg.style.display = 'block'; emptyMsg.classList.remove('hidden'); }
      if (groupsList) { groupsList.style.display = 'none'; groupsList.classList.add('hidden'); }
    } else {
      if (emptyMsg) { emptyMsg.style.display = 'none'; emptyMsg.classList.add('hidden'); }
      if (groupsList) { groupsList.style.display = ''; groupsList.classList.remove('hidden'); }
    }

    if (clearBtn) {
      if (searchTerm) { clearBtn.style.display = 'inline-flex'; clearBtn.classList.remove('hidden'); }
      else { clearBtn.style.display = 'none'; clearBtn.classList.add('hidden'); }
    }
  }

  searchInput.addEventListener('input', filterGroups);

  if (clearBtn) {
    clearBtn.addEventListener('click', function() {
      searchInput.value = '';
      filterGroups();
      searchInput.focus();
    });
  }

  if (collapseElement) {
    collapseElement.addEventListener('shown.bs.collapse', function() {
      setTimeout(filterGroups, 50);
    });
    if (collapseElement.classList.contains('show')) {
      setTimeout(filterGroups, 100);
    }
  }

  setTimeout(filterGroups, 100);
});
</script>
{% endif %}

{% include 'dashboard/components/course_resources_modal.html' %}

{% block extra_js %}
<script>
// Course Resources Modal Functionality (shared with dashboard)
let courseResourcesCache = {};

function openCourseResourcesModal(groupLogin, groupName) {
    if (typeof bootstrap === 'undefined' || !bootstrap.Modal) {
        alert('Please wait for the page to finish loading.');
        return;
    }

    const modalElement = document.getElementById('courseResourcesModal');
    if (!modalElement) return;

    try {
        const modal = bootstrap.Modal.getOrCreateInstance(modalElement);
        modal.show();
        loadCourseResources(groupLogin, groupName);
    } catch (error) {
        console.error('Error opening modal:', error);
    }
}

async function loadCourseResources(groupLogin, groupName) {
    const groupNameEl = document.getElementById('courseResourcesGroupName');
    if (groupNameEl) groupNameEl.textContent = groupName || groupLogin;

    if (courseResourcesCache[groupLogin]) {
        renderCourseResources(courseResourcesCache[groupLogin]);
        return;
    }

    const resourcesList = document.getElementById('courseResourcesList');
    if (resourcesList) {
        resourcesList.innerHTML = `
            <li class="text-center py-10 px-4">
                <div class="spinner-border text-blue-600" role="status">
                    <span class="sr-only">Loading resources...</span>
                </div>
                <p class="text-gray-400 mt-3 text-sm">Loading resources...</p>
            </li>
        `;
    }

    try {
        const baseUrl = "{% url 'dashboard:get_course_resources_api' group_login='GROUP_LOGIN_PLACEHOLDER' %}";
        const courseResourcesUrl = baseUrl.replace('GROUP_LOGIN_PLACEHOLDER', encodeURIComponent(groupLogin));
        const response = await fetch(courseResourcesUrl);
        const data = await response.json();

        if (data.success && data.resources) {
            courseResourcesCache[groupLogin] = data.resources;
            renderCourseResources(data.resources);
        } else {
            showCourseResourcesError(data.error || 'Failed to load course resources');
        }
    } catch (error) {
        console.error('Error loading course resources:', error);
        showCourseResourcesError('Error loading course resources. Please try again.');
    }
}

function renderCourseResources(resources) {
    const resourcesList = document.getElementById('courseResourcesList');
    if (!resourcesList) return;

    if (resources.length === 0) {
        resourcesList.innerHTML = `
            <li class="text-center py-10 px-4">
                <i class="bi bi-inbox text-3xl text-gray-300"></i>
                <p class="text-gray-400 mt-3 text-sm">No resources available for this course.</p>
            </li>
        `;
        return;
    }

    const html = resources.map(resource => {
        const isMasteryGrids = resource.resource_type === 'masterygrids';
        const iconClass = isMasteryGrids ? 'bi-grid-3x3-gap' :
                         resource.resource_type === 'folder' ? 'bi-folder' : 'bi-file-earmark';
        const badgeColor = isMasteryGrids ? 'badge-primary' :
                          resource.resource_type === 'folder' ? 'badge-secondary' : 'badge-info';

        const resourceUrl = resource.show_url_direct || resource.show_url;
        return `
            <li class="list-group-item list-group-item-action"
                onclick="openCourseResourceInNewTab('${escapeHtml(resourceUrl)}', '${escapeHtml(resource.Title)}')">
                <div class="flex justify-between items-center">
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2">
                            <i class="bi ${iconClass}"></i>
                            <strong class="truncate">${escapeHtml(resource.Title)}</strong>
                            <i class="bi bi-box-arrow-up-right text-gray-400 text-xs"></i>
                        </div>
                        ${resource.Description ? `<small class="text-gray-400 block mt-1 truncate">${escapeHtml(resource.Description)}</small>` : ''}
                    </div>
                    <div class="ml-3 shrink-0">
                        <span class="badge ${badgeColor}">${resource.resource_type}</span>
                    </div>
                </div>
            </li>
        `;
    }).join('');

    resourcesList.innerHTML = html;
}

function openCourseResourceInNewTab(showUrl, title) {
    window.open(showUrl, '_blank', 'noopener,noreferrer');
}

function showCourseResourcesError(message) {
    const resourcesList = document.getElementById('courseResourcesList');
    if (resourcesList) {
        resourcesList.innerHTML = `
            <li class="text-center py-10 px-4">
                <i class="bi bi-exclamation-triangle text-yellow-500 text-3xl"></i>
                <p class="text-red-500 mt-3 text-sm">${escapeHtml(message)}</p>
            </li>
        `;
    }
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>
{% endblock %}
