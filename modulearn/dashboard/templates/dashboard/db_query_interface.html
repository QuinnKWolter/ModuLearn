{% extends 'base.html' %}
{% load static %}

{% block title %}Database Query Interface - ModuLearn{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="card shadow-lg mb-4">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0">
                        <i class="fas fa-database me-2"></i>
                        Database Query Interface
                    </h3>
                    <small class="text-white-50">Testing tool for exploring MySQL database schemas</small>
                </div>
                <div class="card-body">
                    <!-- Connection Form -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">Database Connection</h5>
                        </div>
                        <div class="card-body">
                            <form id="dbConnectionForm" method="post">
                                {% csrf_token %}
                                <input type="hidden" name="action" value="connect">
                                
                                <!-- SSH Tunnel Section -->
                                <div class="mb-4">
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" id="use_ssh" name="use_ssh">
                                        <label class="form-check-label" for="use_ssh">
                                            <strong>Use SSH Tunnel</strong>
                                        </label>
                                    </div>
                                    
                                    <div id="sshFields" style="display: none;">
                                        <div class="card bg-light">
                                            <div class="card-body">
                                                <h6 class="card-title">SSH Tunnel Configuration</h6>
                                                <div class="row g-3">
                                                    <div class="col-md-4">
                                                        <label for="ssh_host" class="form-label">SSH Host</label>
                                                        <input type="text" class="form-control" id="ssh_host" name="ssh_host" 
                                                               placeholder="ssh.example.com">
                                                    </div>
                                                    <div class="col-md-2">
                                                        <label for="ssh_port" class="form-label">SSH Port</label>
                                                        <input type="number" class="form-control" id="ssh_port" name="ssh_port" 
                                                               value="22">
                                                    </div>
                                                    <div class="col-md-3">
                                                        <label for="ssh_user" class="form-label">SSH Username</label>
                                                        <input type="text" class="form-control" id="ssh_user" name="ssh_user" 
                                                               placeholder="ssh_user">
                                                    </div>
                                                    <div class="col-md-3">
                                                        <label for="ssh_auth_method" class="form-label">Auth Method</label>
                                                        <select class="form-select" id="ssh_auth_method" name="ssh_auth_method">
                                                            <option value="password">Password</option>
                                                            <option value="key">SSH Key File</option>
                                                        </select>
                                                    </div>
                                                    <div class="col-md-6" id="ssh_password_field">
                                                        <label for="ssh_password" class="form-label">SSH Password</label>
                                                        <input type="password" class="form-control" id="ssh_password" name="ssh_password" 
                                                               placeholder="SSH password">
                                                    </div>
                                                    <div class="col-md-6" id="ssh_key_field" style="display: none;">
                                                        <label for="ssh_key_path" class="form-label">SSH Key Path</label>
                                                        <input type="text" class="form-control" id="ssh_key_path" name="ssh_key_path" 
                                                               placeholder="/path/to/private/key">
                                                        <small class="form-text text-muted">Full path to private key file on server</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Database Connection Section -->
                                <h6 class="mb-3">Database Connection</h6>
                                <div class="row g-3">
                                    <div class="col-md-3">
                                        <label for="db_host" class="form-label">Database Host</label>
                                        <input type="text" class="form-control" id="db_host" name="host" 
                                               placeholder="localhost" required>
                                        <small class="form-text text-muted">Host as seen from SSH server (if using tunnel)</small>
                                    </div>
                                    <div class="col-md-2">
                                        <label for="db_port" class="form-label">Database Port</label>
                                        <input type="number" class="form-control" id="db_port" name="port" 
                                               value="3306" required>
                                        <small class="form-text text-muted">Port as seen from SSH server</small>
                                    </div>
                                    <div class="col-md-2">
                                        <label for="db_user" class="form-label">Database User</label>
                                        <input type="text" class="form-control" id="db_user" name="user" required>
                                    </div>
                                    <div class="col-md-2">
                                        <label for="db_password" class="form-label">Database Password</label>
                                        <input type="password" class="form-control" id="db_password" name="password" required>
                                    </div>
                                    <div class="col-md-3">
                                        <label for="db_database" class="form-label">Database Name</label>
                                        <input type="text" class="form-control" id="db_database" name="database" required>
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-plug me-2"></i>Connect
                                    </button>
                                    <button type="button" class="btn btn-secondary" id="disconnectBtn" style="display: none;">
                                        <i class="fas fa-unlink me-2"></i>Disconnect
                                    </button>
                                </div>
                            </form>
                            <div id="connectionStatus" class="mt-3"></div>
                        </div>
                    </div>

                    <!-- Database Info (shown when connected) -->
                    <div id="dbInfoSection" style="display: none;">
                        <!-- Quick Actions -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0">Quick Actions</h5>
                            </div>
                            <div class="card-body">
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-outline-primary" id="showTablesBtn">
                                        <i class="fas fa-list me-2"></i>Show All Tables
                                    </button>
                                    <button type="button" class="btn btn-outline-primary" id="searchCourseBtn">
                                        <i class="fas fa-search me-2"></i>Search for "course"
                                    </button>
                                    <button type="button" class="btn btn-outline-primary" id="searchCidBtn">
                                        <i class="fas fa-search me-2"></i>Search for "cid"
                                    </button>
                                    <button type="button" class="btn btn-outline-primary" id="searchGroupBtn">
                                        <i class="fas fa-search me-2"></i>Search for "group"
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Query Interface -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0">SQL Query</h5>
                            </div>
                            <div class="card-body">
                                <form id="queryForm">
                                    {% csrf_token %}
                                    <input type="hidden" name="action" value="query">
                                    <div class="mb-3">
                                        <label for="sql_query" class="form-label">Enter SQL Query (SELECT only)</label>
                                        <textarea class="form-control font-monospace" id="sql_query" name="query" 
                                                  rows="6" placeholder="SELECT * FROM table_name LIMIT 10;"></textarea>
                                        <small class="form-text text-muted">
                                            Only SELECT queries are allowed for safety.
                                        </small>
                                    </div>
                                    <div class="mb-3">
                                        <label for="max_rows" class="form-label">Max Rows to Return</label>
                                        <input type="number" class="form-control" id="max_rows" name="max_rows" 
                                               value="100" min="1" max="1000">
                                    </div>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-play me-2"></i>Execute Query
                                    </button>
                                    <button type="button" class="btn btn-secondary" id="clearQueryBtn">
                                        <i class="fas fa-eraser me-2"></i>Clear
                                    </button>
                                </form>
                            </div>
                        </div>

                        <!-- Results Area -->
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">Query Results</h5>
                                <span id="resultCount" class="badge bg-secondary"></span>
                            </div>
                            <div class="card-body">
                                <div id="queryResults">
                                    <p class="text-muted">Execute a query to see results here.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .query-result-table {
        font-size: 0.875rem;
    }
    .query-result-table th {
        background-color: #f8f9fa;
        position: sticky;
        top: 0;
        z-index: 10;
    }
    .query-result-table td {
        white-space: nowrap;
        max-width: 300px;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .query-result-table td:hover {
        white-space: normal;
        word-break: break-all;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let isConnected = false;
    
    // Toggle SSH fields visibility
    const useSshCheckbox = document.getElementById('use_ssh');
    const sshFields = document.getElementById('sshFields');
    const sshAuthMethod = document.getElementById('ssh_auth_method');
    const sshPasswordField = document.getElementById('ssh_password_field');
    const sshKeyField = document.getElementById('ssh_key_field');
    
    useSshCheckbox.addEventListener('change', function() {
        if (this.checked) {
            sshFields.style.display = 'block';
            // Make SSH username required when SSH is enabled
            document.getElementById('ssh_user').required = true;
        } else {
            sshFields.style.display = 'none';
            document.getElementById('ssh_user').required = false;
            document.getElementById('ssh_password').required = false;
            document.getElementById('ssh_key_path').required = false;
        }
    });
    
    // Toggle between password and key authentication
    sshAuthMethod.addEventListener('change', function() {
        if (this.value === 'password') {
            sshPasswordField.style.display = 'block';
            sshKeyField.style.display = 'none';
            document.getElementById('ssh_password').required = true;
            document.getElementById('ssh_key_path').required = false;
        } else {
            sshPasswordField.style.display = 'none';
            sshKeyField.style.display = 'block';
            document.getElementById('ssh_password').required = false;
            document.getElementById('ssh_key_path').required = true;
        }
    });
    
    // Connection form
    document.getElementById('dbConnectionForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        
        try {
            const response = await fetch('{% url "dashboard:db_query_interface" %}', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();
            
            const statusDiv = document.getElementById('connectionStatus');
            if (data.success) {
                isConnected = true;
                statusDiv.innerHTML = `<div class="alert alert-success"><i class="fas fa-check-circle me-2"></i>${data.message}</div>`;
                document.getElementById('dbInfoSection').style.display = 'block';
                document.getElementById('disconnectBtn').style.display = 'inline-block';
                
                // Disable connection form
                document.querySelectorAll('#dbConnectionForm input').forEach(input => {
                    input.disabled = true;
                });
            } else {
                statusDiv.innerHTML = `<div class="alert alert-danger"><i class="fas fa-exclamation-circle me-2"></i>${data.message}</div>`;
            }
        } catch (error) {
            document.getElementById('connectionStatus').innerHTML = 
                `<div class="alert alert-danger">Error: ${error.message}</div>`;
        }
    });
    
    // Disconnect button
    document.getElementById('disconnectBtn').addEventListener('click', function() {
        fetch('{% url "dashboard:db_query_interface" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: 'action=disconnect'
        }).then(() => {
            isConnected = false;
            document.getElementById('connectionStatus').innerHTML = 
                '<div class="alert alert-info">Disconnected</div>';
            document.getElementById('dbInfoSection').style.display = 'none';
            document.getElementById('disconnectBtn').style.display = 'none';
            document.querySelectorAll('#dbConnectionForm input').forEach(input => {
                input.disabled = false;
            });
        });
    });
    
    // Query form
    document.getElementById('queryForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        if (!isConnected) {
            alert('Please connect to database first');
            return;
        }
        
        const formData = new FormData(this);
        const resultsDiv = document.getElementById('queryResults');
        resultsDiv.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"></div></div>';
        
        try {
            const response = await fetch('{% url "dashboard:db_query_interface" %}', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();
            
            if (data.success) {
                displayQueryResults(data.results, data.message, data.row_count);
            } else {
                resultsDiv.innerHTML = `<div class="alert alert-danger">${data.message}</div>`;
            }
        } catch (error) {
            resultsDiv.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
        }
    });
    
    // Quick action buttons
    document.getElementById('showTablesBtn').addEventListener('click', function() {
        executeQuickQuery('SHOW TABLES', 'Tables');
    });
    
    document.getElementById('searchCourseBtn').addEventListener('click', function() {
        executeQuickQuery('search', 'course');
    });
    
    document.getElementById('searchCidBtn').addEventListener('click', function() {
        executeQuickQuery('search', 'cid');
    });
    
    document.getElementById('searchGroupBtn').addEventListener('click', function() {
        executeQuickQuery('search', 'group');
    });
    
    function executeQuickQuery(type, param) {
        if (!isConnected) {
            alert('Please connect to database first');
            return;
        }
        
        const formData = new FormData();
        formData.append('action', type);
        formData.append('param', param);
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        
        const resultsDiv = document.getElementById('queryResults');
        resultsDiv.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"></div></div>';
        
        fetch('{% url "dashboard:db_query_interface" %}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                if (type === 'search') {
                    displaySearchResults(data.results, data.message);
                } else {
                    displayQueryResults(data.results, data.message, data.row_count);
                }
            } else {
                resultsDiv.innerHTML = `<div class="alert alert-danger">${data.message}</div>`;
            }
        })
        .catch(error => {
            resultsDiv.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
        });
    }
    
    function displayQueryResults(results, message, rowCount) {
        const resultsDiv = document.getElementById('queryResults');
        document.getElementById('resultCount').textContent = rowCount !== null ? `${rowCount} rows` : '';
        
        if (!results || results.length === 0) {
            resultsDiv.innerHTML = `<div class="alert alert-info">${message}</div>`;
            return;
        }
        
        // Get column names
        const columns = Object.keys(results[0]);
        
        // Build table
        let html = `<div class="alert alert-success">${message}</div>`;
        html += '<div class="table-responsive" style="max-height: 600px; overflow-y: auto;">';
        html += '<table class="table table-striped table-bordered table-hover query-result-table">';
        html += '<thead class="table-light"><tr>';
        columns.forEach(col => {
            html += `<th>${escapeHtml(col)}</th>`;
        });
        html += '</tr></thead><tbody>';
        
        results.forEach(row => {
            html += '<tr>';
            columns.forEach(col => {
                const value = row[col];
                const displayValue = value === null || value === undefined ? '<em>NULL</em>' : escapeHtml(String(value));
                html += `<td title="${escapeHtml(String(value))}">${displayValue}</td>`;
            });
            html += '</tr>';
        });
        
        html += '</tbody></table></div>';
        resultsDiv.innerHTML = html;
    }
    
    function displaySearchResults(results, message) {
        const resultsDiv = document.getElementById('queryResults');
        document.getElementById('resultCount').textContent = results ? `${results.length} matches` : '';
        
        if (!results || results.length === 0) {
            resultsDiv.innerHTML = `<div class="alert alert-info">${message}</div>`;
            return;
        }
        
        let html = `<div class="alert alert-success">${message}</div>`;
        html += '<div class="table-responsive" style="max-height: 600px; overflow-y: auto;">';
        html += '<table class="table table-striped table-bordered table-hover query-result-table">';
        html += '<thead class="table-light"><tr>';
        html += '<th>Table Name</th><th>Column Name</th><th>Data Type</th><th>Column Type</th><th>Nullable</th><th>Key</th><th>Default</th>';
        html += '</tr></thead><tbody>';
        
        results.forEach(row => {
            html += '<tr>';
            html += `<td><strong>${escapeHtml(row.TABLE_NAME)}</strong></td>`;
            html += `<td>${escapeHtml(row.COLUMN_NAME)}</td>`;
            html += `<td>${escapeHtml(row.DATA_TYPE)}</td>`;
            html += `<td><code>${escapeHtml(row.COLUMN_TYPE)}</code></td>`;
            html += `<td>${escapeHtml(row.IS_NULLABLE)}</td>`;
            html += `<td>${escapeHtml(row.COLUMN_KEY || '')}</td>`;
            html += `<td>${escapeHtml(String(row.COLUMN_DEFAULT || ''))}</td>`;
            html += '</tr>';
        });
        
        html += '</tbody></table></div>';
        resultsDiv.innerHTML = html;
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // Clear query button
    document.getElementById('clearQueryBtn').addEventListener('click', function() {
        document.getElementById('sql_query').value = '';
        document.getElementById('queryResults').innerHTML = '<p class="text-muted">Execute a query to see results here.</p>';
        document.getElementById('resultCount').textContent = '';
    });
});
</script>
{% endblock %}

