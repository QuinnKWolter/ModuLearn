<script>
document.addEventListener('DOMContentLoaded', function() {
    // Check if fetchDataBtn exists before adding listener
    const fetchDataBtn = document.getElementById('fetchDataBtn');
    if (fetchDataBtn) {
        fetchDataBtn.addEventListener('click', handleFetch);
    }
    
    // View mode change listeners
    document.querySelectorAll('input[name="viewMode"]').forEach(radio => {
        radio.addEventListener('change', function() {
            currentViewMode = this.value;
            updateGrid();
            
            // Update all radio buttons to reflect the current selection
            document.querySelectorAll('input[name="viewMode"]').forEach(r => {
                r.checked = (r.value === currentViewMode);
            });
        });
    });
    
    // Initialize button states on page load (only if elements exist)
    const viewModeRadios = document.querySelectorAll('input[name="viewMode"]');
    if (viewModeRadios.length > 0) {
        updateButtonStates();
    }

    // Simple validation for required fields (Group ID and Course ID)
    const grpInput = document.getElementById('grp');
    const cidInput = document.getElementById('cid');
    const fetchBtn = document.getElementById('fetchDataBtn');

    // Make updateFetchButtonState globally accessible
    window.updateFetchButtonState = function() {
        const hasGrp = (grpInput?.value || '').trim().length > 0;
        const hasCid = (cidInput?.value || '').trim().length > 0;
        if (fetchBtn) {
            fetchBtn.disabled = !(hasGrp && hasCid);
        }
    };

    // Only add listeners if elements exist
    if (grpInput) {
        grpInput.addEventListener('input', window.updateFetchButtonState);
    }
    if (cidInput) {
        cidInput.addEventListener('input', window.updateFetchButtonState);
    }
    if (grpInput || cidInput || fetchBtn) {
        window.updateFetchButtonState();
    }
    
    // Auto-fetch user's KnowledgeTree groups and Course IDs
    autoLoadUserGroups().catch(err => console.error('Error loading user groups:', err));
});

/**
 * Automatically load user's KnowledgeTree groups and Course IDs.
 * Uses groups data provided by backend (from direct database query).
 * If successful, show dropdown for group selection.
 * If preselected_group is provided (from URL parameter), auto-populate and fetch.
 */
async function autoLoadUserGroups() {
    const grpInput = document.getElementById('grp');
    const cidInput = document.getElementById('cid');
    const fetchBtn = document.getElementById('fetchDataBtn');
    
    // If required elements don't exist, exit early
    if (!grpInput || !cidInput) {
        return;
    }
    
    // Get groups from backend-provided data (already fetched via direct DB query)
    const groups = window.autoGroups || [];
    const preselectedGroup = window.preselectedGroup || '';
    
    if (groups && groups.length > 0) {
        // Show group dropdown selector (no auto-select - let user choose)
        showGroupDropdown(groups, grpInput, cidInput);
        
        // If a group is preselected from URL parameter, wait for dropdown to be created, then select it
        if (preselectedGroup) {
            // Wait a moment for dropdown to be fully created, then select the group
            setTimeout(() => {
                const selectedGroup = groups.find(g => g.group_login === preselectedGroup);
                if (selectedGroup) {
                    // Find the dropdown and select the group
                    const groupSelect = document.getElementById('ktGroupSelect');
                    if (groupSelect) {
                        // Find the option index for this group
                        const groupIndex = groups.findIndex(g => g.group_login === preselectedGroup);
                        if (groupIndex !== -1) {
                            groupSelect.value = groupIndex.toString();
                            // Trigger the change event to populate Course IDs
                            const changeEvent = new Event('change', { bubbles: true });
                            groupSelect.dispatchEvent(changeEvent);
                            
                            // If there's only one course ID, auto-trigger fetch after Course ID is populated
                            if (selectedGroup.course_ids && selectedGroup.course_ids.length === 1) {
                                setTimeout(() => {
                                    if (fetchBtn && !fetchBtn.disabled) {
                                        handleFetch();
                                    }
                                }, 1200); // Wait for Course ID to be populated
                            }
                        }
                    } else {
                        // Fallback: set input directly if dropdown not found
                        grpInput.value = preselectedGroup;
                        window.updateFetchButtonState();
                    }
                } else {
                    // Group not found in auto-groups, but set it anyway and let user discover course IDs
                    grpInput.value = preselectedGroup;
                    window.updateFetchButtonState();
                }
            }, 200); // Small delay to ensure dropdown is created
        }
    } else if (preselectedGroup) {
        // No auto-groups but preselected group provided - set it manually
        grpInput.value = preselectedGroup;
        window.updateFetchButtonState();
    }
    // If no groups, silently fail - manual input is still available
}

/**
 * Show a dropdown selector for KnowledgeTree groups.
 * This replaces the manual Group ID input when groups are available.
 */
function showGroupDropdown(groups, grpInput, cidInput) {
    // Guard: check if required elements exist
    if (!grpInput || !cidInput) {
        console.warn('showGroupDropdown: Required input elements not found');
        return;
    }
    
    const headerCard = document.querySelector('.text-white');
    if (!headerCard) {
        console.warn('showGroupDropdown: Header card not found');
        return;
    }
    
    // Find the Group ID input's parent div
    const grpCol = grpInput.closest('div');
    if (!grpCol) {
        console.warn('showGroupDropdown: Group input parent column not found');
        return;
    }
    
    // Store the original input (we'll hide it)
    const originalInput = grpInput;
    
    // Create dropdown container
    const dropdownContainer = document.createElement('div');
    dropdownContainer.className = 'kt-group-dropdown';
    dropdownContainer.innerHTML = `
        <label for="ktGroupSelect" class="block font-semibold text-white text-sm mb-1">
            Group ID
            <small class="text-white/50 block text-xs font-normal">
                (Select from your courses)
            </small>
        </label>
        <select class="form-select form-select-lg" id="ktGroupSelect">
            <option value="">-- Select a course/group --</option>
            ${groups.map((group, index) => 
                `<option value="${index}" 
                    data-group-login="${group.group_login}" 
                    data-group-name="${group.group_name}">
                    ${group.group_name}
                </option>`
            ).join('')}
        </select>
        <small class="text-white/50 block mt-1">
            <a href="#" id="useManualGroup" class="text-white/50" style="text-decoration: underline;">
                Or enter manually
            </a>
        </small>
    `;
    
    // Replace the Group ID input with dropdown
    const grpLabel = grpCol.querySelector('label[for="grp"]');
    if (grpLabel) {
        grpLabel.style.display = 'none';
    }
    originalInput.style.display = 'none';
    grpCol.insertBefore(dropdownContainer, originalInput);
    
    // Store groups data globally for access
    window.ktGroupsData = groups;
    
    // Add change listener for group selection
    const groupSelect = dropdownContainer.querySelector('#ktGroupSelect');
    if (!groupSelect) {
        console.warn('showGroupDropdown: Group select element not found');
        return;
    }
    
    groupSelect.addEventListener('change', async function() {
        const selectedIndex = this.value;
        if (selectedIndex !== '') {
            const selectedGroup = groups[parseInt(selectedIndex)];
            await selectGroup(selectedGroup, originalInput, cidInput);
        } else {
            // Clear fields if "Select" option chosen
            originalInput.value = '';
            cidInput.value = '';
            
            // Remove any Course ID dropdown or messages
            const courseDropdown = document.querySelector('.kt-course-dropdown');
            if (courseDropdown) courseDropdown.remove();
            const courseLoading = document.querySelector('.kt-course-loading');
            if (courseLoading) courseLoading.remove();
            const courseError = document.querySelector('.kt-course-error');
            if (courseError) courseError.remove();
            const noCourseMsg = document.querySelector('.kt-no-course-ids');
            if (noCourseMsg) noCourseMsg.remove();
            
            if (window.updateFetchButtonState) {
                window.updateFetchButtonState();
            }
        }
    });
    
    // Add manual entry toggle
    const manualLink = dropdownContainer.querySelector('#useManualGroup');
    if (manualLink) {
        manualLink.addEventListener('click', function(e) {
            e.preventDefault();
            // Hide dropdown, show manual input
            dropdownContainer.style.display = 'none';
            originalInput.style.display = 'block';
            if (grpLabel) grpLabel.style.display = 'block';
            originalInput.focus();
        });
    }
}

/**
 * Handle group selection - populate Group ID field and discover Course IDs on-demand.
 */
async function selectGroup(group, grpInput, cidInput) {
    // Guard: check if required elements exist
    if (!group || !grpInput || !cidInput) {
        console.warn('selectGroup: Required parameters missing');
        return;
    }
    
    // Populate Group ID
    grpInput.value = group.group_login;
    
    // Clear Course ID field initially
    cidInput.value = '';
    
    // Show loading indicator for Course ID discovery
    const cidCol = cidInput.closest('div');
    if (!cidCol) {
        console.warn('selectGroup: Course ID input parent column not found');
        return;
    }
    
    const loadingDiv = document.createElement('div');
    loadingDiv.className = 'kt-course-loading mt-2';
    loadingDiv.innerHTML = '<small class="text-white/50"><i class="fas fa-spinner fa-spin mr-1"></i>Discovering Course IDs...</small>';
    cidCol.appendChild(loadingDiv);
    
    // Discover Course IDs on-demand for this specific group
    try {
        const response = await fetch(`{% url "dashboard:discover_course_ids" %}?grp=${encodeURIComponent(group.group_login)}`);
        const data = await response.json();
        
        // Remove loading indicator
        loadingDiv.remove();
        
        if (data.success && data.course_ids && data.course_ids.length > 0) {
            if (data.course_ids.length === 1) {
                // Single Course ID - auto-populate
                cidInput.value = data.course_ids[0];
                    } else {
                // Multiple Course IDs - show dropdown
                showCourseIdDropdown(data.course_ids, cidInput);
            }
        } else {
            // No Course IDs discovered - leave empty for manual entry
            // Show helpful message
            const noCourseMsg = document.createElement('div');
            noCourseMsg.className = 'kt-no-course-ids mt-2';
            noCourseMsg.innerHTML = '<small class="text-white/50"><i class="fas fa-info-circle mr-1"></i>No Course IDs found. Please enter manually.</small>';
            cidCol.appendChild(noCourseMsg);
        }
    } catch (error) {
        // Remove loading indicator
        loadingDiv.remove();
        
        // Show error message
        const errorMsg = document.createElement('div');
        errorMsg.className = 'kt-course-error mt-2';
        errorMsg.innerHTML = '<small class="text-yellow-500"><i class="fas fa-exclamation-triangle mr-1"></i>Could not discover Course IDs. Please enter manually.</small>';
        cidCol.appendChild(errorMsg);
        
        console.error('Error discovering Course IDs:', error);
    }
    
    // Update button state
    if (window.updateFetchButtonState) {
        window.updateFetchButtonState();
    }
}

/**
 * Show a dropdown for Course ID selection when multiple Course IDs are available.
 */
function showCourseIdDropdown(courseIds, cidInput) {
    // Guard: check if required parameters exist
    if (!courseIds || !cidInput) {
        console.warn('showCourseIdDropdown: Required parameters missing');
        return;
    }
    
    // Remove existing Course ID dropdown if any
    const existingDropdown = document.querySelector('.kt-course-dropdown');
    if (existingDropdown) {
        existingDropdown.remove();
    }
    
    // Find the Course ID input's parent div
    const cidCol = cidInput.closest('div');
    if (!cidCol) {
        console.warn('showCourseIdDropdown: Course ID input parent column not found');
        return;
    }
    
    const originalInput = cidInput;
    
    // Create dropdown
    const dropdownContainer = document.createElement('div');
    dropdownContainer.className = 'kt-course-dropdown';
    dropdownContainer.innerHTML = `
        <label for="ktCourseSelect" class="block font-semibold text-white text-sm mb-1">
            Course ID
            <small class="text-white/50 block text-xs font-normal">
                (Select course)
            </small>
        </label>
        <select class="form-select form-select-lg" id="ktCourseSelect">
            <option value="">-- Select course --</option>
            ${courseIds.map(cid => 
                `<option value="${cid}">Course ${cid}</option>`
            ).join('')}
        </select>
        <small class="text-white/50 block mt-1">
            <a href="#" id="useManualCourse" class="text-white/50" style="text-decoration: underline;">
                Or enter manually
            </a>
        </small>
    `;
    
    // Replace the Course ID input with dropdown
    const cidLabel = cidCol.querySelector('label[for="cid"]');
    if (cidLabel) {
        cidLabel.style.display = 'none';
    }
    originalInput.style.display = 'none';
    cidCol.insertBefore(dropdownContainer, originalInput);
    
    // Add change listener
    const courseSelect = dropdownContainer.querySelector('#ktCourseSelect');
    if (courseSelect) {
        courseSelect.addEventListener('change', function() {
            originalInput.value = this.value;
            if (window.updateFetchButtonState) {
                window.updateFetchButtonState();
            }
        });
        
        // Auto-select first Course ID
        if (courseIds.length > 0) {
            courseSelect.value = courseIds[0];
            originalInput.value = courseIds[0];
            if (window.updateFetchButtonState) {
                window.updateFetchButtonState();
            }
        }
    }
    
    // Add manual entry toggle
    const manualLink = dropdownContainer.querySelector('#useManualCourse');
    if (manualLink) {
        manualLink.addEventListener('click', function(e) {
            e.preventDefault();
            // Hide dropdown, show manual input
            dropdownContainer.style.display = 'none';
            originalInput.style.display = 'block';
            if (cidLabel) cidLabel.style.display = 'block';
            originalInput.focus();
        });
    }
}

let responseData = null;
let currentViewMode = 'classAverage';

function updateButtonStates() {
    // Update all radio buttons to reflect the current selection
    document.querySelectorAll('input[name="viewMode"]').forEach(r => {
        r.checked = (r.value === currentViewMode);
    });
}

function handleFetch() {
    const btn = document.getElementById('fetchDataBtn');
    const btnText = document.getElementById('fetchBtnText');
    const spinner = document.getElementById('fetchSpinner');
    const progressContainer = document.getElementById('fetchProgressContainer');
    const progressBar = document.getElementById('fetchProgressBar');
    const progressText = document.getElementById('fetchProgressText');
    const progressPercent = document.getElementById('fetchProgressPercent');
    const grpVal = (document.getElementById('grp')?.value || '').trim();
    const cidVal = (document.getElementById('cid')?.value || '').trim();
    if (!grpVal || !cidVal) {
        return; // Guard: do nothing if required fields are empty
    }
    
    // Guard: exit if required elements don't exist
    if (!btn || !progressContainer || !progressBar || !progressText || !progressPercent) {
        console.warn('Dashboard fetch elements not found');
        return;
    }
    
    if (btn) btn.disabled = true;
    if (btnText) btnText.textContent = 'Loading...';
    if (spinner) spinner.classList.remove('hidden');
    if (progressContainer) progressContainer.classList.remove('hidden');
    progressBar.style.width = '0%';
    progressPercent.textContent = '0%';
    
    // Use batch endpoint to fetch all students at once
    progressText.textContent = 'Connecting to database...';
    progressBar.style.width = '10%';
    progressPercent.textContent = '10%';
    
    const batchAnalyticsParams = {
        grp: document.getElementById('grp').value,
        cid: document.getElementById('cid').value
    };
    
    const batchAnalyticsUrl = `{% url 'dashboard:fetch_all_students_analytics' %}?${new URLSearchParams(batchAnalyticsParams)}`;
    
    // Clear any previous error states
    clearFormErrors();
    
    fetch(batchAnalyticsUrl)
        .then(async response => {
            const data = await response.json();
            
            if (!response.ok) {
                // Extract error message from response
                const errorMessage = data.error || `Batch Analytics API Error: ${response.statusText}`;
                const statusCode = response.status;
                
                // Show form field errors based on status code
                if (statusCode === 400) {
                    // Bad Request - likely invalid Group ID or Course ID
                    showFormFieldError('grp', 'Invalid Group ID or Course ID');
                    showFormFieldError('cid', 'Invalid Group ID or Course ID');
                } else if (statusCode === 404) {
                    // Not Found - Group/Course combination doesn't exist
                    showFormFieldError('grp', 'Group/Course combination not found');
                    showFormFieldError('cid', 'Group/Course combination not found');
                } else {
                    // Other errors
                    showFormFieldError('grp', errorMessage);
                    showFormFieldError('cid', errorMessage);
                }
                
                throw new Error(errorMessage);
            }
            
            if (data.error) {
                showFormFieldError('grp', data.error);
                showFormFieldError('cid', data.error);
                throw new Error(data.error);
            }
            
            // Clear any error states on success
            clearFormErrors();
            
            progressBar.style.width = '50%';
            progressPercent.textContent = '50%';
            progressText.textContent = 'Processing data...';
            
            progressBar.style.width = '90%';
            progressPercent.textContent = '90%';
            progressText.textContent = 'Building dashboard...';
            
            // The batch endpoint returns the complete response structure
            responseData = data;
            
            progressBar.style.width = '100%';
            progressPercent.textContent = '100%';
            progressText.textContent = 'Complete!';
                
                // Hide progress bar and show dashboard
            setTimeout(() => {
                progressContainer.classList.add('hidden');
                const dashboardContent = document.getElementById('dashboardContent');
                dashboardContent.classList.remove('hidden');
                dashboardContent.classList.add('fade-in');
                renderDashboard();
            }, 300);
        })
        .catch(error => {
            console.error('Fetch error:', error);
            showError(`Failed to load data: ${error.message}`);
            progressContainer.classList.add('hidden');
        })
        .finally(() => {
            btn.disabled = false;
            btnText.textContent = 'Launch Analytics';
            spinner.classList.add('hidden');
        });
}

function mapLearnerIds(analyticsData, classListData) {
    // Step 1: Sort analytics learners by their integer ID (lowest to highest)
    const sortedAnalyticsLearners = analyticsData.learners.sort((a, b) => {
        const aId = parseInt(a.id);
        const bId = parseInt(b.id);
        return aId - bId;
    });
    
    // Step 2: Create mapping from sorted position to real learner ID
    const learnerIdMap = classListData.learners.map(learner => learner.learnerId);
    
    // Step 3: Update the sorted learners with real IDs
    sortedAnalyticsLearners.forEach((learner, index) => {
        if (index < learnerIdMap.length) {
            learner.id = learnerIdMap[index];
        }
    });
    
    // Step 4: Replace the original learners array with the sorted and mapped one
    analyticsData.learners = sortedAnalyticsLearners;
    
    return analyticsData;
}

function renderDashboard() {
    if (!responseData) return;
    
    populateKPIs();
    updateGrid();
}

function populateKPIs() {
    const classAvgData = responseData.groups.find(g => g.name === 'Class Average');
    if (!classAvgData) return;

    // Course Title
    document.getElementById('courseTitle').textContent = responseData.context.group.name;

    // Overall Progress - Calculate true class completion percentage
    let totalPossibleProgress = 0;
    let totalActualProgress = 0;
    
    responseData.topics.forEach(topic => {
        const topicData = classAvgData.state.topics[topic.id];
        if (topicData) {
            // Count all resources for this topic
            const resourceCount = Object.keys(topicData.values || {}).length;
            totalPossibleProgress += resourceCount;
            
            // Sum actual progress across all resources
            Object.values(topicData.values || {}).forEach(resource => {
                totalActualProgress += resource.p || 0;
            });
        }
    });
    
    const overallProgressPercent = totalPossibleProgress > 0 ? 
        Math.round((totalActualProgress / totalPossibleProgress) * 100) : 0;
    document.getElementById('overallProgress').textContent = `${overallProgressPercent}%`;

    // Students Enrolled
    document.getElementById('studentsEnrolled').textContent = responseData.learners.length;

    // Engagement Score - Percent of resources with any class activity (> 0 progress)
    let totalResources = 0;
    let engagedResources = 0;
    
    responseData.topics.forEach(topic => {
        const topicData = classAvgData.state.topics?.[topic.id];
        if (topicData?.values) {
            Object.values(topicData.values).forEach(resource => {
                totalResources++;
                if ((resource?.p || 0) > 0) engagedResources++;
            });
        }
    });
    
    const engagementScore = totalResources > 0 ? Math.round((engagedResources / totalResources) * 100) : 0;
    document.getElementById('engagementScore').textContent = `${engagementScore}%`;

    // Most Active Topic
    let mostActiveTopic = null;
    let highestProgress = 0;
    responseData.topics.forEach(topic => {
        const progress = classAvgData.state.topics[topic.id]?.values['Coding Problems']?.p || 0;
        if (progress > highestProgress) {
            highestProgress = progress;
            mostActiveTopic = topic;
        }
    });
    
    // Students Needing Intervention - Check ALL resources
    let studentsNeedingHelp = 0;
    responseData.learners.forEach(learner => {
        const learnerProgress = learner.state.topics;
        let strugglingResources = 0;
        let totalResources = 0;
        
        responseData.topics.forEach(topic => {
            const learnerTopicData = learnerProgress[topic.id];
            const classTopicData = classAvgData.state.topics[topic.id];
            
            if (learnerTopicData?.values && classTopicData?.values) {
                // Check each resource in this topic
                Object.keys(classTopicData.values).forEach(resourceId => {
                    const learnerResourceProgress = learnerTopicData.values[resourceId]?.p || 0;
                    const classResourceProgress = classTopicData.values[resourceId]?.p || 0;
                    
                    if (classResourceProgress > 0) { // Only consider resources with class activity
                        totalResources++;
                        if (learnerResourceProgress < (classResourceProgress * 0.5)) { // Struggling if < 50% of class average
                            strugglingResources++;
                        }
                    }
                });
            }
        });
        
        // Student needs intervention if struggling in > 30% of active resources
        if (totalResources > 0 && (strugglingResources / totalResources) > 0.3) {
            studentsNeedingHelp++;
        }
    });
    
    document.getElementById('studentsNeedingHelp').textContent = studentsNeedingHelp;
    
}

function updateGrid() {
    if (!responseData) return;
    
    // Update button states
    updateButtonStates();
    
    // Update title and description based on current view
    updateViewHeader();
    
    // Get the content containers
    const masteryGrid = document.getElementById('masteryGrid').closest('.overflow-x-auto');
    const perStudentContent = document.getElementById('perStudentContent');
    
    if (currentViewMode === 'perStudent') {
        // Hide mastery grid and show per student content
        masteryGrid.style.display = 'none';
        perStudentContent.style.display = 'block';
        updatePerStudentView();
    } else {
        // Show mastery grid and hide per student content
        masteryGrid.style.display = 'block';
        perStudentContent.style.display = 'none';
        updateMasteryGrid();
    }
}

function updateViewHeader() {
    const titleElement = document.getElementById('viewTitle');
    const descriptionElement = document.getElementById('viewDescription');
    const classAvgHelp = document.getElementById('classAverageHelpBtn');
    const perStudentHelp = document.getElementById('perStudentHelpBtn');
    
    if (!titleElement || !descriptionElement) return;
    
    switch (currentViewMode) {
        case 'myProgress':
            titleElement.textContent = 'My Progress';
            descriptionElement.textContent = 'Your individual progress across all topics';
            if (classAvgHelp) classAvgHelp.classList.add('hidden');
            if (perStudentHelp) perStudentHelp.classList.add('hidden');
            break;
        case 'comparative':
            titleElement.textContent = 'Comparative View';
            descriptionElement.textContent = 'Your progress compared to class average';
            if (classAvgHelp) classAvgHelp.classList.add('hidden');
            if (perStudentHelp) perStudentHelp.classList.add('hidden');
            break;
        case 'classAverage':
            titleElement.textContent = 'Class Average';
            descriptionElement.textContent = 'Average class progress across all topics';
            if (classAvgHelp) classAvgHelp.classList.remove('hidden');
            if (perStudentHelp) perStudentHelp.classList.add('hidden');
            break;
        case 'perStudent':
            titleElement.textContent = 'Student Progress Overview';
            descriptionElement.textContent = 'Individual student progress tracking';
            if (classAvgHelp) classAvgHelp.classList.add('hidden');
            if (perStudentHelp) perStudentHelp.classList.remove('hidden');
            break;
    }
}

function updateMasteryGrid() {
    // Update grid headers
    const gridHeaders = document.getElementById('gridHeaders');
    while (gridHeaders.children.length > 1) {
        gridHeaders.removeChild(gridHeaders.lastChild);
    }
    
    // Add resource headers
    responseData.resources.forEach(resource => {
        const th = document.createElement('th');
        th.className = 'border-0 font-bold text-center py-3';
        th.style.minWidth = '120px';
        th.innerHTML = `
            <div class="flex flex-col items-center">
                <i class="fas fa-tasks text-blue-600 mb-1"></i>
                <span class="text-sm break-words">${resource.name}</span>
            </div>
        `;
        gridHeaders.appendChild(th);
    });
    
    // Update grid body
    const gridBody = document.getElementById('gridBody');
    gridBody.innerHTML = '';
    
    // Get current data based on view mode
    let currentData;
    if (currentViewMode === 'myProgress') {
        currentData = responseData.learners.find(learner => learner.id === responseData.context.learnerId);
    } else if (currentViewMode === 'comparative') {
        // For comparative view, we'll calculate the difference between my progress and class average
        currentData = calculateComparativeData();
    } else {
        currentData = responseData.groups.find(group => group.name === 'Class Average');
    }
    
    if (!currentData) return;
    
    // Sort topics by order
    const sortedTopics = responseData.topics.sort((a, b) => a.order - b.order);
    
    // Create grid rows
    sortedTopics.forEach((topic, index) => {
        const row = document.createElement('tr');
        
        // Topic cell with gradient styling
        const topicProgress = getTopicProgress(currentData, topic.id);
        const progressPercent = Math.round(topicProgress * 100);
        const progressColor = getTextColor(topicProgress);
        const progressBarStyle = getProgressBarStyle(progressPercent);
        
        const topicCell = document.createElement('td');
        topicCell.className = 'border-0 py-2';
        topicCell.innerHTML = `
            <div class="flex items-center">
                <div class="bg-blue-600 rounded-full flex items-center justify-center mr-3" style="width: 32px; height: 32px;">
                    <span class="text-white font-bold text-sm">${topic.order}</span>
                </div>
                <div class="flex-1">
                    <div class="font-bold mb-1">${topic.name}</div>
                    <div class="progress" style="height: 6px; background-color: rgba(0,0,0,0.1);">
                        <div class="progress-bar" role="progressbar" style="width: ${progressPercent}%; ${Object.entries(progressBarStyle).map(([key, value]) => `${key.replace(/([A-Z])/g, '-$1').toLowerCase()}: ${value}`).join('; ')}"></div>
                    </div>
                </div>
                <div class="ml-3">
                    <span class="badge font-bold" style="${Object.entries(getBadgeStyle(progressPercent)).map(([key, value]) => `${key.replace(/([A-Z])/g, '-$1').toLowerCase()}: ${value}`).join('; ')}; min-width: 50px; text-align: center;">${progressPercent}%</span>
                </div>
            </div>
        `;
        row.appendChild(topicCell);
        
        // Resource cells with text gradient styling
        responseData.resources.forEach(resource => {
            const cell = document.createElement('td');
            const value = getCellValue(currentData, topic.id, resource.id);
            const textColor = getTextColor(value);
            
            cell.className = 'text-center border-0 py-2 progress-cell cursor-pointer';
            cell.style.cursor = 'pointer';
            cell.style.borderRadius = '0';
            cell.onclick = () => handleCellClick(topic.id, resource.id, topic.name, resource.name);
            
            // Store original colors for hover effect
            cell.dataset.originalTextColor = textColor;
            cell.dataset.originalBgColor = 'transparent';
            
            // Format the display value based on view mode
            let displayValue;
            if (currentViewMode === 'comparative') {
                const percentage = Math.round(value * 100);
                displayValue = percentage > 0 ? `+${percentage}%` : `${percentage}%`;
            } else {
                displayValue = `${Math.round(value * 100)}%`;
            }
            
            cell.innerHTML = `
                <div class="flex flex-col items-center">
                    <div class="font-bold text-base" style="color: ${textColor};">${displayValue}</div>
                </div>
            `;
            
            // Add hover event listeners for gentle highlight effect
            cell.addEventListener('mouseenter', function() {
                this.style.backgroundColor = 'rgba(0, 0, 0, 0.1)';
                if (textColor !== 'inherit') {
                    this.querySelector('.font-bold').style.color = textColor;
                } else {
                    this.querySelector('.font-bold').style.color = '#6c757d';
                }
            });
            
            cell.addEventListener('mouseleave', function() {
                this.style.backgroundColor = 'transparent';
                this.querySelector('.font-bold').style.color = textColor;
            });
            
            row.appendChild(cell);
        });
        
        gridBody.appendChild(row);
    });
}

function updatePerStudentView() {
    const tableBody = document.getElementById('studentTableBody');
    tableBody.innerHTML = '';
    
    // Show ALL learners (including those with isHidden: true) - no filtering
    const sortedLearners = responseData.learners;
    

    sortedLearners.forEach((learner, index) => {
        // Calculate overall progress
        const topicProgresses = responseData.topics.map(topic => {
            const topicData = learner.state?.topics?.[topic.id];
            const progress = topicData?.overall?.p || 
                           topicData?.values?.['Coding Problems']?.p || 
                           topicData?.p || 
                           0;
            return progress;
        });
        
        const overallProgress = topicProgresses.reduce((acc, val) => acc + val, 0) / (topicProgresses.length || 1);
        const progressPercent = Math.max(0, Math.min(100, Math.round(overallProgress * 100)));
        
        // Calculate topics completed
        const topicsCompleted = topicProgresses.filter(p => p >= 0.9).length;
        const totalTopics = responseData.topics.length;
        
        // Calculate performance (average of all topic progress)
        const performance = Math.round(overallProgress * 100);
        
        const row = document.createElement('tr');
        row.style.cursor = 'pointer';
        row.onclick = () => showStudentDetails(learner.id);
        
        row.innerHTML = `
            <td class="border-0 py-1 text-center">
                <div class="flex items-center justify-center">
                    <div class="bg-cyan-500 rounded-full flex items-center justify-center mr-2" style="width: 24px; height: 24px;">
                        <i class="fas fa-user text-white" style="font-size: 0.7rem;"></i>
                    </div>
                    <div class="font-bold" style="font-size: 0.9rem;">${learner.id}</div>
                </div>
            </td>
            <td class="border-0 py-1 text-center">
                <div class="flex flex-col items-center">
                    <div class="font-bold text-base mb-1">${progressPercent}%</div>
                    <div class="progress" style="width: 80px; height: 4px; border-radius: 2px;">
                        <div class="progress-bar" role="progressbar" style="width: ${progressPercent}%; ${Object.entries(getProgressBarStyle(progressPercent)).map(([key, value]) => `${key.replace(/([A-Z])/g, '-$1').toLowerCase()}: ${value}`).join('; ')}"></div>
                    </div>
                </div>
            </td>
            <td class="border-0 py-1 text-center">
                <div class="flex flex-col items-center">
                    <div class="font-bold text-base mb-1">${topicsCompleted}/${totalTopics}</div>
                    <div class="text-gray-500" style="font-size: 0.7rem;">Topics</div>
                </div>
            </td>
            <td class="border-0 py-1 text-center">
                <div class="flex flex-col items-center">
                    <i class="fas fa-chart-line text-blue-600 mb-1" style="font-size: 1rem;"></i>
                    <div class="text-gray-500" style="font-size: 0.7rem;">Analytics</div>
                </div>
            </td>
        `;
        
        tableBody.appendChild(row);
    });
}

function getTopicProgress(data, topicId) {
    if (!data?.state?.topics?.[topicId]) return 0;
    
    // Try overall progress first
    if (data.state.topics[topicId].overall?.p !== undefined) {
        return data.state.topics[topicId].overall.p;
    }
    
    // For class average, try to calculate from individual resources
    const topicData = data.state.topics[topicId];
    if (topicData.values) {
        const resourceValues = Object.values(topicData.values);
        if (resourceValues.length > 0) {
            const totalProgress = resourceValues.reduce((sum, resource) => sum + (resource.p || 0), 0);
            return totalProgress / resourceValues.length;
        }
    }
    
    return 0;
}

function calculateComparativeData() {
    // Get my progress data
    const myData = responseData.learners.find(learner => learner.id === responseData.context.learnerId);
    const classData = responseData.groups.find(group => group.name === 'Class Average');
    
    if (!myData || !classData) return null;
    
    // Create comparative data structure
    const comparativeData = {
        state: {
            topics: {}
        }
    };
    
    // Calculate differences for each topic
    responseData.topics.forEach(topic => {
        const myTopic = myData.state.topics[topic.id];
        const classTopic = classData.state.topics[topic.id];
        
        if (myTopic && classTopic) {
            comparativeData.state.topics[topic.id] = {
                values: {}
            };
            
            // Calculate differences for each resource
            responseData.resources.forEach(resource => {
                const myValue = myTopic.values?.[resource.id]?.p || 0;
                const classValue = classTopic.values?.[resource.id]?.p || 0;
                const difference = myValue - classValue; // Positive = ahead, Negative = behind
                
                comparativeData.state.topics[topic.id].values[resource.id] = {
                    p: difference
                };
            });
            
            // Calculate overall topic difference
            const myOverall = myTopic.overall?.p || 0;
            const classOverall = classTopic.overall?.p || 0;
            const overallDifference = myOverall - classOverall;
            
            comparativeData.state.topics[topic.id].overall = {
                p: overallDifference
            };
        }
    });
    
    return comparativeData;
}

function getCellValue(data, topicId, resourceId) {
    if (!data?.state?.topics?.[topicId]?.values?.[resourceId]) return 0;
    return data.state.topics[topicId].values[resourceId].p || 0;
}

function getTextColor(value) {
    // Handle comparative view (can be negative or positive)
    if (currentViewMode === 'comparative') {
        // Determine if we're in dark mode using the same logic as base.html
        const userPrefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        const savedTheme = localStorage.getItem('theme');
        const isDarkMode = savedTheme ? savedTheme === 'dark' : userPrefersDark;
        if (value === 0) {
            return '#6c757d'; // Secondary color for neutral
        } else if (value > 0) {
            // Positive difference (ahead of class) - use green
            const intensity = Math.min(Math.abs(value), 1); // Cap at 1        
            if (isDarkMode) {
                const r = Math.round(40 + (255 - 40) * (1 - intensity));
                const g = Math.round(167 + (255 - 167) * (1 - intensity));
                const b = Math.round(69 + (255 - 69) * (1 - intensity));
                return `rgb(${r}, ${g}, ${b})`;
            } else {
                const r = Math.round(40 * intensity);
                const g = Math.round(167 * intensity);
                const b = Math.round(69 * intensity);
                return `rgb(${r}, ${g}, ${b})`;
            }
        } else {
            // Negative difference (behind class) - use red
            const intensity = Math.min(Math.abs(value), 1); // Cap at 1
            if (isDarkMode) {
                const r = Math.round(220 + (255 - 220) * (1 - intensity));
                const g = Math.round(53 + (255 - 53) * (1 - intensity));
                const b = Math.round(69 + (255 - 69) * (1 - intensity));
                return `rgb(${r}, ${g}, ${b})`;
            } else {
                const r = Math.round(220 * intensity);
                const g = Math.round(53 * intensity);
                const b = Math.round(69 * intensity);
                return `rgb(${r}, ${g}, ${b})`;
            }
        }
    }
    
    // Regular progress view
    const percent = Math.round(value * 100);
    
    // Return secondary color for 0%
    if (percent === 0) {
        return '#6c757d'; // Secondary color
    }
    
    if (percent <= 50) {
        // Linear interpolation from danger to warning
        const ratio = percent / 50;
        const r = Math.round(220 + (255 - 220) * ratio);
        const g = Math.round(53 + (193 - 53) * ratio);
        const b = Math.round(69 + (7 - 69) * ratio);
        
        return `rgb(${r}, ${g}, ${b})`;
    } else {
        // Linear interpolation from warning to success
        const ratio = (percent - 50) / 50;
        const r = Math.round(255 + (40 - 255) * ratio);
        const g = Math.round(193 + (167 - 193) * ratio);
        const b = Math.round(7 + (69 - 7) * ratio);
        
        return `rgb(${r}, ${g}, ${b})`;
    }
}

function getCellStyle(value) {
    return {
        backgroundColor: 'transparent',
        borderColor: '#dee2e6',
        color: getTextColor(value)
    };
}

function getProgressBarStyle(percent) {
    const value = percent / 100;
    const color = getTextColor(value);
    
    if (percent === 0) {
        return {
            backgroundColor: '#6c757d'
        };
    }
    
    return {
        backgroundColor: color
    };
}

function getBadgeStyle(percent) {
    // Handle comparative view differently
    if (currentViewMode === 'comparative') {
        const value = percent / 100;
        if (value === 0) {
            return { backgroundColor: '#6c757d', color: '#ffffff' };
        } else if (value > 0) {
            return { backgroundColor: '#16a34a', color: '#ffffff' };
        } else {
            return { backgroundColor: '#dc2626', color: '#ffffff' };
        }
    }
    
    // Regular progress view
    const value = percent / 100;
    const color = getTextColor(value);
    
    if (percent === 0) {
        return { backgroundColor: '#6c757d', color: '#ffffff' };
    }
    
    return { backgroundColor: color, color: '#ffffff' };
}

function showStudentDetails(learnerId) {
    const learner = responseData.learners.find(l => l.id === learnerId);
    if (!learner) return;

    // Create modal with Tailwind classes
    const modalHtml = `
        <div class="modal-overlay hidden fixed inset-0 z-[60] items-center justify-center bg-black/50 p-4" id="studentModal" aria-hidden="true">
            <div class="modal-backdrop-close absolute inset-0"></div>
            <div class="relative bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-6xl max-h-[90vh] flex flex-col overflow-hidden">
                <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200 dark:border-gray-700 bg-blue-600 text-white">
                    <h5 class="text-lg font-bold">
                        <i class="fas fa-user-graduate mr-2"></i>
                        Student Details: ${learner.id}
                    </h5>
                    <button type="button" data-bs-dismiss="modal" class="text-white/80 hover:text-white text-2xl leading-none">&times;</button>
                </div>
                <div class="flex-1 overflow-y-auto p-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        ${responseData.topics.sort((a,b) => a.order - b.order).map((topic, index) => {
                            const topicData = learner.state.topics[topic.id];
                            const progress = (topicData?.overall?.p || 
                                           topicData?.values?.['Coding Problems']?.p || 
                                           topicData?.p || 
                                           0) * 100;
                            const progressPercent = Math.max(0, Math.min(100, Math.round(progress)));
                            
                            return `
                                <div>
                                    <div class="card h-full">
                                        <div class="p-4">
                                            <div class="flex justify-between items-center mb-3">
                                                <h6 class="mb-0 font-bold">${topic.name}</h6>
                                                <span class="badge" style="${Object.entries(getBadgeStyle(progressPercent)).map(([key, value]) => `${key.replace(/([A-Z])/g, '-$1').toLowerCase()}: ${value}`).join('; ')}">${progressPercent}%</span>
                                            </div>
                                            <div class="progress mb-3" style="height: 8px;">
                                                <div class="progress-bar" style="width: ${progressPercent}%; ${Object.entries(getProgressBarStyle(progressPercent)).map(([key, value]) => `${key.replace(/([A-Z])/g, '-$1').toLowerCase()}: ${value}`).join('; ')}"></div>
                                            </div>
                                            <div class="space-y-2">
                                                ${responseData.resources.map((resource, rIdx) => {
                                                    const resourceProgress = (topicData?.values?.[resource.id]?.p || 0) * 100;
                                                    const resourcePercent = Math.round(resourceProgress);
                                                    const actList = (responseData.topics.find(t => t.id === topic.id)?.activities?.[resource.id]) || [];
                                                    const collapseId = `topic-${topic.id}-res-${resource.id}-${rIdx}`.replace(/[^a-zA-Z0-9_-]/g, '_');
                                                    const activitiesRows = actList.map(activity => {
                                                        const aProg = learner?.state?.activities?.[topic.id]?.[resource.id]?.[activity.id]?.values?.p || 0;
                                                        const aPerf = learner?.state?.activities?.[topic.id]?.[resource.id]?.[activity.id]?.values?.k;
                                                        const aPct = Math.round(aProg * 100);
                                                        const status = aPct >= 90 ? 'Completed' : (aPct > 0 ? 'In Progress' : 'Not Started');
                                                    return `
                                                            <tr>
                                                                <td class="break-words">${activity.name || activity.id}</td>
                                                                <td class="text-center">
                                                                    <div class="progress" style="width: 100px; height: 14px; margin: 0 auto;">
                                                                        <div class="progress-bar" style="width: ${aPct}%; ${Object.entries(getProgressBarStyle(aPct)).map(([k,v]) => `${k.replace(/([A-Z])/g,'-$1').toLowerCase()}: ${v}`).join('; ')}"></div>
                                                                    </div>
                                                                </td>
                                                                <td class="text-center font-semibold">${aPct}%</td>
                                                                <td class="text-center">
                                                                    ${status === 'Completed' ? '<span class="badge badge-success">Completed</span>' : status === 'In Progress' ? '<span class="badge badge-secondary">In Progress</span>' : '<span class="badge badge-light">Not Started</span>'}
                                                                </td>
                                                            </tr>`;
                                                    }).join('');
                                                    return `
                                                        <div>
                                                            <div class="flex justify-between items-center">
                                                                <div class="flex items-center gap-2">
                                                                    <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#${collapseId}" aria-expanded="false" aria-controls="${collapseId}">
                                                                        <i class="fas fa-chevron-down"></i>
                                                                    </button>
                                                                    <small class="text-gray-500">${resource.name}</small>
                                                                </div>
                                                                <small class="font-semibold">${resourcePercent}%</small>
                                                            </div>
                                                            <div class="progress mt-1" style="height: 4px;">
                                                                <div class="progress-bar" style="width: ${resourcePercent}%; ${Object.entries(getProgressBarStyle(resourcePercent)).map(([key, value]) => `${key.replace(/([A-Z])/g, '-$1').toLowerCase()}: ${value}`).join('; ')}"></div>
                                                            </div>
                                                            <div class="hidden mt-2" id="${collapseId}">
                                                                ${actList.length ? `
                                                                <div class="overflow-x-auto">
                                                                    <table class="table table-sm mb-0">
                                                                        <thead>
                                                                            <tr>
                                                                                <th>Activity</th>
                                                                                <th class="text-center">Progress</th>
                                                                                <th class="text-center">%</th>
                                                                                <th class="text-center">Status</th>
                                                                            </tr>
                                                                        </thead>
                                                                        <tbody>
                                                                            ${activitiesRows}
                                                                        </tbody>
                                                                    </table>
                                                                </div>` : '<div class="text-gray-500">No activities listed for this resource.</div>'}
                                                            </div>
                                                        </div>
                                                    `;
                                                }).join('')}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if any
    const existingModal = document.getElementById('studentModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add new modal to body
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('studentModal'));
    modal.show();
}

function handleCellClick(topicId, resourceId, topicName, resourceName) {
    
    // Get class average data for this topic/resource
    const classAvgData = responseData.groups.find(g => g.name === 'Class Average');
    const classProgress = classAvgData?.state?.topics?.[topicId]?.values?.[resourceId]?.p || 0;
    const classProgressPercent = Math.round(classProgress * 100);
    
    // Get individual student data for this topic/resource
    const studentData = responseData.learners.map(learner => {
        const progress = learner.state.topics?.[topicId]?.values?.[resourceId]?.p || 0;
        const progressPercent = Math.round(progress * 100);
        return {
            id: learner.id,
            progress: progress,
            progressPercent: progressPercent,
            isAboveAverage: progress > classProgress,
            isStruggling: classProgress > 0 && progress < (classProgress * 0.5)
        };
    }).sort((a, b) => b.progress - a.progress); // Sort by progress (highest first)
    
    // Calculate statistics
    const totalStudents = studentData.length;
    const studentsAboveAverage = studentData.filter(s => s.isAboveAverage).length;
    const studentsStruggling = studentData.filter(s => s.isStruggling).length;
    const studentsCompleted = studentData.filter(s => s.progressPercent >= 90).length;
    const averageProgress = studentData.reduce((sum, s) => sum + s.progress, 0) / totalStudents;
    const averageProgressPercent = Math.round(averageProgress * 100);
    
    // Prepare activity definitions for this topic/resource
    const topicDef = responseData.topics.find(t => t.id === topicId);
    const activitiesList = topicDef?.activities?.[resourceId] || [];

    // Create modal with Tailwind classes
    const modalHtml = `
        <div class="modal-overlay hidden fixed inset-0 z-[60] items-center justify-center bg-black/50 p-4" id="cellModal" aria-hidden="true">
            <div class="modal-backdrop-close absolute inset-0"></div>
            <div class="relative bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-6xl max-h-[90vh] flex flex-col overflow-hidden">
                <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200 dark:border-gray-700 bg-blue-600 text-white">
                    <h5 class="text-lg font-bold">
                        <i class="fas fa-chart-bar mr-2"></i>
                        ${topicName}  ${resourceName}
                    </h5>
                    <button type="button" data-bs-dismiss="modal" class="text-white/80 hover:text-white text-2xl leading-none">&times;</button>
                </div>
                <div class="flex-1 overflow-y-auto p-6">
                    <!-- Overview Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-3 mb-6">
                        <div class="card h-full">
                            <div class="p-4 text-center">
                                <div class="bg-blue-600 rounded-full inline-flex items-center justify-center mb-2" style="width: 40px; height: 40px;">
                                    <i class="fas fa-percentage text-white"></i>
                                </div>
                                <h6 class="font-bold mb-1">Class Average</h6>
                                <div class="text-2xl font-bold text-blue-600">${classProgressPercent}%</div>
                            </div>
                        </div>
                        <div class="card h-full">
                            <div class="p-4 text-center">
                                <div class="bg-green-600 rounded-full inline-flex items-center justify-center mb-2" style="width: 40px; height: 40px;">
                                    <i class="fas fa-check-circle text-white"></i>
                                </div>
                                <h6 class="font-bold mb-1">Completed</h6>
                                <div class="text-2xl font-bold text-green-600">${studentsCompleted}</div>
                            </div>
                        </div>
                        <div class="card h-full">
                            <div class="p-4 text-center">
                                <div class="bg-yellow-500 rounded-full inline-flex items-center justify-center mb-2" style="width: 40px; height: 40px;">
                                    <i class="fas fa-exclamation-triangle text-white"></i>
                                </div>
                                <h6 class="font-bold mb-1">Struggling</h6>
                                <div class="text-2xl font-bold text-yellow-500">${studentsStruggling}</div>
                            </div>
                        </div>
                        <div class="card h-full">
                            <div class="p-4 text-center">
                                <div class="bg-cyan-500 rounded-full inline-flex items-center justify-center mb-2" style="width: 40px; height: 40px;">
                                    <i class="fas fa-users text-white"></i>
                                </div>
                                <h6 class="font-bold mb-1">Above Average</h6>
                                <div class="text-2xl font-bold text-cyan-500">${studentsAboveAverage}</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Student Progress Breakdown (with expandable activity rows) -->
                    <div>
                        <h6 class="font-bold mb-3">
                            <i class="fas fa-list mr-2"></i>Student Progress Breakdown
                        </h6>
                        <div class="overflow-x-auto">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th class="font-bold">Student</th>
                                        <th class="font-bold text-center">Progress</th>
                                        <th class="font-bold text-center">Status</th>
                                        <th class="font-bold text-center">vs Class Avg</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${(() => {
                                        const learnerById = Object.fromEntries(responseData.learners.map(l => [l.id, l]));
                                        return studentData.map((student, idx) => {
                                            const safeId = String(student.id).replace(/[^a-zA-Z0-9_-]/g, '') + '-' + idx;
                                            const learner = learnerById[student.id];
                                            const activityRows = activitiesList.map(activity => {
                                                const aProg = learner?.state?.activities?.[topicId]?.[resourceId]?.[activity.id]?.values?.p || 0;
                                                const aPerf = learner?.state?.activities?.[topicId]?.[resourceId]?.[activity.id]?.values?.k;
                                                const aPct = Math.round(aProg * 100);
                                                const status = aPct >= 90 ? 'Completed' : (aPct > 0 ? 'In Progress' : 'Not Started');
                                                return `
                                                    <tr>
                                                        <td class="break-words">${activity.name || activity.id}</td>
                                                        <td class="text-center">
                                                            <div class="progress" style="width: 100px; height: 14px;">
                                                                <div class="progress-bar" style="width: ${aPct}%; ${Object.entries(getProgressBarStyle(aPct)).map(([k,v]) => `${k.replace(/([A-Z])/g,'-$1').toLowerCase()}: ${v}`).join('; ')}"></div>
                                                            </div>
                                                        </td>
                                                        <td class="text-center font-semibold">${aPct}%</td>
                                                        <td class="text-center">
                                                            ${status === 'Completed' ? '<span class="badge badge-success">Completed</span>' : status === 'In Progress' ? '<span class="badge badge-secondary">In Progress</span>' : '<span class="badge badge-light">Not Started</span>'}
                                                        </td>
                                                    </tr>`;
                                            }).join('');
                                            return `
                                                <tr class="${student.isStruggling ? 'table-warning-row' : student.isAboveAverage ? 'table-success-row' : ''}">
                                                    <td class="font-bold">
                                                        <button class="btn btn-sm btn-outline-secondary mr-2" type="button" data-bs-toggle="collapse" data-bs-target="#act-${safeId}" aria-expanded="false" aria-controls="act-${safeId}">
                                                            <i class="fas fa-chevron-down"></i>
                                                        </button>
                                                        ${student.id}
                                                    </td>
                                                    <td class="text-center">
                                                        <div class="flex items-center justify-center">
                                                            <div class="progress mr-2" style="width: 100px; height: 20px;">
                                                                <div class="progress-bar" style="width: ${student.progressPercent}%; background-color: ${getTextColor(student.progress)};"></div>
                                                            </div>
                                                            <span class="font-bold">${student.progressPercent}%</span>
                                                        </div>
                                                    </td>
                                                    <td class="text-center">
                                                        ${student.progressPercent >= 90 ? '<span class="badge badge-success">Completed</span>' : 
                                                          student.isStruggling ? '<span class="badge badge-warning">Struggling</span>' : 
                                                          '<span class="badge badge-secondary">In Progress</span>'}
                                                    </td>
                                                    <td class="text-center">
                                                        ${student.isAboveAverage ? 
                                                            `<span class="text-green-600 font-bold">+${student.progressPercent - classProgressPercent}%</span>` :
                                                            student.progress > 0 ? 
                                                                `<span class="text-red-500 font-bold">${student.progressPercent - classProgressPercent}%</span>` :
                                                                '<span class="text-gray-500">-</span>'
                                                        }
                                                    </td>
                                                </tr>
                                                <tr class="hidden bg-gray-100 dark:bg-gray-700" id="act-${safeId}">
                                                    <td colspan="4">
                                                        ${activitiesList.length ? `
                                                        <div class="overflow-x-auto">
                                                            <table class="table table-sm mb-0">
                                                                <thead>
                                                                    <tr>
                                                                        <th>Activity</th>
                                                                        <th class="text-center">Progress</th>
                                                                        <th class="text-center">%</th>
                                                                        <th class="text-center">Status</th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody>
                                                                    ${activityRows}
                                                                </tbody>
                                                            </table>
                                                        </div>` : '<div class="text-gray-500">No activities listed for this resource.</div>'}
                                                    </td>
                                                </tr>`;
                                        }).join('');
                                    })()}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if any
    const existingModal = document.getElementById('cellModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add new modal to body
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('cellModal'));
    modal.show();
}

function showError(message) {
    // Create a modern toast notification
    const toastDiv = document.createElement('div');
    toastDiv.className = 'fixed top-4 right-4 z-[9999] bg-red-600 text-white rounded-lg shadow-lg px-4 py-3 flex items-center max-w-md';
    toastDiv.setAttribute('role', 'alert');
    toastDiv.innerHTML = `
        <div class="flex-1 text-sm">
            <i class="fas fa-exclamation-triangle mr-2"></i>
            ${message}
        </div>
        <button class="ml-3 text-white/80 hover:text-white text-lg leading-none" onclick="this.parentElement.remove()">&times;</button>
    `;
    
    document.body.appendChild(toastDiv);
    
    // Remove toast after 5 seconds
    setTimeout(() => {
        if (toastDiv.parentNode) {
            toastDiv.remove();
        }
    }, 5000);
}

/**
 * Show error state on a form field (red border and error message)
 */
function showFormFieldError(fieldId, errorMessage) {
    const field = document.getElementById(fieldId);
    if (!field) return;
    
    // Add error styling to the input field
    field.classList.add('is-invalid');
    field.style.borderColor = '#dc3545';
    field.style.borderWidth = '2px';
    
    // Also check for dropdowns (ktGroupSelect, ktCourseSelect)
    let dropdownField = null;
    if (fieldId === 'grp') {
        dropdownField = document.getElementById('ktGroupSelect');
    } else if (fieldId === 'cid') {
        dropdownField = document.getElementById('ktCourseSelect');
    }
    
    if (dropdownField) {
        dropdownField.classList.add('is-invalid');
        dropdownField.style.borderColor = '#dc3545';
        dropdownField.style.borderWidth = '2px';
    }
    
    // Find or create error message element
    const fieldCol = field.closest('div');
    if (!fieldCol) return;
    
    // Remove existing error message if any
    const existingError = fieldCol.querySelector('.field-error-message');
    if (existingError) {
        existingError.remove();
    }
    
    // Create error message element
    const errorDiv = document.createElement('div');
    errorDiv.className = 'field-error-message mt-1';
    errorDiv.innerHTML = `<small class="text-red-500" style="display: block;"><i class="fas fa-exclamation-circle mr-1"></i>${errorMessage}</small>`;
    fieldCol.appendChild(errorDiv);
    
    // Add input/change listener to clear error when user starts typing or changes selection
    const clearErrorOnInput = function() {
        clearFieldError(fieldId);
        field.removeEventListener('input', clearErrorOnInput);
        if (dropdownField) {
            dropdownField.removeEventListener('change', clearErrorOnInput);
        }
    };
    field.addEventListener('input', clearErrorOnInput);
    if (dropdownField) {
        dropdownField.addEventListener('change', clearErrorOnInput);
    }
}

/**
 * Clear error state from a form field
 */
function clearFieldError(fieldId) {
    const field = document.getElementById(fieldId);
    if (!field) return;
    
    // Remove error styling from input field
    field.classList.remove('is-invalid');
    field.style.borderColor = '';
    field.style.borderWidth = '';
    
    // Also clear dropdown errors if they exist
    let dropdownField = null;
    if (fieldId === 'grp') {
        dropdownField = document.getElementById('ktGroupSelect');
    } else if (fieldId === 'cid') {
        dropdownField = document.getElementById('ktCourseSelect');
    }
    
    if (dropdownField) {
        dropdownField.classList.remove('is-invalid');
        dropdownField.style.borderColor = '';
        dropdownField.style.borderWidth = '';
    }
    
    // Remove error message
    const fieldCol = field.closest('div');
    if (fieldCol) {
        const errorMessage = fieldCol.querySelector('.field-error-message');
        if (errorMessage) {
            errorMessage.remove();
        }
    }
}

/**
 * Clear all form field errors
 */
function clearFormErrors() {
    clearFieldError('grp');
    clearFieldError('cid');
}
</script>
