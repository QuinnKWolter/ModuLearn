<script>
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('fetchDataBtn').addEventListener('click', handleFetch);
    
    // View mode change listeners
    document.querySelectorAll('input[name="viewMode"]').forEach(radio => {
        radio.addEventListener('change', function() {
            currentViewMode = this.value;
            updateGrid();
            
            // Update all radio buttons to reflect the current selection
            document.querySelectorAll('input[name="viewMode"]').forEach(r => {
                r.checked = (r.value === currentViewMode);
            });
        });
    });
    
    // Initialize button states on page load
    updateButtonStates();

    // Simple validation for required fields (Group ID and Course ID)
    const grpInput = document.getElementById('grp');
    const cidInput = document.getElementById('cid');
    const fetchBtn = document.getElementById('fetchDataBtn');

    // Make updateFetchButtonState globally accessible
    window.updateFetchButtonState = function() {
        const hasGrp = (grpInput?.value || '').trim().length > 0;
        const hasCid = (cidInput?.value || '').trim().length > 0;
        if (fetchBtn) {
            fetchBtn.disabled = !(hasGrp && hasCid);
        }
    };

    grpInput?.addEventListener('input', window.updateFetchButtonState);
    cidInput?.addEventListener('input', window.updateFetchButtonState);
    window.updateFetchButtonState();
    
    // Auto-fetch user's KnowledgeTree groups and Course IDs
    autoLoadUserGroups();
});

/**
 * Automatically load user's KnowledgeTree groups and Course IDs.
 * Uses groups data provided by backend (from direct database query).
 * If successful, show dropdown for group selection.
 */
function autoLoadUserGroups() {
    const grpInput = document.getElementById('grp');
    const cidInput = document.getElementById('cid');
    const fetchBtn = document.getElementById('fetchDataBtn');
    
    // Get groups from backend-provided data (already fetched via direct DB query)
    const groups = window.autoGroups || [];
    
    if (groups && groups.length > 0) {
        // Show group dropdown selector (no auto-select - let user choose)
        showGroupDropdown(groups, grpInput, cidInput);
    }
    // If no groups, silently fail - manual input is still available
}

/**
 * Show a dropdown selector for KnowledgeTree groups.
 * This replaces the manual Group ID input when groups are available.
 */
function showGroupDropdown(groups, grpInput, cidInput) {
    const headerCard = document.querySelector('.card-body.text-white');
    if (!headerCard) return;
    
    // Find the Group ID input's parent column
    const grpCol = grpInput.closest('.col-md-3');
    if (!grpCol) return;
    
    // Store the original input (we'll hide it)
    const originalInput = grpInput;
    
    // Create dropdown container
    const dropdownContainer = document.createElement('div');
    dropdownContainer.className = 'kt-group-dropdown';
    dropdownContainer.innerHTML = `
        <label for="ktGroupSelect" class="form-label fw-semibold text-white">
            Group ID
            <small class="text-white-50 d-block" style="font-size: 0.75rem; font-weight: normal;">
                (Select from your courses)
            </small>
        </label>
        <select class="form-select form-select-lg" id="ktGroupSelect">
            <option value="">-- Select a course/group --</option>
            ${groups.map((group, index) => 
                `<option value="${index}" 
                    data-group-login="${group.group_login}" 
                    data-group-name="${group.group_name}">
                    ${group.group_name}
                </option>`
            ).join('')}
        </select>
        <small class="text-white-50 d-block mt-1">
            <a href="#" id="useManualGroup" class="text-white-50" style="text-decoration: underline;">
                Or enter manually
            </a>
        </small>
    `;
    
    // Replace the Group ID input with dropdown
    const grpLabel = grpCol.querySelector('label[for="grp"]');
    if (grpLabel) {
        grpLabel.style.display = 'none';
    }
    originalInput.style.display = 'none';
    grpCol.insertBefore(dropdownContainer, originalInput);
    
    // Store groups data globally for access
    window.ktGroupsData = groups;
    
    // Store groups data for access in change handler
    window.ktGroupsData = groups;
    
    // Add change listener for group selection
    const groupSelect = dropdownContainer.querySelector('#ktGroupSelect');
    groupSelect.addEventListener('change', async function() {
        const selectedIndex = this.value;
        if (selectedIndex !== '') {
            const selectedGroup = groups[parseInt(selectedIndex)];
            await selectGroup(selectedGroup, originalInput, cidInput);
        } else {
            // Clear fields if "Select" option chosen
            originalInput.value = '';
            cidInput.value = '';
            
            // Remove any Course ID dropdown or messages
            const courseDropdown = document.querySelector('.kt-course-dropdown');
            if (courseDropdown) courseDropdown.remove();
            const courseLoading = document.querySelector('.kt-course-loading');
            if (courseLoading) courseLoading.remove();
            const courseError = document.querySelector('.kt-course-error');
            if (courseError) courseError.remove();
            const noCourseMsg = document.querySelector('.kt-no-course-ids');
            if (noCourseMsg) noCourseMsg.remove();
            
            if (window.updateFetchButtonState) {
                window.updateFetchButtonState();
            }
        }
    });
    
    // Add manual entry toggle
    const manualLink = dropdownContainer.querySelector('#useManualGroup');
    manualLink.addEventListener('click', function(e) {
        e.preventDefault();
        // Hide dropdown, show manual input
        dropdownContainer.style.display = 'none';
        originalInput.style.display = 'block';
        if (grpLabel) grpLabel.style.display = 'block';
        originalInput.focus();
    });
}

/**
 * Handle group selection - populate Group ID field and discover Course IDs on-demand.
 */
async function selectGroup(group, grpInput, cidInput) {
    // Populate Group ID
    grpInput.value = group.group_login;
    
    // Clear Course ID field initially
    cidInput.value = '';
    
    // Show loading indicator for Course ID discovery
    const cidCol = cidInput.closest('.col-md-3');
    const loadingDiv = document.createElement('div');
    loadingDiv.className = 'kt-course-loading mt-2';
    loadingDiv.innerHTML = '<small class="text-white-50"><i class="fas fa-spinner fa-spin me-1"></i>Discovering Course IDs...</small>';
    cidCol.appendChild(loadingDiv);
    
    // Discover Course IDs on-demand for this specific group
    try {
        const response = await fetch(`{% url "dashboard:discover_course_ids" %}?grp=${encodeURIComponent(group.group_login)}`);
        const data = await response.json();
        
        // Remove loading indicator
        loadingDiv.remove();
        
        if (data.success && data.course_ids && data.course_ids.length > 0) {
            if (data.course_ids.length === 1) {
                // Single Course ID - auto-populate
                cidInput.value = data.course_ids[0];
                    } else {
                // Multiple Course IDs - show dropdown
                showCourseIdDropdown(data.course_ids, cidInput);
            }
        } else {
            // No Course IDs discovered - leave empty for manual entry
            // Show helpful message
            const noCourseMsg = document.createElement('div');
            noCourseMsg.className = 'kt-no-course-ids mt-2';
            noCourseMsg.innerHTML = '<small class="text-white-50"><i class="fas fa-info-circle me-1"></i>No Course IDs found. Please enter manually.</small>';
            cidCol.appendChild(noCourseMsg);
        }
    } catch (error) {
        // Remove loading indicator
        loadingDiv.remove();
        
        // Show error message
        const errorMsg = document.createElement('div');
        errorMsg.className = 'kt-course-error mt-2';
        errorMsg.innerHTML = '<small class="text-warning"><i class="fas fa-exclamation-triangle me-1"></i>Could not discover Course IDs. Please enter manually.</small>';
        cidCol.appendChild(errorMsg);
        
        console.error('Error discovering Course IDs:', error);
    }
    
    // Update button state
    if (window.updateFetchButtonState) {
        window.updateFetchButtonState();
    }
}

/**
 * Show a dropdown for Course ID selection when multiple Course IDs are available.
 */
function showCourseIdDropdown(courseIds, cidInput) {
    // Remove existing Course ID dropdown if any
    const existingDropdown = document.querySelector('.kt-course-dropdown');
    if (existingDropdown) {
        existingDropdown.remove();
    }
    
    // Find the Course ID input's parent column
    const cidCol = cidInput.closest('.col-md-3');
    if (!cidCol) return;
    
    const originalInput = cidInput;
    
    // Create dropdown
    const dropdownContainer = document.createElement('div');
    dropdownContainer.className = 'kt-course-dropdown';
    dropdownContainer.innerHTML = `
        <label for="ktCourseSelect" class="form-label fw-semibold text-white">
            Course ID
            <small class="text-white-50 d-block" style="font-size: 0.75rem; font-weight: normal;">
                (Select course)
            </small>
        </label>
        <select class="form-select form-select-lg" id="ktCourseSelect">
            <option value="">-- Select course --</option>
            ${courseIds.map(cid => 
                `<option value="${cid}">Course ${cid}</option>`
            ).join('')}
        </select>
        <small class="text-white-50 d-block mt-1">
            <a href="#" id="useManualCourse" class="text-white-50" style="text-decoration: underline;">
                Or enter manually
            </a>
        </small>
    `;
    
    // Replace the Course ID input with dropdown
    const cidLabel = cidCol.querySelector('label[for="cid"]');
    if (cidLabel) {
        cidLabel.style.display = 'none';
    }
    originalInput.style.display = 'none';
    cidCol.insertBefore(dropdownContainer, originalInput);
    
    // Add change listener
    const courseSelect = dropdownContainer.querySelector('#ktCourseSelect');
    courseSelect.addEventListener('change', function() {
        originalInput.value = this.value;
        if (window.updateFetchButtonState) {
            window.updateFetchButtonState();
        }
    });
    
    // Auto-select first Course ID
    if (courseIds.length > 0) {
        courseSelect.value = courseIds[0];
        originalInput.value = courseIds[0];
        if (window.updateFetchButtonState) {
            window.updateFetchButtonState();
        }
    }
    
    // Add manual entry toggle
    const manualLink = dropdownContainer.querySelector('#useManualCourse');
    manualLink.addEventListener('click', function(e) {
        e.preventDefault();
        // Hide dropdown, show manual input
        dropdownContainer.style.display = 'none';
        originalInput.style.display = 'block';
        if (cidLabel) cidLabel.style.display = 'block';
        originalInput.focus();
    });
}

let responseData = null;
let currentViewMode = 'classAverage';

function updateButtonStates() {
    // Update all radio buttons to reflect the current selection
    document.querySelectorAll('input[name="viewMode"]').forEach(r => {
        r.checked = (r.value === currentViewMode);
    });
}

function handleFetch() {
    const btn = document.getElementById('fetchDataBtn');
    const btnText = document.getElementById('fetchBtnText');
    const spinner = document.getElementById('fetchSpinner');
    const progressContainer = document.getElementById('fetchProgressContainer');
    const progressBar = document.getElementById('fetchProgressBar');
    const progressText = document.getElementById('fetchProgressText');
    const progressPercent = document.getElementById('fetchProgressPercent');
    const grpVal = (document.getElementById('grp')?.value || '').trim();
    const cidVal = (document.getElementById('cid')?.value || '').trim();
    if (!grpVal || !cidVal) {
        return; // Guard: do nothing if required fields are empty
    }
    
    btn.disabled = true;
    btnText.textContent = 'Loading...';
    spinner.classList.remove('d-none');
    progressContainer.classList.remove('d-none');
    progressBar.style.width = '0%';
    progressPercent.textContent = '0%';
    
    // Use batch endpoint to fetch all students at once
    progressText.textContent = 'Connecting to database...';
    progressBar.style.width = '10%';
    progressPercent.textContent = '10%';
    
    const batchAnalyticsParams = {
        grp: document.getElementById('grp').value,
        cid: document.getElementById('cid').value
    };
    
    const batchAnalyticsUrl = `{% url 'dashboard:fetch_all_students_analytics' %}?${new URLSearchParams(batchAnalyticsParams)}`;
    
    fetch(batchAnalyticsUrl)
        .then(response => {
            if (!response.ok) throw new Error(`Batch Analytics API Error: ${response.statusText}`);
            progressBar.style.width = '50%';
            progressPercent.textContent = '50%';
            progressText.textContent = 'Processing data...';
            return response.json();
        })
        .then(data => {
            if (data.error) throw new Error(data.error);
            
            progressBar.style.width = '90%';
            progressPercent.textContent = '90%';
            progressText.textContent = 'Building dashboard...';
            
            // The batch endpoint returns the complete response structure
            responseData = data;
            
            progressBar.style.width = '100%';
            progressPercent.textContent = '100%';
            progressText.textContent = 'Complete!';
                
                // Hide progress bar and show dashboard
            setTimeout(() => {
                progressContainer.classList.add('d-none');
                const dashboardContent = document.getElementById('dashboardContent');
                dashboardContent.classList.remove('d-none');
                dashboardContent.classList.add('fade-in');
                renderDashboard();
            }, 300);
        })
        .catch(error => {
            console.error('Fetch error:', error);
            showError(`Failed to load data: ${error.message}`);
            progressContainer.classList.add('d-none');
        })
        .finally(() => {
            btn.disabled = false;
            btnText.textContent = 'Launch Analytics';
            spinner.classList.add('d-none');
        });
}

function mapLearnerIds(analyticsData, classListData) {
    // Step 1: Sort analytics learners by their integer ID (lowest to highest)
    const sortedAnalyticsLearners = analyticsData.learners.sort((a, b) => {
        const aId = parseInt(a.id);
        const bId = parseInt(b.id);
        return aId - bId;
    });
    
    // Step 2: Create mapping from sorted position to real learner ID
    const learnerIdMap = classListData.learners.map(learner => learner.learnerId);
    
    // Step 3: Update the sorted learners with real IDs
    sortedAnalyticsLearners.forEach((learner, index) => {
        if (index < learnerIdMap.length) {
            learner.id = learnerIdMap[index];
        }
    });
    
    // Step 4: Replace the original learners array with the sorted and mapped one
    analyticsData.learners = sortedAnalyticsLearners;
    
    return analyticsData;
}

function renderDashboard() {
    if (!responseData) return;
    
    populateKPIs();
    updateGrid();
}

function populateKPIs() {
    const classAvgData = responseData.groups.find(g => g.name === 'Class Average');
    if (!classAvgData) return;

    // Course Title
    document.getElementById('courseTitle').textContent = responseData.context.group.name;

    // Overall Progress - Calculate true class completion percentage
    let totalPossibleProgress = 0;
    let totalActualProgress = 0;
    
    responseData.topics.forEach(topic => {
        const topicData = classAvgData.state.topics[topic.id];
        if (topicData) {
            // Count all resources for this topic
            const resourceCount = Object.keys(topicData.values || {}).length;
            totalPossibleProgress += resourceCount;
            
            // Sum actual progress across all resources
            Object.values(topicData.values || {}).forEach(resource => {
                totalActualProgress += resource.p || 0;
            });
        }
    });
    
    const overallProgressPercent = totalPossibleProgress > 0 ? 
        Math.round((totalActualProgress / totalPossibleProgress) * 100) : 0;
    document.getElementById('overallProgress').textContent = `${overallProgressPercent}%`;

    // Students Enrolled
    document.getElementById('studentsEnrolled').textContent = responseData.learners.length;

    // Engagement Score - Percent of resources with any class activity (> 0 progress)
    let totalResources = 0;
    let engagedResources = 0;
    
    responseData.topics.forEach(topic => {
        const topicData = classAvgData.state.topics?.[topic.id];
        if (topicData?.values) {
            Object.values(topicData.values).forEach(resource => {
                totalResources++;
                if ((resource?.p || 0) > 0) engagedResources++;
            });
        }
    });
    
    const engagementScore = totalResources > 0 ? Math.round((engagedResources / totalResources) * 100) : 0;
    document.getElementById('engagementScore').textContent = `${engagementScore}%`;

    // Most Active Topic
    let mostActiveTopic = null;
    let highestProgress = 0;
    responseData.topics.forEach(topic => {
        const progress = classAvgData.state.topics[topic.id]?.values['Coding Problems']?.p || 0;
        if (progress > highestProgress) {
            highestProgress = progress;
            mostActiveTopic = topic;
        }
    });
    
    // Students Needing Intervention - Check ALL resources
    let studentsNeedingHelp = 0;
    responseData.learners.forEach(learner => {
        const learnerProgress = learner.state.topics;
        let strugglingResources = 0;
        let totalResources = 0;
        
        responseData.topics.forEach(topic => {
            const learnerTopicData = learnerProgress[topic.id];
            const classTopicData = classAvgData.state.topics[topic.id];
            
            if (learnerTopicData?.values && classTopicData?.values) {
                // Check each resource in this topic
                Object.keys(classTopicData.values).forEach(resourceId => {
                    const learnerResourceProgress = learnerTopicData.values[resourceId]?.p || 0;
                    const classResourceProgress = classTopicData.values[resourceId]?.p || 0;
                    
                    if (classResourceProgress > 0) { // Only consider resources with class activity
                        totalResources++;
                        if (learnerResourceProgress < (classResourceProgress * 0.5)) { // Struggling if < 50% of class average
                            strugglingResources++;
                        }
                    }
                });
            }
        });
        
        // Student needs intervention if struggling in > 30% of active resources
        if (totalResources > 0 && (strugglingResources / totalResources) > 0.3) {
            studentsNeedingHelp++;
        }
    });
    
    document.getElementById('studentsNeedingHelp').textContent = studentsNeedingHelp;
    
}

function updateGrid() {
    if (!responseData) return;
    
    // Update button states
    updateButtonStates();
    
    // Update title and description based on current view
    updateViewHeader();
    
    // Get the content containers
    const masteryGrid = document.getElementById('masteryGrid').closest('.table-responsive');
    const perStudentContent = document.getElementById('perStudentContent');
    
    if (currentViewMode === 'perStudent') {
        // Hide mastery grid and show per student content
        masteryGrid.style.display = 'none';
        perStudentContent.style.display = 'block';
        updatePerStudentView();
    } else {
        // Show mastery grid and hide per student content
        masteryGrid.style.display = 'block';
        perStudentContent.style.display = 'none';
        updateMasteryGrid();
    }
}

function updateViewHeader() {
    const titleElement = document.getElementById('viewTitle');
    const descriptionElement = document.getElementById('viewDescription');
    const classAvgHelp = document.getElementById('classAverageHelpBtn');
    const perStudentHelp = document.getElementById('perStudentHelpBtn');
    
    if (!titleElement || !descriptionElement) return;
    
    switch (currentViewMode) {
        case 'myProgress':
            titleElement.textContent = 'My Progress';
            descriptionElement.textContent = 'Your individual progress across all topics';
            if (classAvgHelp) classAvgHelp.classList.add('d-none');
            if (perStudentHelp) perStudentHelp.classList.add('d-none');
            break;
        case 'comparative':
            titleElement.textContent = 'Comparative View';
            descriptionElement.textContent = 'Your progress compared to class average';
            if (classAvgHelp) classAvgHelp.classList.add('d-none');
            if (perStudentHelp) perStudentHelp.classList.add('d-none');
            break;
        case 'classAverage':
            titleElement.textContent = 'Class Average';
            descriptionElement.textContent = 'Average class progress across all topics';
            if (classAvgHelp) classAvgHelp.classList.remove('d-none');
            if (perStudentHelp) perStudentHelp.classList.add('d-none');
            break;
        case 'perStudent':
            titleElement.textContent = 'Student Progress Overview';
            descriptionElement.textContent = 'Individual student progress tracking';
            if (classAvgHelp) classAvgHelp.classList.add('d-none');
            if (perStudentHelp) perStudentHelp.classList.remove('d-none');
            break;
    }
}

function updateMasteryGrid() {
    // Update grid headers
    const gridHeaders = document.getElementById('gridHeaders');
    while (gridHeaders.children.length > 1) {
        gridHeaders.removeChild(gridHeaders.lastChild);
    }
    
    // Add resource headers
    responseData.resources.forEach(resource => {
        const th = document.createElement('th');
        th.className = 'border-0 fw-bold text-center py-3';
        th.style.minWidth = '120px';
        th.innerHTML = `
            <div class="d-flex flex-column align-items-center">
                <i class="fas fa-tasks text-primary mb-1"></i>
                <span class="small text-break">${resource.name}</span>
            </div>
        `;
        gridHeaders.appendChild(th);
    });
    
    // Update grid body
    const gridBody = document.getElementById('gridBody');
    gridBody.innerHTML = '';
    
    // Get current data based on view mode
    let currentData;
    if (currentViewMode === 'myProgress') {
        currentData = responseData.learners.find(learner => learner.id === responseData.context.learnerId);
    } else if (currentViewMode === 'comparative') {
        // For comparative view, we'll calculate the difference between my progress and class average
        currentData = calculateComparativeData();
    } else {
        currentData = responseData.groups.find(group => group.name === 'Class Average');
    }
    
    if (!currentData) return;
    
    // Sort topics by order
    const sortedTopics = responseData.topics.sort((a, b) => a.order - b.order);
    
    // Create grid rows
    sortedTopics.forEach((topic, index) => {
        const row = document.createElement('tr');
        
        // Topic cell with gradient styling
        const topicProgress = getTopicProgress(currentData, topic.id);
        const progressPercent = Math.round(topicProgress * 100);
        const progressColor = getTextColor(topicProgress);
        const progressBarStyle = getProgressBarStyle(progressPercent);
        
        const topicCell = document.createElement('td');
        topicCell.className = 'border-0 py-2';
        topicCell.innerHTML = `
            <div class="d-flex align-items-center">
                <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 32px; height: 32px;">
                    <span class="text-white fw-bold small">${topic.order}</span>
                </div>
                <div class="flex-grow-1">
                    <div class="fw-bold mb-1">${topic.name}</div>
                    <div class="progress" style="height: 6px; background-color: rgba(0,0,0,0.1);">
                        <div class="progress-bar" role="progressbar" style="width: ${progressPercent}%; ${Object.entries(progressBarStyle).map(([key, value]) => `${key.replace(/([A-Z])/g, '-$1').toLowerCase()}: ${value}`).join('; ')}"></div>
                    </div>
                </div>
                <div class="ms-3">
                    <span class="badge fw-bold" style="${Object.entries(getBadgeStyle(progressPercent)).map(([key, value]) => `${key.replace(/([A-Z])/g, '-$1').toLowerCase()}: ${value}`).join('; ')}; min-width: 50px; text-align: center;">${progressPercent}%</span>
                </div>
            </div>
        `;
        row.appendChild(topicCell);
        
        // Resource cells with text gradient styling
        responseData.resources.forEach(resource => {
            const cell = document.createElement('td');
            const value = getCellValue(currentData, topic.id, resource.id);
            const textColor = getTextColor(value);
            
            cell.className = 'text-center border-0 py-2 progress-cell cursor-pointer';
            cell.style.cursor = 'pointer';
            cell.style.borderRadius = '0';
            cell.onclick = () => handleCellClick(topic.id, resource.id, topic.name, resource.name);
            
            // Store original colors for hover effect
            cell.dataset.originalTextColor = textColor;
            cell.dataset.originalBgColor = 'transparent';
            
            // Format the display value based on view mode
            let displayValue;
            if (currentViewMode === 'comparative') {
                const percentage = Math.round(value * 100);
                displayValue = percentage > 0 ? `+${percentage}%` : `${percentage}%`;
            } else {
                displayValue = `${Math.round(value * 100)}%`;
            }
            
            cell.innerHTML = `
                <div class="d-flex flex-column align-items-center">
                    <div class="fw-bold fs-6" style="color: ${textColor};">${displayValue}</div>
                </div>
            `;
            
            // Add hover event listeners for gentle highlight effect
            cell.addEventListener('mouseenter', function() {
                // Apply gentle background highlight to all cells
                this.style.backgroundColor = 'rgba(0, 0, 0, 0.1)';
                // Keep original text color but make it slightly darker for contrast
                if (textColor !== 'inherit') {
                    this.querySelector('.fw-bold').style.color = textColor;
                } else {
                    this.querySelector('.fw-bold').style.color = '#6c757d';
                }
            });
            
            cell.addEventListener('mouseleave', function() {
                // Restore original state for all cells
                this.style.backgroundColor = 'transparent';
                this.querySelector('.fw-bold').style.color = textColor;
            });
            
            row.appendChild(cell);
        });
        
        gridBody.appendChild(row);
    });
}

function updatePerStudentView() {
    const tableBody = document.getElementById('studentTableBody');
    tableBody.innerHTML = '';
    
    // Log before filtering
    // Show ALL learners (including those with isHidden: true) - no filtering
    const sortedLearners = responseData.learners;
    

    sortedLearners.forEach((learner, index) => {
        // Calculate overall progress
        const topicProgresses = responseData.topics.map(topic => {
            const topicData = learner.state?.topics?.[topic.id];
            const progress = topicData?.overall?.p || 
                           topicData?.values?.['Coding Problems']?.p || 
                           topicData?.p || 
                           0;
            return progress;
        });
        
        const overallProgress = topicProgresses.reduce((acc, val) => acc + val, 0) / (topicProgresses.length || 1);
        const progressPercent = Math.max(0, Math.min(100, Math.round(overallProgress * 100)));
        
        // Calculate topics completed
        const topicsCompleted = topicProgresses.filter(p => p >= 0.9).length;
        const totalTopics = responseData.topics.length;
        
        // Calculate performance (average of all topic progress)
        const performance = Math.round(overallProgress * 100);
        
        const row = document.createElement('tr');
        row.style.cursor = 'pointer';
        row.onclick = () => showStudentDetails(learner.id);
        
        row.innerHTML = `
            <td class="border-0 py-1 text-center">
                <div class="d-flex align-items-center justify-content-center">
                    <div class="bg-info rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 24px; height: 24px;">
                        <i class="fas fa-user text-white" style="font-size: 0.7rem;"></i>
                    </div>
                    <div class="fw-bold" style="font-size: 0.9rem;">${learner.id}</div>
                </div>
            </td>
            <td class="border-0 py-1 text-center">
                <div class="d-flex flex-column align-items-center">
                    <div class="fw-bold fs-6 mb-1">${progressPercent}%</div>
                    <div class="progress" style="width: 80px; height: 4px; border-radius: 2px;">
                        <div class="progress-bar" role="progressbar" style="width: ${progressPercent}%; ${Object.entries(getProgressBarStyle(progressPercent)).map(([key, value]) => `${key.replace(/([A-Z])/g, '-$1').toLowerCase()}: ${value}`).join('; ')}"></div>
                    </div>
                </div>
            </td>
            <td class="border-0 py-1 text-center">
                <div class="d-flex flex-column align-items-center">
                    <div class="fw-bold fs-6 mb-1">${topicsCompleted}/${totalTopics}</div>
                    <div class="text-muted" style="font-size: 0.7rem;">Topics</div>
                </div>
            </td>
            <td class="border-0 py-1 text-center">
                <div class="d-flex flex-column align-items-center">
                    <i class="fas fa-chart-line text-primary mb-1" style="font-size: 1rem;"></i>
                    <div class="text-muted" style="font-size: 0.7rem;">Analytics</div>
                </div>
            </td>
        `;
        
        tableBody.appendChild(row);
    });
}

function getTopicProgress(data, topicId) {
    if (!data?.state?.topics?.[topicId]) return 0;
    
    // Try overall progress first
    if (data.state.topics[topicId].overall?.p !== undefined) {
        return data.state.topics[topicId].overall.p;
    }
    
    // For class average, try to calculate from individual resources
    const topicData = data.state.topics[topicId];
    if (topicData.values) {
        const resourceValues = Object.values(topicData.values);
        if (resourceValues.length > 0) {
            const totalProgress = resourceValues.reduce((sum, resource) => sum + (resource.p || 0), 0);
            return totalProgress / resourceValues.length;
        }
    }
    
    return 0;
}

function calculateComparativeData() {
    // Get my progress data
    const myData = responseData.learners.find(learner => learner.id === responseData.context.learnerId);
    const classData = responseData.groups.find(group => group.name === 'Class Average');
    
    if (!myData || !classData) return null;
    
    // Create comparative data structure
    const comparativeData = {
        state: {
            topics: {}
        }
    };
    
    // Calculate differences for each topic
    responseData.topics.forEach(topic => {
        const myTopic = myData.state.topics[topic.id];
        const classTopic = classData.state.topics[topic.id];
        
        if (myTopic && classTopic) {
            comparativeData.state.topics[topic.id] = {
                values: {}
            };
            
            // Calculate differences for each resource
            responseData.resources.forEach(resource => {
                const myValue = myTopic.values?.[resource.id]?.p || 0;
                const classValue = classTopic.values?.[resource.id]?.p || 0;
                const difference = myValue - classValue; // Positive = ahead, Negative = behind
                
                comparativeData.state.topics[topic.id].values[resource.id] = {
                    p: difference
                };
            });
            
            // Calculate overall topic difference
            const myOverall = myTopic.overall?.p || 0;
            const classOverall = classTopic.overall?.p || 0;
            const overallDifference = myOverall - classOverall;
            
            comparativeData.state.topics[topic.id].overall = {
                p: overallDifference
            };
        }
    });
    
    return comparativeData;
}

function getCellValue(data, topicId, resourceId) {
    if (!data?.state?.topics?.[topicId]?.values?.[resourceId]) return 0;
    return data.state.topics[topicId].values[resourceId].p || 0;
}

function getTextColor(value) {
    // Handle comparative view (can be negative or positive)
    if (currentViewMode === 'comparative') {
        // Determine if we're in dark mode using the same logic as base.html
        const userPrefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        const savedTheme = localStorage.getItem('theme');
        const isDarkMode = savedTheme ? savedTheme === 'dark' : userPrefersDark;
        if (value === 0) {
            return '#6c757d'; // Bootstrap secondary color for neutral
        } else if (value > 0) {
            // Positive difference (ahead of class) - use green
            const intensity = Math.min(Math.abs(value), 1); // Cap at 1        
            if (isDarkMode) {
                // Green shade, with white base, for dark mode
                const r = Math.round(40 + (255 - 40) * (1 - intensity));
                const g = Math.round(167 + (255 - 167) * (1 - intensity));
                const b = Math.round(69 + (255 - 69) * (1 - intensity));
                return `rgb(${r}, ${g}, ${b})`;
            } else {
                // Green shade, with black base, for light mode
                const r = Math.round(40 * intensity);
                const g = Math.round(167 * intensity);
                const b = Math.round(69 * intensity);
                return `rgb(${r}, ${g}, ${b})`;
            }
        } else {
            // Negative difference (behind class) - use red
            const intensity = Math.min(Math.abs(value), 1); // Cap at 1
            if (isDarkMode) {
                // Red shade, with white base, for dark mode
                const r = Math.round(220 + (255 - 220) * (1 - intensity));
                const g = Math.round(53 + (255 - 53) * (1 - intensity));
                const b = Math.round(69 + (255 - 69) * (1 - intensity));
                return `rgb(${r}, ${g}, ${b})`;
            } else {
                // Red shade, with black base, for light mode
                const r = Math.round(220 * intensity);
                const g = Math.round(53 * intensity);
                const b = Math.round(69 * intensity);
                return `rgb(${r}, ${g}, ${b})`;
            }
        }
    }
    
    // Regular progress view
    const percent = Math.round(value * 100);
    
    // Return secondary color for 0%
    if (percent === 0) {
        return '#6c757d'; // Bootstrap secondary color
    }
    
    if (percent <= 50) {
        // Linear interpolation from Bootstrap danger to warning
        const ratio = percent / 50;
        // Bootstrap danger: #dc3545 (220, 53, 69) to warning: #ffc107 (255, 193, 7)
        const r = Math.round(220 + (255 - 220) * ratio);
        const g = Math.round(53 + (193 - 53) * ratio);
        const b = Math.round(69 + (7 - 69) * ratio);
        
        return `rgb(${r}, ${g}, ${b})`;
    } else {
        // Linear interpolation from warning to success
        const ratio = (percent - 50) / 50;
        // Warning: #ffc107 (255, 193, 7) to success: #28a745 (40, 167, 69)
        const r = Math.round(255 + (40 - 255) * ratio);
        const g = Math.round(193 + (167 - 193) * ratio);
        const b = Math.round(7 + (69 - 7) * ratio);
        
        return `rgb(${r}, ${g}, ${b})`;
    }
}

function getCellStyle(value) {
    // Keep this function for backward compatibility but return neutral styles
    return {
        backgroundColor: 'transparent',
        borderColor: '#dee2e6',
        color: getTextColor(value)
    };
}

function getProgressBarStyle(percent) {
    // Use the same three-point gradient logic for progress bars
    const value = percent / 100;
    const color = getTextColor(value);
    
    // For 0%, use default Bootstrap styling
    if (percent === 0) {
        return {
            backgroundColor: '#6c757d' // Bootstrap secondary color
        };
    }
    
    return {
        backgroundColor: color
    };
}

function getBadgeStyle(percent) {
    // Handle comparative view differently
    if (currentViewMode === 'comparative') {
        const value = percent / 100;
        if (value === 0) {
            return {
                backgroundColor: '#6c757d', // Bootstrap secondary color
                color: '#ffffff'
            };
        } else if (value > 0) {
            // Positive difference - green badge
            return {
                backgroundColor: '#28a745', // Bootstrap success color
                color: '#ffffff'
            };
        } else {
            // Negative difference - red badge
            return {
                backgroundColor: '#dc3545', // Bootstrap danger color
                color: '#ffffff'
            };
        }
    }
    
    // Regular progress view
    const value = percent / 100;
    const color = getTextColor(value);
    
    // For 0%, use default Bootstrap styling
    if (percent === 0) {
        return {
            backgroundColor: '#6c757d', // Bootstrap secondary color
            color: '#ffffff'
        };
    }
    
    return {
        backgroundColor: color,
        color: '#ffffff'
    };
}

function showStudentDetails(learnerId) {
    const learner = responseData.learners.find(l => l.id === learnerId);
    if (!learner) return;

    // Create a modern modal for student details
    const modalHtml = `
        <div class="modal fade" id="studentModal" tabindex="-1">
            <div class="modal-dialog modal-xl">
                <div class="modal-content border-0 shadow-lg">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title">
                            <i class="fas fa-user-graduate me-2"></i>
                            Student Details: ${learner.id}
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body p-4">
                        <div class="row g-4">
                            ${responseData.topics.sort((a,b) => a.order - b.order).map((topic, index) => {
                                const topicData = learner.state.topics[topic.id];
                                const progress = (topicData?.overall?.p || 
                                               topicData?.values?.['Coding Problems']?.p || 
                                               topicData?.p || 
                                               0) * 100;
                                const progressPercent = Math.max(0, Math.min(100, Math.round(progress)));
                                
                                return `
                                    <div class="col-md-6">
                                        <div class="card border-0 shadow-sm h-100">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between align-items-center mb-3">
                                                    <h6 class="card-title mb-0 fw-bold">${topic.name}</h6>
                                                    <span class="badge" style="${Object.entries(getBadgeStyle(progressPercent)).map(([key, value]) => `${key.replace(/([A-Z])/g, '-$1').toLowerCase()}: ${value}`).join('; ')}">${progressPercent}%</span>
                                                </div>
                                                <div class="progress mb-3" style="height: 8px;">
                                                    <div class="progress-bar" style="width: ${progressPercent}%; ${Object.entries(getProgressBarStyle(progressPercent)).map(([key, value]) => `${key.replace(/([A-Z])/g, '-$1').toLowerCase()}: ${value}`).join('; ')}"></div>
                                                </div>
                                                <div class="row g-2">
                                                    ${responseData.resources.map((resource, rIdx) => {
                                                        const resourceProgress = (topicData?.values?.[resource.id]?.p || 0) * 100;
                                                        const resourcePercent = Math.round(resourceProgress);
                                                        const actList = (responseData.topics.find(t => t.id === topic.id)?.activities?.[resource.id]) || [];
                                                        const collapseId = `topic-${topic.id}-res-${resource.id}-${rIdx}`.replace(/[^a-zA-Z0-9_-]/g, '_');
                                                        const activitiesRows = actList.map(activity => {
                                                            const aProg = learner?.state?.activities?.[topic.id]?.[resource.id]?.[activity.id]?.values?.p || 0;
                                                            const aPerf = learner?.state?.activities?.[topic.id]?.[resource.id]?.[activity.id]?.values?.k;
                                                            const aPct = Math.round(aProg * 100);
                                                            const status = aPct >= 90 ? 'Completed' : (aPct > 0 ? 'In Progress' : 'Not Started');
                                                            const linkHtml = activity.url ? `<a href="${activity.url}" target="_blank" rel="noopener">Open</a>` : '-';
                                                        return `
                                                                <tr>
                                                                    <td class="text-break">${activity.name || activity.id}</td>
                                                                    <td class="text-center">
                            <div class="progress" style="width: 100px; height: 14px; margin: 0 auto;">
                                                                            <div class="progress-bar" style="width: ${aPct}%; ${Object.entries(getProgressBarStyle(aPct)).map(([k,v]) => `${k.replace(/([A-Z])/g,'-$1').toLowerCase()}: ${v}`).join('; ')}"></div>
                                                                        </div>
                                                                    </td>
                                                                    <td class="text-center fw-semibold">${aPct}%</td>
                                                                    <td class="text-center">
                                                                        ${status === 'Completed' ? '<span class="badge bg-success">Completed</span>' : status === 'In Progress' ? '<span class="badge bg-secondary">In Progress</span>' : '<span class="badge bg-light text-dark">Not Started</span>'}
                                                                    </td>
                                                                    
                                                                    
                                                                </tr>`;
                                                        }).join('');
                                                        return `
                                                            <div class="col-12">
                                                                <div class="d-flex justify-content-between align-items-center">
                                                                    <div class="d-flex align-items-center gap-2">
                                                                        <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#${collapseId}" aria-expanded="false" aria-controls="${collapseId}">
                                                                            <i class="fas fa-chevron-down"></i>
                                                                        </button>
                                                                    <small class="text-muted">${resource.name}</small>
                                                                    </div>
                                                                    <small class="fw-semibold">${resourcePercent}%</small>
                                                                </div>
                                                                <div class="progress mt-1" style="height: 4px;">
                                                                    <div class="progress-bar" style="width: ${resourcePercent}%; ${Object.entries(getProgressBarStyle(resourcePercent)).map(([key, value]) => `${key.replace(/([A-Z])/g, '-$1').toLowerCase()}: ${value}`).join('; ')}"></div>
                                                                </div>
                                                                <div class="collapse mt-2" id="${collapseId}">
                                                                    ${actList.length ? `
                                                                    <div class="table-responsive">
                                                                        <table class="table table-sm align-middle mb-0">
                                                                            <thead>
                                                                                <tr>
                                                                                    <th>Activity</th>
                                                                                    <th class="text-center">Progress</th>
                                                                                    <th class="text-center">%</th>
                                                                                    <th class="text-center">Status</th>
                                                                                </tr>
                                                                            </thead>
                                                                            <tbody>
                                                                                ${activitiesRows}
                                                                            </tbody>
                                                                        </table>
                                                                    </div>` : '<div class="text-muted">No activities listed for this resource.</div>'}
                                                                </div>
                                                            </div>
                                                        `;
                                                    }).join('')}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if any
    const existingModal = document.getElementById('studentModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add new modal to body
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('studentModal'));
    modal.show();
}

function handleCellClick(topicId, resourceId, topicName, resourceName) {
    
    // Get class average data for this topic/resource
    const classAvgData = responseData.groups.find(g => g.name === 'Class Average');
    const classProgress = classAvgData?.state?.topics?.[topicId]?.values?.[resourceId]?.p || 0;
    const classProgressPercent = Math.round(classProgress * 100);
    
    // Get individual student data for this topic/resource
    const studentData = responseData.learners.map(learner => {
        const progress = learner.state.topics?.[topicId]?.values?.[resourceId]?.p || 0;
        const progressPercent = Math.round(progress * 100);
        return {
            id: learner.id,
            progress: progress,
            progressPercent: progressPercent,
            isAboveAverage: progress > classProgress,
            isStruggling: classProgress > 0 && progress < (classProgress * 0.5)
        };
    }).sort((a, b) => b.progress - a.progress); // Sort by progress (highest first)
    
    // Calculate statistics
    const totalStudents = studentData.length;
    const studentsAboveAverage = studentData.filter(s => s.isAboveAverage).length;
    const studentsStruggling = studentData.filter(s => s.isStruggling).length;
    const studentsCompleted = studentData.filter(s => s.progressPercent >= 90).length;
    const averageProgress = studentData.reduce((sum, s) => sum + s.progress, 0) / totalStudents;
    const averageProgressPercent = Math.round(averageProgress * 100);
    
    // Prepare activity definitions for this topic/resource
    const topicDef = responseData.topics.find(t => t.id === topicId);
    const activitiesList = topicDef?.activities?.[resourceId] || [];

    // Create comprehensive modal
    const modalHtml = `
        <div class="modal fade" id="cellModal" tabindex="-1">
            <div class="modal-dialog modal-xl">
                <div class="modal-content border-0 shadow-lg">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title">
                            <i class="fas fa-chart-bar me-2"></i>
                            ${topicName}  ${resourceName}
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body p-4">
                        <!-- Overview Cards -->
                        <div class="row g-3 mb-4">
                            <div class="col-md-3">
                                <div class="card border-0 shadow-sm h-100">
                                    <div class="card-body text-center">
                                        <div class="bg-primary rounded-circle d-inline-flex align-items-center justify-content-center mb-2" style="width: 40px; height: 40px;">
                                            <i class="fas fa-percentage text-white"></i>
                                        </div>
                                        <h6 class="fw-bold mb-1">Class Average</h6>
                                        <div class="h4 fw-bold text-primary">${classProgressPercent}%</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card border-0 shadow-sm h-100">
                                    <div class="card-body text-center">
                                        <div class="bg-success rounded-circle d-inline-flex align-items-center justify-content-center mb-2" style="width: 40px; height: 40px;">
                                            <i class="fas fa-check-circle text-white"></i>
                                        </div>
                                        <h6 class="fw-bold mb-1">Completed</h6>
                                        <div class="h4 fw-bold text-success">${studentsCompleted}</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card border-0 shadow-sm h-100">
                                    <div class="card-body text-center">
                                        <div class="bg-warning rounded-circle d-inline-flex align-items-center justify-content-center mb-2" style="width: 40px; height: 40px;">
                                            <i class="fas fa-exclamation-triangle text-white"></i>
                                        </div>
                                        <h6 class="fw-bold mb-1">Struggling</h6>
                                        <div class="h4 fw-bold text-warning">${studentsStruggling}</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card border-0 shadow-sm h-100">
                                    <div class="card-body text-center">
                                        <div class="bg-info rounded-circle d-inline-flex align-items-center justify-content-center mb-2" style="width: 40px; height: 40px;">
                                            <i class="fas fa-users text-white"></i>
                                        </div>
                                        <h6 class="fw-bold mb-1">Above Average</h6>
                                        <div class="h4 fw-bold text-info">${studentsAboveAverage}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Student Progress Breakdown (with expandable activity rows) -->
                        <div class="row">
                            <div class="col-12">
                                <h6 class="fw-bold mb-3">
                                    <i class="fas fa-list me-2"></i>Student Progress Breakdown
                                </h6>
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th class="fw-bold">Student</th>
                                                <th class="fw-bold text-center">Progress</th>
                                                <th class="fw-bold text-center">Status</th>
                                                <th class="fw-bold text-center">vs Class Avg</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${(() => {
                                                const learnerById = Object.fromEntries(responseData.learners.map(l => [l.id, l]));
                                                return studentData.map((student, idx) => {
                                                    const safeId = String(student.id).replace(/[^a-zA-Z0-9_-]/g, '') + '-' + idx;
                                                    const learner = learnerById[student.id];
                                                    const activityRows = activitiesList.map(activity => {
                                                        const aProg = learner?.state?.activities?.[topicId]?.[resourceId]?.[activity.id]?.values?.p || 0;
                                                        const aPerf = learner?.state?.activities?.[topicId]?.[resourceId]?.[activity.id]?.values?.k;
                                                        const aPct = Math.round(aProg * 100);
                                                        const status = aPct >= 90 ? 'Completed' : (aPct > 0 ? 'In Progress' : 'Not Started');
                                                        const linkHtml = activity.url ? `<a href="${activity.url}" target="_blank" rel="noopener">Open</a>` : '-';
                                                        return `
                                                            <tr>
                                                                <td class="text-break">${activity.name || activity.id}</td>
                                                                <td class="text-center">
                                                                    <div class="progress" style="width: 100px; height: 14px;">
                                                                        <div class="progress-bar" style="width: ${aPct}%; ${Object.entries(getProgressBarStyle(aPct)).map(([k,v]) => `${k.replace(/([A-Z])/g,'-$1').toLowerCase()}: ${v}`).join('; ')}"></div>
                                                                    </div>
                                                                </td>
                                                                <td class="text-center fw-semibold">${aPct}%</td>
                                                                <td class="text-center">
                                                                    ${status === 'Completed' ? '<span class="badge bg-success">Completed</span>' : status === 'In Progress' ? '<span class="badge bg-secondary">In Progress</span>' : '<span class="badge bg-light text-dark">Not Started</span>'}
                                                                </td>
                                                                    
                                                                    
                                                            </tr>`;
                                                    }).join('');
                                                    return `
                                                        <tr class="${student.isStruggling ? 'table-warning' : student.isAboveAverage ? 'table-success' : ''}">
                                                            <td class="fw-bold">
                                                                <button class="btn btn-sm btn-outline-secondary me-2" type="button" data-bs-toggle="collapse" data-bs-target="#act-${safeId}" aria-expanded="false" aria-controls="act-${safeId}">
                                                                    <i class="fas fa-chevron-down"></i>
                                                                </button>
                                                                ${student.id}
                                                            </td>
                                                            <td class="text-center">
                                                                <div class="d-flex align-items-center justify-content-center">
                                                                    <div class="progress me-2" style="width: 100px; height: 20px;">
                                                                        <div class="progress-bar" style="width: ${student.progressPercent}%; background-color: ${getTextColor(student.progress)};"></div>
                                                                    </div>
                                                                    <span class="fw-bold">${student.progressPercent}%</span>
                                                                </div>
                                                            </td>
                                                            <td class="text-center">
                                                                ${student.progressPercent >= 90 ? '<span class="badge bg-success">Completed</span>' : 
                                                                  student.isStruggling ? '<span class="badge bg-warning">Struggling</span>' : 
                                                                  '<span class="badge bg-secondary">In Progress</span>'}
                                                            </td>
                                                            <td class="text-center">
                                                                ${student.isAboveAverage ? 
                                                                    `<span class="text-success fw-bold">+${student.progressPercent - classProgressPercent}%</span>` :
                                                                    student.progress > 0 ? 
                                                                        `<span class="text-danger fw-bold">${student.progressPercent - classProgressPercent}%</span>` :
                                                                        '<span class="text-muted">-</span>'
                                                                }
                                                            </td>
                                                        </tr>
                                                        <tr class="collapse bg-light" id="act-${safeId}">
                                                            <td colspan="4">
                                                                ${activitiesList.length ? `
                                                                <div class="table-responsive">
                                                                    <table class="table table-sm align-middle mb-0">
                                                                        <thead>
                                                                            <tr>
                                                                                <th>Activity</th>
                                                                                <th class="text-center">Progress</th>
                                                                                <th class="text-center">%</th>
                                                                                <th class="text-center">Status</th>
                                                                            </tr>
                                                                        </thead>
                                                                        <tbody>
                                                                            ${activityRows}
                                                                        </tbody>
                                                                    </table>
                                                                </div>` : '<div class="text-muted">No activities listed for this resource.</div>'}
                                                            </td>
                                                        </tr>`;
                                                }).join('');
                                            })()}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if any
    const existingModal = document.getElementById('cellModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add new modal to body
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('cellModal'));
    modal.show();
}

function showError(message) {
    // Create a modern toast notification
    const toastHtml = `
        <div class="toast align-items-center text-white bg-danger border-0" role="alert" aria-live="assertive" aria-atomic="true" style="position: fixed; top: 20px; right: 20px; z-index: 9999;">
            <div class="d-flex">
                <div class="toast-body">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', toastHtml);
    const toast = new bootstrap.Toast(document.querySelector('.toast'));
    toast.show();
    
    // Remove toast after it's hidden
    setTimeout(() => {
        const toastElement = document.querySelector('.toast');
        if (toastElement) {
            toastElement.remove();
        }
    }, 5000);
}
</script>

