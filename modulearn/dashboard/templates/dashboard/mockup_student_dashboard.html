{% extends 'base.html' %}
{% load static %}

{% block title %}Student Progress Dashboard - ModuLearn{% endblock %}

{% block content %}
<div class="py-4">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm border-0">
                <div class="card-body">
                                         <div class="d-flex align-items-center mb-3">
                         <div class="bg-primary rounded-circle p-3 me-3">
                             <i class="fas fa-chart-bar text-white fs-4"></i>
                         </div>
                         <div>
                             <h1 class="h2 mb-1 fw-bold">Student Progress Dashboard</h1>
                             <p class="text-muted mb-0">Interactive mastery grid with detailed analytics</p>
                         </div>
                     </div>
                    
                    <!-- Configuration Form -->
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label for="usr" class="form-label fw-semibold">User ID</label>
                            <input type="text" class="form-control" id="usr" value="jab464" placeholder="Enter user ID">
                        </div>
                        <div class="col-md-3">
                            <label for="grp" class="form-label fw-semibold">Group ID</label>
                            <input type="text" class="form-control" id="grp" value="CMPINF0401Fall20242" placeholder="Enter group ID">
                        </div>
                        <div class="col-md-3">
                            <label for="sid" class="form-label fw-semibold">Session ID</label>
                            <input type="text" class="form-control" id="sid" value="5A195" placeholder="Enter session ID">
                        </div>
                        <div class="col-md-3">
                            <label for="cid" class="form-label fw-semibold">Course ID</label>
                            <input type="text" class="form-control" id="cid" value="417" placeholder="Enter course ID">
                        </div>
                        <div class="col-md-3">
                            <label for="mod" class="form-label fw-semibold">Module</label>
                            <input type="text" class="form-control" id="mod" value="all" placeholder="Enter module">
                        </div>
                        <div class="col-md-3">
                            <label for="models" class="form-label fw-semibold">Models</label>
                            <input type="text" class="form-control" id="models" value="-1" placeholder="Enter models">
                        </div>
                        <div class="col-md-3">
                            <label for="avgtop" class="form-label fw-semibold">Average Top</label>
                            <input type="text" class="form-control" id="avgtop" value="-1" placeholder="Enter average top">
                        </div>
                        <div class="col-md-3">
                            <label for="removeZero" class="form-label fw-semibold">Remove Zero Progress</label>
                            <select class="form-select" id="removeZero">
                                <option value="true" selected>True</option>
                                <option value="false">False</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="text-center mt-4">
                        <button class="btn btn-primary btn-lg px-4" id="fetchDataBtn" data-api-url="{% url 'dashboard:fetch_analytics_data' %}">
                            <i class="fas fa-chart-bar me-2"></i>
                            <span id="fetchBtnText">Fetch Data</span>
                            <div class="spinner-border spinner-border-sm ms-2 d-none" id="fetchSpinner"></div>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Dashboard Controls -->
    <div class="row mb-4" id="dashboardControls" style="display: none;">
        <div class="col-12">
            <div class="card shadow-sm border-0">
                <div class="card-body">
                    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center">
                                                 <div class="d-flex align-items-center mb-3 mb-md-0">
                             <div class="bg-success rounded-circle p-2 me-3">
                                 <i class="fas fa-graduation-cap text-white"></i>
                             </div>
                             <div>
                                 <h2 class="h4 mb-1 fw-bold">Learning Analytics</h2>
                                 <p class="text-muted mb-0">Mastery grid with detailed progress tracking</p>
                             </div>
                         </div>
                        
                        <div class="d-flex flex-column flex-sm-row gap-3">
                                                         <!-- View Mode Selector -->
                             <div class="btn-group" role="group">
                                 <input type="radio" class="btn-check" name="viewMode" id="myProgress" value="myProgress" checked>
                                 <label class="btn btn-outline-primary fw-semibold" for="myProgress">
                                     <i class="fas fa-user me-1"></i>My Progress
                                 </label>
                                 
                                 <input type="radio" class="btn-check" name="viewMode" id="classAverage" value="classAverage">
                                 <label class="btn btn-outline-primary fw-semibold" for="classAverage">
                                     <i class="fas fa-users me-1"></i>Class Average
                                 </label>
                             </div>

                             <!-- Metric Toggle -->
                             <div class="btn-group" role="group">
                                 <input type="radio" class="btn-check" name="metric" id="progress" value="p" checked>
                                 <label class="btn btn-outline-secondary fw-semibold" for="progress">
                                     <i class="fas fa-percentage me-1"></i>Progress
                                 </label>
                                 
                                 <input type="radio" class="btn-check" name="metric" id="performance" value="k">
                                 <label class="btn btn-outline-secondary fw-semibold" for="performance">
                                     <i class="fas fa-star me-1"></i>Performance
                                 </label>
                             </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mastery Grid -->
    <div class="row" id="masteryGrid" style="display: none;">
        <div class="col-12">
            <div class="card shadow-sm border-0">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0" id="masteryTable">
                                                         <thead>
                                <tr>
                                                                         <th class="border-0 fw-bold" style="min-width: 300px;">
                                         <div class="d-flex align-items-center">
                                             <i class="fas fa-graduation-cap text-primary me-2"></i>
                                             Topics
                                         </div>
                                     </th>
                                    <!-- Resource headers will be dynamically added here -->
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Dynamic content will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Legend -->
    <div class="row mt-4" id="legend" style="display: none;">
        <div class="col-12">
            <div class="card shadow-sm border-0">
                <div class="card-body">
                                         <h6 class="fw-bold mb-3">Legend:</h6>
                    <div class="d-flex flex-wrap gap-4">
                                                 <div class="d-flex align-items-center">
                             <div class="bg-secondary bg-opacity-10 border border-secondary rounded me-2" style="width: 20px; height: 20px;"></div>
                             <span class="text-muted">Not Started (0%)</span>
                         </div>
                         <div class="d-flex align-items-center">
                             <div class="bg-warning bg-opacity-25 border border-warning rounded me-2" style="width: 20px; height: 20px;"></div>
                             <span class="text-muted">In Progress (1-50%)</span>
                         </div>
                         <div class="d-flex align-items-center">
                             <div class="bg-info bg-opacity-25 border border-info rounded me-2" style="width: 20px; height: 20px;"></div>
                             <span class="text-muted">Nearly Complete (51-90%)</span>
                         </div>
                         <div class="d-flex align-items-center">
                             <div class="bg-success bg-opacity-25 border border-success rounded d-flex align-items-center justify-content-center me-2" style="width: 20px; height: 20px;">
                                 <i class="fas fa-check text-success" style="font-size: 10px;"></i>
                             </div>
                             <span class="text-success fw-semibold">Complete (91-100%)</span>
                         </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Activity Details Modal -->
<div class="modal fade" id="activityModal" tabindex="-1" aria-labelledby="activityModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="activityModalLabel">Activity Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="activityModalBody">
                <!-- Dynamic content will be inserted here -->
            </div>
        </div>
    </div>
</div>

<!-- Error Alert -->
<div class="alert alert-danger alert-dismissible fade" id="errorAlert" role="alert">
    <i class="fas fa-exclamation-triangle me-2"></i>
    <span id="errorMessage"></span>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>

{% endblock %}

{% block extra_js %}
<style>
/* Table styling for dark mode compatibility */
#masteryTable {
    background-color: var(--bs-body-bg);
    color: var(--bs-body-color);
}

#masteryTable thead {
    background-color: var(--bs-secondary-bg);
}

#masteryTable tbody tr {
    background-color: var(--bs-body-bg);
}

#masteryTable tbody tr:nth-child(even) {
    background-color: var(--bs-secondary-bg);
}

/* Remove any hover effects that cause resizing */
#masteryTable td:hover {
    transform: none !important;
    box-shadow: none !important;
}

/* Cell hover effect - only color change, no size change */
#masteryTable td.cursor-pointer:hover {
    filter: brightness(1.1);
}
</style>

<script>
// Global variables
let responseData = null;
let currentViewMode = 'myProgress';
let currentMetric = 'p';

// Initialize dashboard
document.addEventListener('DOMContentLoaded', function() {
    console.log('Dashboard DOMContentLoaded event fired');
    
    // Set up event listeners
    const fetchBtn = document.getElementById('fetchDataBtn');
    if (fetchBtn) {
        console.log('Found fetch button, adding event listener');
        fetchBtn.addEventListener('click', handleFetch);
    } else {
        console.error('Fetch button not found!');
    }
    
    // View mode and metric change listeners
    document.querySelectorAll('input[name="viewMode"]').forEach(radio => {
        radio.addEventListener('change', function() {
            currentViewMode = this.value;
            updateDashboard();
        });
    });
    
    document.querySelectorAll('input[name="metric"]').forEach(radio => {
        radio.addEventListener('change', function() {
            currentMetric = this.value;
            updateDashboard();
        });
    });
    
    console.log('Dashboard initialization complete');
});

function loadSampleData() {
    // Use the sample data from global variable
    responseData = window.sampleData;
    showDashboard();
    updateDashboard();
}

function handleFetch() {
    console.log('handleFetch called!');
    
    const btn = document.getElementById('fetchDataBtn');
    const btnText = document.getElementById('fetchBtnText');
    const spinner = document.getElementById('fetchSpinner');
    
    if (!btn || !btnText || !spinner) {
        console.error('Required elements not found:', { btn: !!btn, btnText: !!btnText, spinner: !!spinner });
        return;
    }
    
    // Show loading state
    btn.disabled = true;
    btnText.textContent = 'Fetching...';
    spinner.classList.remove('d-none');
    
    // Collect form data
    const formData = {
        usr: document.getElementById('usr').value,
        grp: document.getElementById('grp').value,
        sid: document.getElementById('sid').value,
        cid: document.getElementById('cid').value,
        mod: document.getElementById('mod').value,
        models: document.getElementById('models').value,
        avgtop: document.getElementById('avgtop').value,
        removeZeroProgressUsers: document.getElementById('removeZero').value
    };
    
    // Make real API call to our proxy endpoint
    const apiUrl = btn.getAttribute('data-api-url');
    const url = `${apiUrl}?${new URLSearchParams(formData)}`;
    console.log('Making API request to:', url);
    
    fetch(url, {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Content-Type': 'application/json'
        },
        credentials: 'same-origin'
    })
        .then(response => {
            console.log('Response status:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Received data:', data);
            if (data.error) {
                throw new Error(data.error);
            }
            responseData = data;
            showDashboard();
            updateDashboard();
        })
        .catch(error => {
            console.error('Fetch error:', error);
            showError('Failed to fetch data: ' + error.message);
        })
        .finally(() => {
            // Reset button state
            btn.disabled = false;
            btnText.textContent = 'Fetch Data';
            spinner.classList.add('d-none');
        });
}

function showDashboard() {
    document.getElementById('dashboardControls').style.display = 'block';
    document.getElementById('masteryGrid').style.display = 'block';
    document.getElementById('legend').style.display = 'block';
}

function updateDashboard() {
    if (!responseData) return;
    
    // Update table headers with resource names
    const tableHead = document.querySelector('#masteryTable thead tr');
    // Remove existing resource headers (keep the first "Topics" header)
    while (tableHead.children.length > 1) {
        tableHead.removeChild(tableHead.lastChild);
    }
    
    // Add resource headers
    responseData.resources.forEach(resource => {
        const th = document.createElement('th');
                 th.className = 'border-0 fw-bold text-center';
        th.style.minWidth = '120px';
        th.innerHTML = `
            <div class="d-flex flex-column align-items-center">
                <span class="small text-break">${resource.name}</span>
            </div>
        `;
        tableHead.appendChild(th);
    });
    
    const tableBody = document.querySelector('#masteryTable tbody');
    tableBody.innerHTML = '';
    
    // Get current data based on view mode
    const currentData = currentViewMode === 'myProgress' 
        ? responseData.learners.find(learner => learner.id === responseData.context.learnerId)
        : responseData.groups.find(group => group.name === 'Class Average');
    
    if (!currentData) return;
    
    // Sort topics by order
    const sortedTopics = responseData.topics.sort((a, b) => a.order - b.order);
    
            // Create table rows
        sortedTopics.forEach((topic, index) => {
            const row = document.createElement('tr');
            row.className = index % 2 === 0 ? 'table-secondary table-opacity-10' : '';
        
        // Topic progress
        const topicProgress = getTopicProgress(currentData, topic.id);
        
                 // Topic cell
         const topicCell = document.createElement('td');
         topicCell.className = 'border-0';
         topicCell.innerHTML = `
             <div class="d-flex align-items-center">
                 <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 24px; height: 24px;">
                     <span class="text-white fw-bold" style="font-size: 10px;">${topic.order}</span>
                 </div>
                 <div class="fw-bold me-3" style="min-width: 120px;">${topic.name}</div>
                 <div class="progress flex-grow-1 me-2 float-end" style="height: 6px; background-color: rgba(0,0,0,0.1); max-width: 100px;">
                     <div class="progress-bar" role="progressbar" style="width: ${topicProgress * 100}%; background-color: var(--bs-primary);"></div>
                 </div>
                 <span class="fw-semibold" style="min-width: 35px; color: var(--bs-primary); font-size: 0.9em;">${Math.round(topicProgress * 100)}%</span>
             </div>
         `;
        row.appendChild(topicCell);
        
        // Resource cells
        responseData.resources.forEach(resource => {
            const cell = document.createElement('td');
            cell.className = 'text-center border-0';
            
            const value = getCellValue(currentData, topic.id, resource.id);
            const cellClass = getCellClass(value);
            
            cell.className = `text-center border-0 ${cellClass} cursor-pointer`;
            cell.style.cursor = 'pointer';
            cell.style.transition = 'background-color 0.2s ease';
            cell.style.borderRadius = '4px';
            cell.onclick = () => handleCellClick(topic.id, resource.id, topic.name, resource.name);
            
                         cell.innerHTML = `
                 <div class="fw-bold fs-5" style="color: var(--bs-body-color);">${Math.round(value * 100)}%</div>
             `;
            
            row.appendChild(cell);
        });
        
        tableBody.appendChild(row);
    });
}

function getTopicProgress(data, topicId) {
    if (!data?.state?.topics?.[topicId]?.overall) return 0;
    return data.state.topics[topicId].overall[currentMetric] || 0;
}

function getCellValue(data, topicId, resourceId) {
    if (!data?.state?.topics?.[topicId]?.values?.[resourceId]) return 0;
    return data.state.topics[topicId].values[resourceId][currentMetric] || 0;
}

function getCellClass(value) {
    if (value === 0) return 'bg-secondary bg-opacity-10 border border-secondary';
    if (value <= 0.5) return 'bg-warning bg-opacity-25 border border-warning';
    if (value <= 0.9) return 'bg-info bg-opacity-25 border border-info';
    return 'bg-success bg-opacity-25 border border-success text-success fw-bold';
}

function handleCellClick(topicId, resourceId, topicName, resourceName) {
    const currentData = currentViewMode === 'myProgress' 
        ? responseData.learners.find(learner => learner.id === responseData.context.learnerId)
        : responseData.groups.find(group => group.name === 'Class Average');
    
    console.log('Cell clicked:', { topicId, resourceId, topicName, resourceName });
    console.log('Current data:', currentData);
    console.log('Topic data:', responseData.topics.find(t => t.id === topicId));
    console.log('Progress data:', currentData?.state?.topics?.[topicId]?.values?.[resourceId]);
    
    const activities = getCellActivities(currentData, topicId, resourceId);
    console.log('Activities found:', activities);
    
    // Update modal content
    document.getElementById('activityModalLabel').textContent = `Activity Details - ${topicName} → ${resourceName}`;
    
    const modalBody = document.getElementById('activityModalBody');
    if (activities.length > 0) {
        modalBody.innerHTML = `
            <div class="row g-3">
                ${activities.map(activity => `
                    <div class="col-12">
                        <div class="card border-0 shadow-sm">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6 class="card-title mb-0 fw-bold">${activity.name}</h6>
                                    <div class="d-flex align-items-center">
                                        <div class="progress me-3 float-end" style="width: 100px; height: 8px;">
                                            <div class="progress-bar bg-primary" role="progressbar" style="width: ${activity.progress * 100}%"></div>
                                        </div>
                                        <span class="text-muted fw-semibold">${Math.round(activity.progress * 100)}%</span>
                                    </div>
                                </div>
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="badge bg-outline-secondary">ID: ${activity.id}</span>
                                    <a href="${activity.url || '#'}" target="_blank" class="btn btn-primary btn-sm">
                                        <i class="fas fa-external-link-alt me-1"></i>Open Activity
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
    } else {
        modalBody.innerHTML = `
            <div class="text-center py-5">
                <div class="bg-light rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 64px; height: 64px;">
                    <i class="fas fa-info-circle text-muted fs-3"></i>
                </div>
                <p class="text-muted">No activities found for this topic and resource combination.</p>
            </div>
        `;
    }
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('activityModal'));
    modal.show();
}

function getCellActivities(data, topicId, resourceId) {
    // Find the topic
    const topic = responseData.topics.find(t => t.id === topicId);
    if (!topic?.activities?.[resourceId]) return [];
    
    // Get the activities for this topic/resource combination
    const activities = topic.activities[resourceId];
    
    // Get the progress data from the correct nested structure:
    // data.state.activities[topicId][resourceId][activityId].values[currentMetric]
    const activitiesProgressData = data?.state?.activities?.[topicId]?.[resourceId];
    
    return activities.map(activity => {
        let progress = 0;
        
        // Look for progress in the correct nested structure
        if (activitiesProgressData && activitiesProgressData[activity.id]) {
            progress = activitiesProgressData[activity.id].values?.[currentMetric] || 0;
        }
        
        return {
            ...activity,
            progress: progress
        };
    });
}

function showError(message) {
    const alert = document.getElementById('errorAlert');
    const messageSpan = document.getElementById('errorMessage');
    messageSpan.textContent = message;
    alert.classList.add('show');
    
    setTimeout(() => {
        alert.classList.remove('show');
    }, 5000);
}
</script>
{% endblock %}
