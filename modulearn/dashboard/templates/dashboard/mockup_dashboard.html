{% extends 'base.html' %}
{% load static %}

{% block title %}Learning Analytics Dashboard - ModuLearn{% endblock %}

{% block content %}
<div class="container-fluid py-2 py-md-4">

    <!-- Modern Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-lg" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <div class="card-body text-white p-4">
                    <div class="d-flex align-items-center mb-4">
                        <div class="bg-white bg-opacity-20 rounded-circle p-3 me-3">
                            <i class="fas fa-chart-line text-dark fs-3"></i>
                        </div>
                        <div>
                            <h1 class="h2 mb-1 fw-bold">Learning Analytics Dashboard</h1>
                            <p class="mb-0 opacity-75">Advanced mastery tracking with interactive grid visualization</p>
                        </div>
                    </div>
                    
                    <!-- Configuration Form -->
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label for="usr" class="form-label fw-semibold text-white">User ID</label>
                            <input type="text" class="form-control form-control-lg" id="usr" value="jab464" placeholder="Enter user ID">
                        </div>
                        <div class="col-md-3">
                            <label for="grp" class="form-label fw-semibold text-white">Group ID</label>
                            <input type="text" class="form-control form-control-lg" id="grp" value="CMPINF0401Fall20242" placeholder="Enter group ID">
                        </div>
                        <div class="col-md-3">
                            <label for="sid" class="form-label fw-semibold text-white">Session ID</label>
                            <input type="text" class="form-control form-control-lg" id="sid" value="5A195" placeholder="Enter session ID">
                        </div>
                        <div class="col-md-3">
                            <label for="cid" class="form-label fw-semibold text-white">Course ID</label>
                            <input type="text" class="form-control form-control-lg" id="cid" value="417" placeholder="Enter course ID">
                        </div>
                    </div>
                    <div class="text-center mt-4">
                        <button class="btn btn-dark btn-lg px-5 fw-bold" id="fetchDataBtn" data-api-url="{% url 'dashboard:fetch_analytics_data' %}">
                            <i class="fas fa-rocket me-2"></i>
                            <span id="fetchBtnText">Launch Analytics</span>
                            <div class="spinner-border spinner-border-sm ms-2 d-none" id="fetchSpinner"></div>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Dashboard Content Area (Hidden until data is loaded) -->
    <div id="dashboardContent" class="d-none">
        <!-- Modern Analytics Overview -->
        <div class="row mb-4">
        <div class="col-12">
                <div class="card border-0 shadow-lg">
                    <div class="card-body p-4">
                        <div class="d-flex align-items-center mb-4">
                            <div class="bg-gradient-primary rounded-circle p-3 me-3">
                                <i class="fas fa-chart-line fs-4"></i>
                            </div>
                            <div>
                                <h2 id="courseTitle" class="h3 mb-1 fw-bold">Course Analytics</h2>
                                <p class="text-muted mb-0">Interactive mastery grid with real-time progress tracking</p>
                            </div>
                        </div>
                        
                        <!-- KPI Cards Grid -->
                        <div class="row g-4">
                            <div class="col-lg-3 col-md-6">
                                <div class="card border-0 shadow-sm h-100" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                                    <div class="card-body text-white text-center p-4">
                                        <div class="bg-white bg-opacity-20 rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 60px; height: 60px;">
                                            <i class="fas fa-percentage fs-4 text-dark"></i>
                                        </div>
                                        <h6 class="text-white-50 fw-bold mb-2">Overall Progress</h6>
                                        <div class="display-4 fw-bold" id="overallProgress">-</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-3 col-md-6">
                                <div class="card border-0 shadow-sm h-100" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                                    <div class="card-body text-white text-center p-4">
                                        <div class="bg-white bg-opacity-20 rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 60px; height: 60px;">
                                            <i class="fas fa-users fs-4 text-dark"></i>
                                        </div>
                                        <h6 class="text-white-50 fw-bold mb-2">Students</h6>
                                        <div class="display-4 fw-bold" id="studentsEnrolled">-</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-3 col-md-6">
                                <div class="card border-0 shadow-sm h-100" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                                    <div class="card-body text-white text-center p-4">
                                        <div class="bg-white bg-opacity-20 rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 60px; height: 60px;">
                                            <i class="fas fa-book fs-4 text-dark"></i>
                                        </div>
                                        <h6 class="text-white-50 fw-bold mb-2">Topics</h6>
                                        <div class="display-4 fw-bold" id="topicsCovered">-</div>
                             </div>
                             </div>
                         </div>
                            <div class="col-lg-3 col-md-6">
                                <div class="card border-0 shadow-sm h-100" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                                    <div class="card-body text-white text-center p-4">
                                        <div class="bg-white bg-opacity-20 rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 60px; height: 60px;">
                                            <i class="fas fa-fire fs-4 text-dark"></i>
                                        </div>
                                        <h6 class="text-white-50 fw-bold mb-2">Active Topic</h6>
                                        <div class="fw-bold" id="mostActiveTopic" style="font-size: 1.1rem; line-height: 1.2;">-</div>
                                    </div>
                             </div>
                             </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modern Mastery Grid -->
        <div class="row">
            <div class="col-12">
                <div class="card border-0 shadow-lg">
                    <div class="card-header border-0 py-4">
                        <div class="d-flex align-items-center justify-content-between">
                            <div class="d-flex align-items-center">
                                <div class="bg-gradient-primary rounded-circle p-2 me-3">
                                    <i class="fas fa-th"></i>
                                </div>
                                <div>
                                    <h4 class="mb-1 fw-bold" id="viewTitle">Mastery Grid</h4>
                                    <p class="text-muted mb-0" id="viewDescription">Click any cell to view detailed progress</p>
                                </div>
                            </div>
                            <div class="d-flex gap-2">
                                <div class="btn-group" role="group">
                                    <input type="radio" class="btn-check" name="viewMode" id="myProgress" value="myProgress" checked>
                                    <label class="btn btn-outline-secondary" for="myProgress">
                                        <i class="fas fa-user me-1"></i>My Progress
                                    </label>
                                    <input type="radio" class="btn-check" name="viewMode" id="comparative" value="comparative">
                                    <label class="btn btn-outline-warning" for="comparative">
                                        <i class="fas fa-balance-scale me-1"></i>Comparative
                                    </label>
                                    <input type="radio" class="btn-check" name="viewMode" id="classAverage" value="classAverage">
                                    <label class="btn btn-outline-success" for="classAverage">
                                        <i class="fas fa-users me-1"></i>Class Average
                                    </label>
                                    <input type="radio" class="btn-check" name="viewMode" id="perStudent" value="perStudent">
                                    <label class="btn btn-outline-primary" for="perStudent">
                                        <i class="fas fa-list me-1"></i>Per Student
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <!-- Mastery Grid View -->
                        <div class="table-responsive">
                            <table class="table mb-0 custom-table" id="masteryGrid">
                                <thead>
                                    <tr id="gridHeaders">
                                        <th class="border-0 fw-bold py-3 text-center" style="min-width: 300px;">
                                            <div class="d-flex flex-column align-items-center">
                                                <i class="fas fa-graduation-cap text-primary mb-1"></i>
                                                Topics
                                            </div>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="gridBody">
                                    <!-- Dynamic grid content will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Per Student View - Hidden by default, content will be swapped in -->
                        <div id="perStudentContent" style="display: none;">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0 custom-table" id="studentTable">
                                    <thead>
                                        <tr>
                                            <th class="border-0 fw-bold py-3">
                                                <div class="d-flex flex-column align-items-center text-center">
                                                    <i class="fas fa-user-graduate text-primary mb-1"></i>
                                                    Student ID
                                                </div>
                                            </th>
                                            <th class="border-0 fw-bold py-3 text-center">
                                                <div class="d-flex flex-column align-items-center">
                                                    <i class="fas fa-chart-line text-primary mb-1"></i>
                                                    Overall Progress
                                                </div>
                                            </th>
                                            <th class="border-0 fw-bold py-3 text-center">
                                                <div class="d-flex flex-column align-items-center">
                                                    <i class="fas fa-book text-primary mb-1"></i>
                                                    Topics Completed
                                                </div>
                                            </th>
                                            <th class="border-0 fw-bold py-3 text-center">
                                                <div class="d-flex flex-column align-items-center">
                                                    <i class="fas fa-chart-bar text-primary mb-1"></i>
                                                    Analytics
                                                </div>
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody id="studentTableBody">
                                        <!-- Dynamic student rows will be inserted here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Student Details Modal -->
    <div class="modal fade" id="studentDetailModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header bg-primary text-white border-0">
                    <h5 class="modal-title fw-bold" id="studentDetailModalLabel">
                        <i class="fas fa-user-graduate me-2"></i>Student Details
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                         </div>
                <div class="modal-body p-4" id="studentDetailModalBody">
                    <!-- Student-specific breakdown will be inserted here -->
            </div>
        </div>
    </div>
</div>

    <!-- Error Alert -->
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
        <div id="errorAlert" class="toast align-items-center text-white bg-danger border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body" id="errorMessage"></div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
<style>
/* Modern Dashboard Styling */
/* Removed student row hover effects */

.card {
    transition: all 0.3s ease;
    background-color: #ffffff !important;
    border: 1px solid #e9ecef !important;
    color: #212529 !important;
}
.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.1) !important;
}

.progress {
    box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);
    overflow: visible;
    background-color: #e9ecef !important;
}

.progress-bar {
    transition: width 0.6s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: visible;
}

/* Fix toggle buttons - CRITICAL FIX */
.btn-group .btn-check:checked + .btn-outline-primary {
    background-color: #0d6efd !important;
    border-color: #0d6efd !important;
    color: white !important;
}

.btn-outline-primary {
    color: #0d6efd !important;
    border-color: #0d6efd !important;
    background-color: white !important;
    border: 2px solid #0d6efd !important;
    font-weight: 500 !important;
}

.btn-outline-primary:hover {
    background-color: #0d6efd !important;
    border-color: #0d6efd !important;
    color: white !important;
}

.btn-outline-primary:focus {
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25) !important;
}

/* Text colors - let theme control */
.text-primary {
    color: #0d6efd;
}
.text-white {
    color: white;
}
.text-muted {
    color: #6c757d;
}

/* Fix button styling */
.btn {
    background-color: white;
    border: 2px solid #0d6efd;
    color: #0d6efd;
    font-weight: 500;
}

.btn-primary {
    background-color: #0d6efd !important;
    border-color: #0d6efd !important;
    color: white !important;
}

.btn-primary:hover {
    background-color: #0b5ed7 !important;
    border-color: #0a58ca !important;
    color: white !important;
}

/* Card and table styling - let theme control colors */
.card {
    border: 1px solid #dee2e6;
}

.card-header {
    border-bottom: 1px solid #dee2e6;
}

.table th {
    border-bottom: 2px solid #dee2e6;
    font-weight: 600;
}

/* Form controls - let theme control */
.form-control:focus {
    border-color: #86b7fe;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}

.form-label {
    font-weight: 600;
}

/* Override Bootstrap CSS variables for tables */
.table {
    --bs-table-bg: transparent !important;
    --bs-table-color: inherit !important;
    --bs-table-bg-state: transparent !important;
    --bs-table-bg-type: transparent !important;
    --bs-table-accent-bg: transparent !important;
    --bs-table-color-state: inherit !important;
    --bs-table-color-type: inherit !important;
}

/* Force override Bootstrap table styles with higher specificity */
#masteryGrid>:not(caption)>*>*,
#studentTable>:not(caption)>*>* {
    color: inherit !important;
    background-color: transparent !important;
    box-shadow: none !important;
}

/* Target table elements more specifically */
#masteryGrid th,
#masteryGrid td,
#studentTable th,
#studentTable td {
    color: inherit !important;
    background-color: transparent !important;
}

/* Nuclear option - completely override Bootstrap table styles */
.custom-table>:not(caption)>*>* {
    color: inherit !important;
    background-color: transparent !important;
    box-shadow: none !important;
    border-color: inherit !important;
}

.custom-table th,
.custom-table td {
    color: inherit !important;
    background-color: transparent !important;
    border-color: inherit !important;
}

/* Dynamic grid cell styling with three-point gradient */
.progress-cell {
    border: 2px solid;
    font-weight: 600;
    transition: all 0.2s ease;
    position: relative;
    overflow: hidden;
}

/* Hover effect for grid cells - swap text and background colors */
.progress-cell:hover {
    transition: all 0.15s ease;
}

.progress-cell:hover .fw-bold {
    transition: all 0.15s ease;
}

/* Dark mode support for dynamic cells */
@media (prefers-color-scheme: dark) {
    .progress-cell {
        color: #ffffff;
    }
}

.cursor-pointer:hover .fw-bold {
    transform: scale(1.1);
    transition: transform 0.2s ease;
}

/* Dynamic progress styling - colors will be set via JavaScript */

/* Badge styling - improved visibility */
.badge {
    font-size: 0.75em;
    padding: 0.5em 0.75em;
    font-weight: 600;
    border-radius: 0.375rem;
}

/* Grid cell improvements */
.cursor-pointer {
    cursor: pointer !important;
    transition: all 0.2s ease;
}

/* Removed cell swelling hover effect */

/* Text elements - let theme control */
h1, h2, h3, h4, h5, h6 {
    color: #212529;
}

/* Icon improvements */
.fas, .far, .fab {
    color: inherit !important;
}

/* Ensure proper spacing and alignment */
.d-flex {
    align-items: center;
}

/* Improve form styling */
.form-control {
    border-radius: 0.375rem;
    font-weight: 500;
}

.form-control:focus {
    border-color: #86b7fe;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}

/* Table styling improvements */
.table th {
    background-color: #f8f9fa;
    border-bottom: 2px solid #dee2e6;
    font-weight: 600;
}

.table td {
    vertical-align: middle;
}

/* Responsive design */
@media (max-width: 576px) {
    .display-5 {
        font-size: 2rem !important;
    }
    .card-body {
        padding: 1rem !important;
    }
    .table th, .table td {
        padding: 0.75rem 0.5rem;
        font-size: 0.9rem;
    }
}

@media (max-width: 768px) {
    .container-fluid {
        padding-left: 1rem;
        padding-right: 1rem;
    }
}

.fade-in {
    animation: fadeIn 0.5s ease-in;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Gradient backgrounds for better visual appeal */
.bg-gradient-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
}

.bg-gradient-info {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%) !important;
}

/* Enhanced button styling - improved visibility */
.btn-group .btn {
    border-radius: 0.375rem;
    font-weight: 600;
    transition: all 0.2s ease;
}

.btn-group .btn:first-child {
    border-top-right-radius: 0;
    border-bottom-right-radius: 0;
}

.btn-group .btn:last-child {
    border-top-left-radius: 0;
    border-bottom-left-radius: 0;
}

.btn-group .btn:not(:first-child):not(:last-child) {
    border-radius: 0;
}

/* Ensure button group visibility */
.btn-group .btn-check:checked + .btn-outline-primary {
    background-color: #0d6efd !important;
    border-color: #0d6efd !important;
    color: white !important;
    font-weight: 600 !important;
}

.btn-group .btn-outline-primary {
    color: #0d6efd !important;
    border-color: #0d6efd !important;
    background-color: white !important;
    font-weight: 600 !important;
}

.btn-group .btn-outline-primary:hover {
    background-color: #0d6efd !important;
    border-color: #0d6efd !important;
    color: white !important;
}

/* Modal enhancements */
.modal-content {
    border-radius: 0.75rem;
}

.modal-header {
    border-radius: 0.75rem 0.75rem 0 0;
}

/* Remove rounded corners for modern look */
.progress {
    border-radius: 0;
}

.progress-bar {
    border-radius: 0;
}

.card {
    border-radius: 0;
}

.btn {
    border-radius: 0;
}

.modal-content {
    border-radius: 0;
}

.modal-header {
    border-radius: 0;
}

/* Card hover effects */
.card:hover {
    box-shadow: 0 8px 25px rgba(0,0,0,0.1) !important;
}

/* Table row hover effects */
/* Removed table row hover effect */

/* Dark mode support for overall theme - improved contrast */
@media (prefers-color-scheme: dark) {
    /* Body and main backgrounds */
    body {
        background-color: #1a202c !important;
        color: #e2e8f0 !important;
    }
    
    /* Cards */
    .card {
        background-color: #2d3748 !important;
        border-color: #4a5568 !important;
        color: #e2e8f0 !important;
    }
    
    .card-header {
        background-color: #4a5568 !important;
        border-color: #718096 !important;
        color: #e2e8f0 !important;
    }
    
    /* Tables */
    .table {
        background-color: #2d3748 !important;
        color: #e2e8f0 !important;
    }
    
    .table th {
        background-color: #4a5568 !important;
        border-color: #718096 !important;
        color: #e2e8f0 !important;
    }
    
    .table td {
        background-color: #2d3748 !important;
        border-color: #4a5568 !important;
        color: #e2e8f0 !important;
    }
    
    .table tbody tr:hover {
        background-color: rgba(66, 153, 225, 0.1) !important;
    }
    
    /* Modals */
    .modal-content {
        background-color: #2d3748 !important;
        color: #e2e8f0 !important;
    }
    
    .modal-header {
        background-color: #4a5568 !important;
        border-color: #718096 !important;
        color: #e2e8f0 !important;
    }
    
    .modal-body {
        background-color: #2d3748 !important;
        color: #e2e8f0 !important;
    }
    
    /* Form elements */
    .form-control {
        background-color: #4a5568 !important;
        border-color: #718096 !important;
        color: #e2e8f0 !important;
    }
    
    .form-control:focus {
        background-color: #4a5568 !important;
        border-color: #63b3ed !important;
        color: #e2e8f0 !important;
        box-shadow: 0 0 0 0.25rem rgba(99, 179, 237, 0.25) !important;
    }
    
    .form-label {
        color: #e2e8f0 !important;
    }
    
    /* Progress bars */
    .progress {
        background-color: #4a5568 !important;
    }
    
    /* Badges */
    .badge {
        color: white !important;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('fetchDataBtn').addEventListener('click', handleFetch);
    
    // View mode change listeners
    document.querySelectorAll('input[name="viewMode"]').forEach(radio => {
        radio.addEventListener('change', function() {
            currentViewMode = this.value;
            updateGrid();
            
            // Update all radio buttons to reflect the current selection
            document.querySelectorAll('input[name="viewMode"]').forEach(r => {
                r.checked = (r.value === currentViewMode);
            });
        });
    });
    
    // Initialize button states on page load
    updateButtonStates();
});

let responseData = null;
let currentViewMode = 'myProgress';

function updateButtonStates() {
    // Update all radio buttons to reflect the current selection
    document.querySelectorAll('input[name="viewMode"]').forEach(r => {
        r.checked = (r.value === currentViewMode);
    });
}

function handleFetch() {
    const btn = document.getElementById('fetchDataBtn');
    const btnText = document.getElementById('fetchBtnText');
    const spinner = document.getElementById('fetchSpinner');
    
    btn.disabled = true;
    btnText.textContent = 'Loading...';
    spinner.classList.remove('d-none');
    
    const params = {
        usr: document.getElementById('usr').value,
        grp: document.getElementById('grp').value,
        sid: document.getElementById('sid').value,
        cid: document.getElementById('cid').value,
        mod: 'all',
        models: '-1',
        avgtop: '-1',
        removeZeroProgressUsers: 'true'
    };
    
    const apiUrl = btn.getAttribute('data-api-url');
    const url = `${apiUrl}?${new URLSearchParams(params)}`;

    fetch(url)
        .then(response => {
            if (!response.ok) throw new Error(`API Error: ${response.statusText}`);
            return response.json();
        })
        .then(data => {
            if (data.error) throw new Error(data.error);
            responseData = data;
            const dashboardContent = document.getElementById('dashboardContent');
            dashboardContent.classList.remove('d-none');
            dashboardContent.classList.add('fade-in');
            renderDashboard();
        })
        .catch(error => {
            console.error('Fetch error:', error);
            showError(`Failed to load data: ${error.message}`);
        })
        .finally(() => {
            btn.disabled = false;
            btnText.textContent = 'Launch Analytics';
            spinner.classList.add('d-none');
        });
}

function renderDashboard() {
    if (!responseData) return;
    
    populateKPIs();
    updateGrid();
}

function populateKPIs() {
    const classAvgData = responseData.groups.find(g => g.name === 'Class Average');
    if (!classAvgData) return;

    // Course Title
    document.getElementById('courseTitle').textContent = responseData.context.group.name;

    // Overall Progress
    const topicProgresses = responseData.topics.map(topic => classAvgData.state.topics[topic.id]?.values['Coding Problems']?.p || 0);
    const overallProgress = topicProgresses.reduce((acc, val) => acc + val, 0) / (topicProgresses.length || 1);
    const overallProgressPercent = Math.round(overallProgress * 100);
    document.getElementById('overallProgress').textContent = `${overallProgressPercent}%`;

    // Students Enrolled
    document.getElementById('studentsEnrolled').textContent = responseData.learners.length;

    // Topics Covered
    const topicsCovered = responseData.topics.filter(topic => (classAvgData.state.topics[topic.id]?.values['Coding Problems']?.p || 0) > 0).length;
    document.getElementById('topicsCovered').textContent = `${topicsCovered} / ${responseData.topics.length}`;

    // Most Active Topic
    let mostActiveTopic = null;
    let highestProgress = 0;
    responseData.topics.forEach(topic => {
        const progress = classAvgData.state.topics[topic.id]?.values['Coding Problems']?.p || 0;
        if (progress > highestProgress) {
            highestProgress = progress;
            mostActiveTopic = topic;
        }
    });
    
    if (mostActiveTopic) {
        const progressPercent = Math.round(highestProgress * 100);
        let displayName = mostActiveTopic.name;
        if (displayName.length > 25) {
            displayName = displayName.substring(0, 22) + '...';
        }
        document.getElementById('mostActiveTopic').innerHTML = `${displayName}<br><small class="text-white-50">${progressPercent}%</small>`;
    } else {
        document.getElementById('mostActiveTopic').textContent = 'No activity yet';
    }
}

function updateGrid() {
    if (!responseData) return;
    
    // Update button states
    updateButtonStates();
    
    // Update title and description based on current view
    updateViewHeader();
    
    // Get the content containers
    const masteryGrid = document.getElementById('masteryGrid').closest('.table-responsive');
    const perStudentContent = document.getElementById('perStudentContent');
    
    if (currentViewMode === 'perStudent') {
        // Hide mastery grid and show per student content
        masteryGrid.style.display = 'none';
        perStudentContent.style.display = 'block';
        updatePerStudentView();
    } else {
        // Show mastery grid and hide per student content
        masteryGrid.style.display = 'block';
        perStudentContent.style.display = 'none';
        updateMasteryGrid();
    }
}

function updateViewHeader() {
    const titleElement = document.getElementById('viewTitle');
    const descriptionElement = document.getElementById('viewDescription');
    
    if (!titleElement || !descriptionElement) return;
    
    switch (currentViewMode) {
        case 'myProgress':
            titleElement.textContent = 'My Progress';
            descriptionElement.textContent = 'Your individual progress across all topics';
            break;
        case 'comparative':
            titleElement.textContent = 'Comparative View';
            descriptionElement.textContent = 'Your progress compared to class average';
            break;
        case 'classAverage':
            titleElement.textContent = 'Class Average';
            descriptionElement.textContent = 'Average class progress across all topics';
            break;
        case 'perStudent':
            titleElement.textContent = 'Student Progress Overview';
            descriptionElement.textContent = 'Individual student progress tracking';
            break;
    }
}

function updateMasteryGrid() {
    // Update grid headers
    const gridHeaders = document.getElementById('gridHeaders');
    while (gridHeaders.children.length > 1) {
        gridHeaders.removeChild(gridHeaders.lastChild);
    }
    
    // Add resource headers
    responseData.resources.forEach(resource => {
        const th = document.createElement('th');
        th.className = 'border-0 fw-bold text-center py-3';
        th.style.minWidth = '120px';
        th.innerHTML = `
            <div class="d-flex flex-column align-items-center">
                <i class="fas fa-tasks text-primary mb-1"></i>
                <span class="small text-break">${resource.name}</span>
            </div>
        `;
        gridHeaders.appendChild(th);
    });
    
    // Update grid body
    const gridBody = document.getElementById('gridBody');
    gridBody.innerHTML = '';
    
    // Get current data based on view mode
    let currentData;
    if (currentViewMode === 'myProgress') {
        currentData = responseData.learners.find(learner => learner.id === responseData.context.learnerId);
    } else if (currentViewMode === 'comparative') {
        // For comparative view, we'll calculate the difference between my progress and class average
        currentData = calculateComparativeData();
    } else {
        currentData = responseData.groups.find(group => group.name === 'Class Average');
    }
    
    if (!currentData) return;
    
    // Sort topics by order
    const sortedTopics = responseData.topics.sort((a, b) => a.order - b.order);
    
    // Create grid rows
    sortedTopics.forEach((topic, index) => {
        const row = document.createElement('tr');
        
        // Topic cell with gradient styling
        const topicProgress = getTopicProgress(currentData, topic.id);
        const progressPercent = Math.round(topicProgress * 100);
        const progressColor = getTextColor(topicProgress);
        const progressBarStyle = getProgressBarStyle(progressPercent);
        
        const topicCell = document.createElement('td');
        topicCell.className = 'border-0 py-3';
        topicCell.innerHTML = `
            <div class="d-flex align-items-center">
                <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 32px; height: 32px;">
                    <span class="text-white fw-bold small">${topic.order}</span>
                </div>
                <div class="flex-grow-1">
                    <div class="fw-bold mb-1">${topic.name}</div>
                    <div class="progress" style="height: 6px; background-color: rgba(0,0,0,0.1);">
                        <div class="progress-bar" role="progressbar" style="width: ${progressPercent}%; ${Object.entries(progressBarStyle).map(([key, value]) => `${key.replace(/([A-Z])/g, '-$1').toLowerCase()}: ${value}`).join('; ')}"></div>
                    </div>
                </div>
                <div class="ms-3">
                    <span class="badge fw-bold" style="${Object.entries(getBadgeStyle(progressPercent)).map(([key, value]) => `${key.replace(/([A-Z])/g, '-$1').toLowerCase()}: ${value}`).join('; ')}; min-width: 50px; text-align: center;">${progressPercent}%</span>
                </div>
            </div>
        `;
        row.appendChild(topicCell);
        
        // Resource cells with text gradient styling
        responseData.resources.forEach(resource => {
            const cell = document.createElement('td');
            const value = getCellValue(currentData, topic.id, resource.id);
            const textColor = getTextColor(value);
            
            cell.className = 'text-center border-0 py-3 progress-cell cursor-pointer';
            cell.style.cursor = 'pointer';
            cell.style.borderRadius = '0';
            cell.onclick = () => handleCellClick(topic.id, resource.id, topic.name, resource.name);
            
            // Store original colors for hover effect
            cell.dataset.originalTextColor = textColor;
            cell.dataset.originalBgColor = 'transparent';
            
            // Format the display value based on view mode
            let displayValue;
            if (currentViewMode === 'comparative') {
                const percentage = Math.round(value * 100);
                displayValue = percentage > 0 ? `+${percentage}%` : `${percentage}%`;
            } else {
                displayValue = `${Math.round(value * 100)}%`;
            }
            
            cell.innerHTML = `
                <div class="d-flex flex-column align-items-center">
                    <div class="fw-bold fs-5" style="color: ${textColor};">${displayValue}</div>
                </div>
            `;
            
            // Add hover event listeners for gentle highlight effect
            cell.addEventListener('mouseenter', function() {
                // Apply gentle background highlight to all cells
                this.style.backgroundColor = 'rgba(0, 0, 0, 0.1)';
                // Keep original text color but make it slightly darker for contrast
                if (textColor !== 'inherit') {
                    this.querySelector('.fw-bold').style.color = textColor;
                } else {
                    this.querySelector('.fw-bold').style.color = '#6c757d';
                }
            });
            
            cell.addEventListener('mouseleave', function() {
                // Restore original state for all cells
                this.style.backgroundColor = 'transparent';
                this.querySelector('.fw-bold').style.color = textColor;
            });
            
            row.appendChild(cell);
        });
        
        gridBody.appendChild(row);
    });
}

function updatePerStudentView() {
    const tableBody = document.getElementById('studentTableBody');
    tableBody.innerHTML = '';
    
    // Sort learners alphanumerically by ID
    const sortedLearners = responseData.learners
        .filter(learner => !learner.isHidden)
        .sort((a, b) => {
            return a.id.localeCompare(b.id, undefined, { numeric: true, sensitivity: 'base' });
        });

    sortedLearners.forEach((learner, index) => {
        // Calculate overall progress
        const topicProgresses = responseData.topics.map(topic => {
            const topicData = learner.state.topics[topic.id];
            const progress = topicData?.overall?.p || 
                           topicData?.values?.['Coding Problems']?.p || 
                           topicData?.p || 
                           0;
            return progress;
        });
        
        const overallProgress = topicProgresses.reduce((acc, val) => acc + val, 0) / (topicProgresses.length || 1);
        const progressPercent = Math.max(0, Math.min(100, Math.round(overallProgress * 100)));
        
        // Calculate topics completed
        const topicsCompleted = topicProgresses.filter(p => p >= 0.9).length;
        const totalTopics = responseData.topics.length;
        
        // Calculate performance (average of all topic progress)
        const performance = Math.round(overallProgress * 100);
        
        const row = document.createElement('tr');
        row.style.cursor = 'pointer';
        row.onclick = () => showStudentDetails(learner.id);
        
        row.innerHTML = `
            <td class="border-0 py-3">
                <div class="d-flex align-items-center">
                    <div class="bg-info rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 32px; height: 32px;">
                        <i class="fas fa-user text-white"></i>
                    </div>
                    <div class="fw-bold">${learner.id}</div>
                </div>
            </td>
            <td class="border-0 py-3 text-center">
                <div class="d-flex flex-column align-items-center">
                    <div class="fw-bold fs-5 mb-2">${progressPercent}%</div>
                    <div class="progress" style="width: 120px; height: 8px; border-radius: 4px;">
                        <div class="progress-bar" role="progressbar" style="width: ${progressPercent}%; ${Object.entries(getProgressBarStyle(progressPercent)).map(([key, value]) => `${key.replace(/([A-Z])/g, '-$1').toLowerCase()}: ${value}`).join('; ')}"></div>
                    </div>
                </div>
            </td>
            <td class="border-0 py-3 text-center">
                <div class="d-flex flex-column align-items-center">
                    <div class="fw-bold fs-5 mb-1">${topicsCompleted}/${totalTopics}</div>
                    <div class="small text-muted">Topics</div>
                </div>
            </td>
            <td class="border-0 py-3 text-center">
                <div class="d-flex flex-column align-items-center">
                    <i class="fas fa-chart-line text-primary fs-4 mb-1"></i>
                    <div class="small text-muted">Analytics</div>
                </div>
            </td>
        `;
        
        tableBody.appendChild(row);
    });
}

function getTopicProgress(data, topicId) {
    if (!data?.state?.topics?.[topicId]) return 0;
    
    // Try overall progress first
    if (data.state.topics[topicId].overall?.p !== undefined) {
        return data.state.topics[topicId].overall.p;
    }
    
    // For class average, try to calculate from individual resources
    const topicData = data.state.topics[topicId];
    if (topicData.values) {
        const resourceValues = Object.values(topicData.values);
        if (resourceValues.length > 0) {
            const totalProgress = resourceValues.reduce((sum, resource) => sum + (resource.p || 0), 0);
            return totalProgress / resourceValues.length;
        }
    }
    
    return 0;
}

function calculateComparativeData() {
    // Get my progress data
    const myData = responseData.learners.find(learner => learner.id === responseData.context.learnerId);
    const classData = responseData.groups.find(group => group.name === 'Class Average');
    
    if (!myData || !classData) return null;
    
    // Create comparative data structure
    const comparativeData = {
        state: {
            topics: {}
        }
    };
    
    // Calculate differences for each topic
    responseData.topics.forEach(topic => {
        const myTopic = myData.state.topics[topic.id];
        const classTopic = classData.state.topics[topic.id];
        
        if (myTopic && classTopic) {
            comparativeData.state.topics[topic.id] = {
                values: {}
            };
            
            // Calculate differences for each resource
            responseData.resources.forEach(resource => {
                const myValue = myTopic.values?.[resource.id]?.p || 0;
                const classValue = classTopic.values?.[resource.id]?.p || 0;
                const difference = myValue - classValue; // Positive = ahead, Negative = behind
                
                comparativeData.state.topics[topic.id].values[resource.id] = {
                    p: difference
                };
            });
            
            // Calculate overall topic difference
            const myOverall = myTopic.overall?.p || 0;
            const classOverall = classTopic.overall?.p || 0;
            const overallDifference = myOverall - classOverall;
            
            comparativeData.state.topics[topic.id].overall = {
                p: overallDifference
            };
        }
    });
    
    return comparativeData;
}

function getCellValue(data, topicId, resourceId) {
    if (!data?.state?.topics?.[topicId]?.values?.[resourceId]) return 0;
    return data.state.topics[topicId].values[resourceId].p || 0;
}

function getTextColor(value) {
    // Handle comparative view (can be negative or positive)
    if (currentViewMode === 'comparative') {
        // Determine if we're in dark mode using the same logic as base.html
        const userPrefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        const savedTheme = localStorage.getItem('theme');
        const isDarkMode = savedTheme ? savedTheme === 'dark' : userPrefersDark;
        if (value === 0) {
            return '#6c757d'; // Bootstrap secondary color for neutral
        } else if (value > 0) {
            // Positive difference (ahead of class) - use green
            const intensity = Math.min(Math.abs(value), 1); // Cap at 1        
            if (isDarkMode) {
                // Green shade, with white base, for dark mode
                const r = Math.round(40 + (255 - 40) * (1 - intensity));
                const g = Math.round(167 + (255 - 167) * (1 - intensity));
                const b = Math.round(69 + (255 - 69) * (1 - intensity));
                return `rgb(${r}, ${g}, ${b})`;
            } else {
                // Green shade, with black base, for light mode
                const r = Math.round(40 * intensity);
                const g = Math.round(167 * intensity);
                const b = Math.round(69 * intensity);
                return `rgb(${r}, ${g}, ${b})`;
            }
        } else {
            // Negative difference (behind class) - use red
            const intensity = Math.min(Math.abs(value), 1); // Cap at 1
            if (isDarkMode) {
                // Red shade, with white base, for dark mode
                const r = Math.round(220 + (255 - 220) * (1 - intensity));
                const g = Math.round(53 + (255 - 53) * (1 - intensity));
                const b = Math.round(69 + (255 - 69) * (1 - intensity));
                return `rgb(${r}, ${g}, ${b})`;
            } else {
                // Red shade, with black base, for light mode
                const r = Math.round(220 * intensity);
                const g = Math.round(53 * intensity);
                const b = Math.round(69 * intensity);
                return `rgb(${r}, ${g}, ${b})`;
            }
        }
    }
    
    // Regular progress view
    const percent = Math.round(value * 100);
    
    // Return secondary color for 0%
    if (percent === 0) {
        return '#6c757d'; // Bootstrap secondary color
    }
    
    if (percent <= 50) {
        // Linear interpolation from Bootstrap danger to warning
        const ratio = percent / 50;
        // Bootstrap danger: #dc3545 (220, 53, 69) to warning: #ffc107 (255, 193, 7)
        const r = Math.round(220 + (255 - 220) * ratio);
        const g = Math.round(53 + (193 - 53) * ratio);
        const b = Math.round(69 + (7 - 69) * ratio);
        
        return `rgb(${r}, ${g}, ${b})`;
    } else {
        // Linear interpolation from warning to success
        const ratio = (percent - 50) / 50;
        // Warning: #ffc107 (255, 193, 7) to success: #28a745 (40, 167, 69)
        const r = Math.round(255 + (40 - 255) * ratio);
        const g = Math.round(193 + (167 - 193) * ratio);
        const b = Math.round(7 + (69 - 7) * ratio);
        
        return `rgb(${r}, ${g}, ${b})`;
    }
}

function getCellStyle(value) {
    // Keep this function for backward compatibility but return neutral styles
    return {
        backgroundColor: 'transparent',
        borderColor: '#dee2e6',
        color: getTextColor(value)
    };
}

function getProgressBarStyle(percent) {
    // Use the same three-point gradient logic for progress bars
    const value = percent / 100;
    const color = getTextColor(value);
    
    // For 0%, use default Bootstrap styling
    if (percent === 0) {
        return {
            backgroundColor: '#6c757d' // Bootstrap secondary color
        };
    }
    
    return {
        backgroundColor: color
    };
}

function getBadgeStyle(percent) {
    // Handle comparative view differently
    if (currentViewMode === 'comparative') {
        const value = percent / 100;
        if (value === 0) {
            return {
                backgroundColor: '#6c757d', // Bootstrap secondary color
                color: '#ffffff'
            };
        } else if (value > 0) {
            // Positive difference - green badge
            return {
                backgroundColor: '#28a745', // Bootstrap success color
                color: '#ffffff'
            };
        } else {
            // Negative difference - red badge
            return {
                backgroundColor: '#dc3545', // Bootstrap danger color
                color: '#ffffff'
            };
        }
    }
    
    // Regular progress view
    const value = percent / 100;
    const color = getTextColor(value);
    
    // For 0%, use default Bootstrap styling
    if (percent === 0) {
        return {
            backgroundColor: '#6c757d', // Bootstrap secondary color
            color: '#ffffff'
        };
    }
    
    return {
        backgroundColor: color,
        color: '#ffffff'
    };
}

function showStudentDetails(learnerId) {
    const learner = responseData.learners.find(l => l.id === learnerId);
    if (!learner) return;

    // Create a modern modal for student details
    const modalHtml = `
        <div class="modal fade" id="studentModal" tabindex="-1">
            <div class="modal-dialog modal-xl">
                <div class="modal-content border-0 shadow-lg">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title">
                            <i class="fas fa-user-graduate me-2"></i>
                            Student Details: ${learner.id}
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body p-4">
                        <div class="row g-4">
                            ${responseData.topics.sort((a,b) => a.order - b.order).map((topic, index) => {
                                const topicData = learner.state.topics[topic.id];
                                const progress = (topicData?.overall?.p || 
                                               topicData?.values?.['Coding Problems']?.p || 
                                               topicData?.p || 
                                               0) * 100;
                                const progressPercent = Math.max(0, Math.min(100, Math.round(progress)));
                                
                                return `
                                    <div class="col-md-6">
                                        <div class="card border-0 shadow-sm h-100">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between align-items-center mb-3">
                                                    <h6 class="card-title mb-0 fw-bold">${topic.name}</h6>
                                                    <span class="badge" style="${Object.entries(getBadgeStyle(progressPercent)).map(([key, value]) => `${key.replace(/([A-Z])/g, '-$1').toLowerCase()}: ${value}`).join('; ')}">${progressPercent}%</span>
                                                </div>
                                                <div class="progress mb-3" style="height: 8px;">
                                                    <div class="progress-bar" style="width: ${progressPercent}%; ${Object.entries(getProgressBarStyle(progressPercent)).map(([key, value]) => `${key.replace(/([A-Z])/g, '-$1').toLowerCase()}: ${value}`).join('; ')}"></div>
                                                </div>
                                                <div class="row g-2">
                                                    ${responseData.resources.map(resource => {
                                                        const resourceProgress = (topicData?.values?.[resource.id]?.p || 0) * 100;
                                                        const resourcePercent = Math.round(resourceProgress);
                                                        return `
                                                            <div class="col-6">
                                                                <div class="d-flex justify-content-between align-items-center">
                                                                    <small class="text-muted">${resource.name}</small>
                                                                    <small class="fw-semibold">${resourcePercent}%</small>
                                                                </div>
                                                                <div class="progress" style="height: 4px;">
                                                                    <div class="progress-bar" style="width: ${resourcePercent}%; ${Object.entries(getProgressBarStyle(resourcePercent)).map(([key, value]) => `${key.replace(/([A-Z])/g, '-$1').toLowerCase()}: ${value}`).join('; ')}"></div>
                                                                </div>
                                                            </div>
                                                        `;
                                                    }).join('')}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if any
    const existingModal = document.getElementById('studentModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add new modal to body
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('studentModal'));
    modal.show();
}

function handleCellClick(topicId, resourceId, topicName, resourceName) {
    console.log('Cell clicked:', { topicId, resourceId, topicName, resourceName });
    
    // Create a modern modal for cell details
    const modalHtml = `
        <div class="modal fade" id="cellModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content border-0 shadow-lg">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title">
                            <i class="fas fa-chart-bar me-2"></i>
                            ${topicName}  ${resourceName}
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                    <div class="modal-body p-4">
                        <div class="text-center py-5">
                            <div class="bg-light rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 64px; height: 64px;">
                                <i class="fas fa-chart-pie text-primary fs-3"></i>
                            </div>
                            <h6 class="fw-bold">Detailed Progress Information</h6>
                            <p class="text-muted">This feature will show detailed progress breakdown for the selected topic and resource combination.</p>
                        </div>
                    </div>
                    </div>
                </div>
            </div>
        `;
    
    // Remove existing modal if any
    const existingModal = document.getElementById('cellModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add new modal to body
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('cellModal'));
    modal.show();
}

function showError(message) {
    // Create a modern toast notification
    const toastHtml = `
        <div class="toast align-items-center text-white bg-danger border-0" role="alert" aria-live="assertive" aria-atomic="true" style="position: fixed; top: 20px; right: 20px; z-index: 9999;">
            <div class="d-flex">
                <div class="toast-body">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', toastHtml);
    const toast = new bootstrap.Toast(document.querySelector('.toast'));
    toast.show();
    
    // Remove toast after it's hidden
    setTimeout(() => {
        const toastElement = document.querySelector('.toast');
        if (toastElement) {
            toastElement.remove();
        }
    }, 5000);
}
</script>
{% endblock %}