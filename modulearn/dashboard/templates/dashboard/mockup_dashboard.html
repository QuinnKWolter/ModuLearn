{% extends 'base.html' %}
{% load static %}

{% block title %}Learning Analytics Dashboard - ModuLearn{% endblock %}

{% block content %}
<div class="container-fluid py-2 py-md-4">

    <!-- Modern Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-lg" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <div class="card-body text-white p-4">
                    <div class="d-flex align-items-center mb-4">
                        <div class="bg-white bg-opacity-20 rounded-circle p-3 me-3">
                            <i class="fas fa-chart-line text-dark fs-3"></i>
                        </div>
                        <div>
                            <h1 class="h2 mb-1 fw-bold">Learning Analytics Dashboard</h1>
                            <p class="mb-0 opacity-75">Advanced mastery tracking with interactive grid visualization</p>
                        </div>
                    </div>
                    
                    <!-- Configuration Form -->
                    <div class="row g-3">
                        <div class="col-md-3" style="display: none;">
                            <label for="usr" class="form-label fw-semibold text-white">User ID</label>
                            <input type="text" class="form-control form-control-lg" id="usr" placeholder="Enter user ID">
                        </div>
                        <div class="col-md-3">
                            <label for="grp" class="form-label fw-semibold text-white">Group ID</label>
                            <input type="text" class="form-control form-control-lg" id="grp" value="CMPINF0401Fall20242" placeholder="Enter group ID">
                        </div>
                        <div class="col-md-3" style="display: none;">
                            <label for="sid" class="form-label fw-semibold text-white">Session ID</label>
                            <input type="text" class="form-control form-control-lg" id="sid" placeholder="Enter session ID">
                        </div>
                        <div class="col-md-3">
                            <label for="cid" class="form-label fw-semibold text-white">Course ID</label>
                            <input type="text" class="form-control form-control-lg" id="cid" value="417" placeholder="Enter course ID">
                        </div>
                    </div>
                    <div class="text-center mt-4">
                        <button class="btn btn-dark btn-lg px-5 fw-bold" id="fetchDataBtn" data-api-url="{% url 'dashboard:fetch_analytics_data' %}">
                            <i class="fas fa-rocket me-2"></i>
                            <span id="fetchBtnText">Launch Analytics</span>
                            <div class="spinner-border spinner-border-sm ms-2 d-none" id="fetchSpinner"></div>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Dashboard Content Area (Hidden until data is loaded) -->
    <div id="dashboardContent" class="d-none">
        <!-- Modern Analytics Overview -->
        <div class="row mb-4">
        <div class="col-12">
                <div class="card border-0 shadow-lg">
                    <div class="card-body p-4">
                        <div class="d-flex align-items-center mb-4">
                            <div class="bg-gradient-primary rounded-circle p-3 me-3">
                                <i class="fas fa-chart-line fs-4"></i>
                            </div>
                            <div>
                                <h2 id="courseTitle" class="h3 mb-1 fw-bold">Course Analytics</h2>
                                <p class="text-muted mb-0">Interactive mastery grid with real-time progress tracking</p>
                            </div>
                        </div>
                        
                        <!-- KPI Cards Grid -->
                        <div class="row g-4">
                            <div class="col-lg-3 col-md-6">
                                <div class="card border-0 shadow-sm h-100" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                                    <div class="card-body text-white text-center p-4">
                                        <div class="bg-white bg-opacity-20 rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 60px; height: 60px;">
                                            <i class="fas fa-users fs-4 text-dark"></i>
                                        </div>
                                        <h6 class="text-white-50 fw-bold mb-2">Students</h6>
                                        <div class="display-4 fw-bold" id="studentsEnrolled">-</div>
                                        <small class="text-white-50">Total enrolled</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-3 col-md-6">
                                <div class="card border-0 shadow-sm h-100" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                                    <div class="card-body text-white text-center p-4">
                                        <div class="bg-white bg-opacity-20 rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 60px; height: 60px;">
                                            <i class="fas fa-fire fs-4 text-dark"></i>
                                        </div>
                                        <h6 class="text-white-50 fw-bold mb-2">Engagement Score</h6>
                                        <div class="display-4 fw-bold" id="engagementScore">-</div>
                                        <small class="text-white-50">Avg participation</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-3 col-md-6">
                                <div class="card border-0 shadow-sm h-100" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                                    <div class="card-body text-white text-center p-4">
                                        <div class="bg-white bg-opacity-20 rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 60px; height: 60px;">
                                            <i class="fas fa-percentage fs-4 text-dark"></i>
                                        </div>
                                        <h6 class="text-white-50 fw-bold mb-2">Overall Progress</h6>
                                        <div class="display-4 fw-bold" id="overallProgress">-</div>
                                        <small class="text-white-50">Course completion</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-3 col-md-6">
                                <div class="card border-0 shadow-sm h-100" style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);">
                                    <div class="card-body text-white text-center p-4">
                                        <div class="bg-white bg-opacity-20 rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 60px; height: 60px;">
                                            <i class="fas fa-exclamation-triangle fs-4 text-dark"></i>
                                        </div>
                                        <h6 class="text-white-50 fw-bold mb-2">Struggling Students</h6>
                                        <div class="display-4 fw-bold" id="studentsNeedingHelp">0</div>
                                        <small class="text-white-50">Behind in 30%+ of work</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modern Mastery Grid -->
        <div class="row">
            <div class="col-12">
                <div class="card border-0 shadow-lg">
                    <div class="card-header border-0 py-4">
                        <div class="d-flex align-items-center justify-content-between">
                            <div class="d-flex align-items-center">
                                <div class="bg-gradient-primary rounded-circle p-2 me-3">
                                    <i class="fas fa-th"></i>
                                </div>
                                <div>
                                    <h4 class="mb-1 fw-bold" id="viewTitle">Mastery Grid</h4>
                                    <p class="text-muted mb-0" id="viewDescription">Click any cell to view detailed progress</p>
                                </div>
                            </div>
                            <div class="d-flex gap-2">
                                <div class="btn-group" role="group">
                                    <!-- <input type="radio" class="btn-check" name="viewMode" id="myProgress" value="myProgress" checked style="display: none;">
                                    <label class="btn btn-outline-secondary" for="myProgress" style="display: none;">
                                        <i class="fas fa-user me-1"></i>My Progress
                                    </label> -->
                                    <!-- <input type="radio" class="btn-check" name="viewMode" id="comparative" value="comparative" style="display: none;">
                                    <label class="btn btn-outline-warning" for="comparative" style="display: none;">
                                        <i class="fas fa-balance-scale me-1"></i>Comparative
                                    </label> -->
                                    <input type="radio" class="btn-check" name="viewMode" id="classAverage" value="classAverage">
                                    <label class="btn btn-outline-success" for="classAverage">
                                        <i class="fas fa-users me-1"></i>Class Average
                                    </label>
                                    <input type="radio" class="btn-check" name="viewMode" id="perStudent" value="perStudent">
                                    <label class="btn btn-outline-primary" for="perStudent">
                                        <i class="fas fa-list me-1"></i>Per Student
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <!-- Mastery Grid View -->
                        <div class="table-responsive">
                            <table class="table mb-0 custom-table" id="masteryGrid">
                                <thead>
                                    <tr id="gridHeaders">
                                        <th class="border-0 fw-bold py-2 text-center" style="min-width: 250px;">
                                            <div class="d-flex flex-column align-items-center">
                                                <i class="fas fa-graduation-cap text-primary mb-1"></i>
                                                Topics
                                            </div>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="gridBody">
                                    <!-- Dynamic grid content will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Per Student View - Hidden by default, content will be swapped in -->
                        <div id="perStudentContent" style="display: none;">
                            <div class="table-responsive" style="width: 50%; margin: 0 auto;">
                                <table class="table table-hover mb-0 custom-table" id="studentTable">
                                    <thead>
                                        <tr>
                                            <th class="border-0 fw-bold py-1 text-center">
                                                <div class="d-flex flex-column align-items-center">
                                                    <i class="fas fa-user-graduate text-primary mb-1" style="font-size: 0.8rem;"></i>
                                                    <span style="font-size: 0.8rem;">Student ID</span>
                                                </div>
                                            </th>
                                            <th class="border-0 fw-bold py-1 text-center">
                                                <div class="d-flex flex-column align-items-center">
                                                    <i class="fas fa-chart-line text-primary mb-1" style="font-size: 0.8rem;"></i>
                                                    <span style="font-size: 0.8rem;">Overall Progress</span>
                                                </div>
                                            </th>
                                            <th class="border-0 fw-bold py-1 text-center">
                                                <div class="d-flex flex-column align-items-center">
                                                    <i class="fas fa-book text-primary mb-1" style="font-size: 0.8rem;"></i>
                                                    <span style="font-size: 0.8rem;">Topics Completed</span>
                                                </div>
                                            </th>
                                            <th class="border-0 fw-bold py-1 text-center">
                                                <div class="d-flex flex-column align-items-center">
                                                    <i class="fas fa-chart-bar text-primary mb-1" style="font-size: 0.8rem;"></i>
                                                    <span style="font-size: 0.8rem;">Analytics</span>
                                                </div>
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody id="studentTableBody">
                                        <!-- Dynamic student rows will be inserted here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Student Details Modal -->
    <div class="modal fade" id="studentDetailModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header bg-primary text-white border-0">
                    <h5 class="modal-title fw-bold" id="studentDetailModalLabel">
                        <i class="fas fa-user-graduate me-2"></i>Student Details
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                         </div>
                <div class="modal-body p-4" id="studentDetailModalBody">
                    <!-- Student-specific breakdown will be inserted here -->
            </div>
        </div>
    </div>
</div>

    <!-- Error Alert -->
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
        <div id="errorAlert" class="toast align-items-center text-white bg-danger border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body" id="errorMessage"></div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
<style>
/* Modern Dashboard Styling */
/* Removed student row hover effects */

.card {
    transition: all 0.3s ease;
    background-color: #ffffff !important;
    border: 1px solid #e9ecef !important;
    color: #212529 !important;
}
.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.1) !important;
}

.progress {
    box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);
    overflow: visible;
    background-color: #e9ecef !important;
}

.progress-bar {
    transition: width 0.6s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: visible;
}

/* Fix toggle buttons - CRITICAL FIX */
.btn-group .btn-check:checked + .btn-outline-primary {
    background-color: #0d6efd !important;
    border-color: #0d6efd !important;
    color: white !important;
}

.btn-outline-primary {
    color: #0d6efd !important;
    border-color: #0d6efd !important;
    background-color: white !important;
    border: 2px solid #0d6efd !important;
    font-weight: 500 !important;
}

.btn-outline-primary:hover {
    background-color: #0d6efd !important;
    border-color: #0d6efd !important;
    color: white !important;
}

.btn-outline-primary:focus {
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25) !important;
}

/* Text colors - let theme control */
.text-primary {
    color: #0d6efd;
}
.text-white {
    color: white;
}
.text-muted {
    color: #6c757d;
}

/* Fix button styling */
.btn {
    background-color: white;
    border: 2px solid #0d6efd;
    color: #0d6efd;
    font-weight: 500;
}

.btn-primary {
    background-color: #0d6efd !important;
    border-color: #0d6efd !important;
    color: white !important;
}

.btn-primary:hover {
    background-color: #0b5ed7 !important;
    border-color: #0a58ca !important;
    color: white !important;
}

/* Card and table styling - let theme control colors */
.card {
    border: 1px solid #dee2e6;
}

.card-header {
    border-bottom: 1px solid #dee2e6;
}

.table th {
    border-bottom: 2px solid #dee2e6;
    font-weight: 600;
}

/* Form controls - let theme control */
.form-control:focus {
    border-color: #86b7fe;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}

.form-label {
    font-weight: 600;
}

/* Override Bootstrap CSS variables for tables */
.table {
    --bs-table-bg: transparent !important;
    --bs-table-color: inherit !important;
    --bs-table-bg-state: transparent !important;
    --bs-table-bg-type: transparent !important;
    --bs-table-accent-bg: transparent !important;
    --bs-table-color-state: inherit !important;
    --bs-table-color-type: inherit !important;
}

/* Force override Bootstrap table styles with higher specificity */
#masteryGrid>:not(caption)>*>*,
#studentTable>:not(caption)>*>* {
    color: inherit !important;
    background-color: transparent !important;
    box-shadow: none !important;
}

/* Target table elements more specifically */
#masteryGrid th,
#masteryGrid td,
#studentTable th,
#studentTable td {
    color: inherit !important;
    background-color: transparent !important;
}

/* Nuclear option - completely override Bootstrap table styles */
.custom-table>:not(caption)>*>* {
    color: inherit !important;
    background-color: transparent !important;
    box-shadow: none !important;
    border-color: inherit !important;
}

.custom-table th,
.custom-table td {
    color: inherit !important;
    background-color: transparent !important;
    border-color: inherit !important;
}

/* Dynamic grid cell styling with three-point gradient */
.progress-cell {
    border: 2px solid;
    font-weight: 600;
    transition: all 0.2s ease;
    position: relative;
    overflow: hidden;
}

/* Hover effect for grid cells - swap text and background colors */
.progress-cell:hover {
    transition: all 0.15s ease;
}

.progress-cell:hover .fw-bold {
    transition: all 0.15s ease;
}

/* Dark mode support for dynamic cells */
@media (prefers-color-scheme: dark) {
    .progress-cell {
        color: #ffffff;
    }
}

.cursor-pointer:hover .fw-bold {
    transform: scale(1.1);
    transition: transform 0.2s ease;
}

/* Dynamic progress styling - colors will be set via JavaScript */

/* Badge styling - improved visibility */
.badge {
    font-size: 0.75em;
    padding: 0.5em 0.75em;
    font-weight: 600;
    border-radius: 0.375rem;
}

/* Grid cell improvements */
.cursor-pointer {
    cursor: pointer !important;
    transition: all 0.2s ease;
}

/* Removed cell swelling hover effect */

/* Text elements - let theme control */
h1, h2, h3, h4, h5, h6 {
    color: #212529;
}

/* Icon improvements */
.fas, .far, .fab {
    color: inherit !important;
}

/* Ensure proper spacing and alignment */
.d-flex {
    align-items: center;
}

/* Improve form styling */
.form-control {
    border-radius: 0.375rem;
    font-weight: 500;
}

.form-control:focus {
    border-color: #86b7fe;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}

/* Table styling improvements */
.table th {
    background-color: #f8f9fa;
    border-bottom: 2px solid #dee2e6;
    font-weight: 600;
}

.table td {
    vertical-align: middle;
}

/* Responsive design */
@media (max-width: 576px) {
    .display-5 {
        font-size: 2rem !important;
    }
    .card-body {
        padding: 1rem !important;
    }
    .table th, .table td {
        padding: 0.75rem 0.5rem;
        font-size: 0.9rem;
    }
}

@media (max-width: 768px) {
    .container-fluid {
        padding-left: 1rem;
        padding-right: 1rem;
    }
}

.fade-in {
    animation: fadeIn 0.5s ease-in;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Gradient backgrounds for better visual appeal */
.bg-gradient-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
}

.bg-gradient-info {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%) !important;
}

/* Enhanced button styling - improved visibility */
.btn-group .btn {
    border-radius: 0.375rem;
    font-weight: 600;
    transition: all 0.2s ease;
}

.btn-group .btn:first-child {
    border-top-right-radius: 0;
    border-bottom-right-radius: 0;
}

.btn-group .btn:last-child {
    border-top-left-radius: 0;
    border-bottom-left-radius: 0;
}

.btn-group .btn:not(:first-child):not(:last-child) {
    border-radius: 0;
}

/* Ensure button group visibility */
.btn-group .btn-check:checked + .btn-outline-primary {
    background-color: #0d6efd !important;
    border-color: #0d6efd !important;
    color: white !important;
    font-weight: 600 !important;
}

.btn-group .btn-outline-primary {
    color: #0d6efd !important;
    border-color: #0d6efd !important;
    background-color: white !important;
    font-weight: 600 !important;
}

.btn-group .btn-outline-primary:hover {
    background-color: #0d6efd !important;
    border-color: #0d6efd !important;
    color: white !important;
}

/* Modal enhancements */
.modal-content {
    border-radius: 0.75rem;
}

.modal-header {
    border-radius: 0.75rem 0.75rem 0 0;
}

/* Remove rounded corners for modern look */
.progress {
    border-radius: 0;
}

.progress-bar {
    border-radius: 0;
}

.card {
    border-radius: 0;
}

.btn {
    border-radius: 0;
}

.modal-content {
    border-radius: 0;
}

.modal-header {
    border-radius: 0;
}

/* Card hover effects */
.card:hover {
    box-shadow: 0 8px 25px rgba(0,0,0,0.1) !important;
}

/* Table row hover effects */
/* Removed table row hover effect */

/* Dark mode support for overall theme - improved contrast */
@media (prefers-color-scheme: dark) {
    /* Body and main backgrounds */
    body {
        background-color: #1a202c !important;
        color: #e2e8f0 !important;
    }
    
    /* Cards */
    .card {
        background-color: #2d3748 !important;
        border-color: #4a5568 !important;
        color: #e2e8f0 !important;
    }
    
    .card-header {
        background-color: #4a5568 !important;
        border-color: #718096 !important;
        color: #e2e8f0 !important;
    }
    
    /* Tables */
    .table {
        background-color: #2d3748 !important;
        color: #e2e8f0 !important;
    }
    
    .table th {
        background-color: #4a5568 !important;
        border-color: #718096 !important;
        color: #e2e8f0 !important;
    }
    
    .table td {
        background-color: #2d3748 !important;
        border-color: #4a5568 !important;
        color: #e2e8f0 !important;
    }
    
    .table tbody tr:hover {
        background-color: rgba(66, 153, 225, 0.1) !important;
    }
    
    /* Modals */
    .modal-content {
        background-color: #2d3748 !important;
        color: #e2e8f0 !important;
    }
    
    .modal-header {
        background-color: #4a5568 !important;
        border-color: #718096 !important;
        color: #e2e8f0 !important;
    }
    
    .modal-body {
        background-color: #2d3748 !important;
        color: #e2e8f0 !important;
    }
    
    /* Form elements */
    .form-control {
        background-color: #4a5568 !important;
        border-color: #718096 !important;
        color: #e2e8f0 !important;
    }
    
    .form-control:focus {
        background-color: #4a5568 !important;
        border-color: #63b3ed !important;
        color: #e2e8f0 !important;
        box-shadow: 0 0 0 0.25rem rgba(99, 179, 237, 0.25) !important;
    }
    
    .form-label {
        color: #e2e8f0 !important;
    }
    
    /* Progress bars */
    .progress {
        background-color: #4a5568 !important;
    }
    
    /* Badges */
    .badge {
        color: white !important;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('fetchDataBtn').addEventListener('click', handleFetch);
    
    // View mode change listeners
    document.querySelectorAll('input[name="viewMode"]').forEach(radio => {
        radio.addEventListener('change', function() {
            currentViewMode = this.value;
            updateGrid();
            
            // Update all radio buttons to reflect the current selection
            document.querySelectorAll('input[name="viewMode"]').forEach(r => {
                r.checked = (r.value === currentViewMode);
            });
        });
    });
    
    // Initialize button states on page load
    updateButtonStates();
});

let responseData = null;
let currentViewMode = 'classAverage';

function updateButtonStates() {
    // Update all radio buttons to reflect the current selection
    document.querySelectorAll('input[name="viewMode"]').forEach(r => {
        r.checked = (r.value === currentViewMode);
    });
}

function handleFetch() {
    const btn = document.getElementById('fetchDataBtn');
    const btnText = document.getElementById('fetchBtnText');
    const spinner = document.getElementById('fetchSpinner');
    
    btn.disabled = true;
    btnText.textContent = 'Loading...';
    spinner.classList.remove('d-none');
    
    // First, fetch the class list to get real learner IDs
    const classListParams = {
        grp: document.getElementById('grp').value
    };
    
    const classListUrl = `{% url 'dashboard:fetch_class_list' %}?${new URLSearchParams(classListParams)}`;
    
    fetch(classListUrl)
        .then(response => {
            if (!response.ok) throw new Error(`Class List API Error: ${response.statusText}`);
            return response.json();
        })
        .then(classListData => {
            if (classListData.error) throw new Error(classListData.error);
            
            // Now fetch analytics data without removeZeroProgressUsers
            const analyticsParams = {
                usr: document.getElementById('usr').value,
                grp: document.getElementById('grp').value,
                sid: document.getElementById('sid').value,
                cid: document.getElementById('cid').value,
                mod: 'all',
                models: '-1',
                avgtop: '-1'
                // Removed removeZeroProgressUsers parameter
            };
            
            const analyticsUrl = btn.getAttribute('data-api-url');
            const url = `${analyticsUrl}?${new URLSearchParams(analyticsParams)}`;
            
            return fetch(url).then(response => {
                if (!response.ok) throw new Error(`Analytics API Error: ${response.statusText}`);
                return response.json();
            }).then(analyticsData => {
                if (analyticsData.error) throw new Error(analyticsData.error);
                
                // Map real learner IDs to the analytics data
                responseData = mapLearnerIds(analyticsData, classListData);
                
                const dashboardContent = document.getElementById('dashboardContent');
                dashboardContent.classList.remove('d-none');
                dashboardContent.classList.add('fade-in');
                renderDashboard();
            });
        })
        .catch(error => {
            console.error('Fetch error:', error);
            showError(`Failed to load data: ${error.message}`);
        })
        .finally(() => {
            btn.disabled = false;
            btnText.textContent = 'Launch Analytics';
            spinner.classList.add('d-none');
        });
}

function mapLearnerIds(analyticsData, classListData) {
    // Step 1: Sort analytics learners by their integer ID (lowest to highest)
    const sortedAnalyticsLearners = analyticsData.learners.sort((a, b) => {
        const aId = parseInt(a.id);
        const bId = parseInt(b.id);
        return aId - bId;
    });
    
    // Step 2: Create mapping from sorted position to real learner ID
    const learnerIdMap = classListData.learners.map(learner => learner.learnerId);
    
    // Step 3: Update the sorted learners with real IDs
    sortedAnalyticsLearners.forEach((learner, index) => {
        if (index < learnerIdMap.length) {
            learner.id = learnerIdMap[index];
        }
    });
    
    // Step 4: Replace the original learners array with the sorted and mapped one
    analyticsData.learners = sortedAnalyticsLearners;
    
    return analyticsData;
}

function renderDashboard() {
    if (!responseData) return;
    
    populateKPIs();
    updateGrid();
}

function populateKPIs() {
    const classAvgData = responseData.groups.find(g => g.name === 'Class Average');
    if (!classAvgData) return;

    // Course Title
    document.getElementById('courseTitle').textContent = responseData.context.group.name;

    // Overall Progress - Calculate true class completion percentage
    let totalPossibleProgress = 0;
    let totalActualProgress = 0;
    
    responseData.topics.forEach(topic => {
        const topicData = classAvgData.state.topics[topic.id];
        if (topicData) {
            // Count all resources for this topic
            const resourceCount = Object.keys(topicData.values || {}).length;
            totalPossibleProgress += resourceCount;
            
            // Sum actual progress across all resources
            Object.values(topicData.values || {}).forEach(resource => {
                totalActualProgress += resource.p || 0;
            });
        }
    });
    
    const overallProgressPercent = totalPossibleProgress > 0 ? 
        Math.round((totalActualProgress / totalPossibleProgress) * 100) : 0;
    document.getElementById('overallProgress').textContent = `${overallProgressPercent}%`;

    // Students Enrolled
    document.getElementById('studentsEnrolled').textContent = responseData.learners.length;

    // Engagement Score - Calculate based on student activity and progress
    let totalEngagement = 0;
    let studentCount = 0;
    
    responseData.learners.forEach(learner => {
        let studentEngagement = 0;
        let resourceCount = 0;
        
        // Calculate engagement across all topics and resources
        responseData.topics.forEach(topic => {
            const topicData = learner.state.topics?.[topic.id];
            if (topicData?.values) {
                Object.values(topicData.values).forEach(resource => {
                    resourceCount++;
                    // Higher progress = higher engagement
                    studentEngagement += resource.p || 0;
                });
            }
        });
        
        if (resourceCount > 0) {
            totalEngagement += (studentEngagement / resourceCount) * 100;
            studentCount++;
        }
    });
    
    const engagementScore = studentCount > 0 ? Math.round(totalEngagement / studentCount) : 0;
    document.getElementById('engagementScore').textContent = `${engagementScore}%`;

    // Most Active Topic
    let mostActiveTopic = null;
    let highestProgress = 0;
    responseData.topics.forEach(topic => {
        const progress = classAvgData.state.topics[topic.id]?.values['Coding Problems']?.p || 0;
        if (progress > highestProgress) {
            highestProgress = progress;
            mostActiveTopic = topic;
        }
    });
    
    // Students Needing Intervention - Check ALL resources
    let studentsNeedingHelp = 0;
    responseData.learners.forEach(learner => {
        const learnerProgress = learner.state.topics;
        let strugglingResources = 0;
        let totalResources = 0;
        
        responseData.topics.forEach(topic => {
            const learnerTopicData = learnerProgress[topic.id];
            const classTopicData = classAvgData.state.topics[topic.id];
            
            if (learnerTopicData?.values && classTopicData?.values) {
                // Check each resource in this topic
                Object.keys(classTopicData.values).forEach(resourceId => {
                    const learnerResourceProgress = learnerTopicData.values[resourceId]?.p || 0;
                    const classResourceProgress = classTopicData.values[resourceId]?.p || 0;
                    
                    if (classResourceProgress > 0) { // Only consider resources with class activity
                        totalResources++;
                        if (learnerResourceProgress < (classResourceProgress * 0.5)) { // Struggling if < 50% of class average
                            strugglingResources++;
                        }
                    }
                });
            }
        });
        
        // Student needs intervention if struggling in > 30% of active resources
        if (totalResources > 0 && (strugglingResources / totalResources) > 0.3) {
            studentsNeedingHelp++;
        }
    });
    
    document.getElementById('studentsNeedingHelp').textContent = studentsNeedingHelp;
    
    // Debug logging to verify calculation
    console.log(`Struggling Students Calculation: ${studentsNeedingHelp} out of ${responseData.learners.length} total students`);
}

function updateGrid() {
    if (!responseData) return;
    
    // Update button states
    updateButtonStates();
    
    // Update title and description based on current view
    updateViewHeader();
    
    // Get the content containers
    const masteryGrid = document.getElementById('masteryGrid').closest('.table-responsive');
    const perStudentContent = document.getElementById('perStudentContent');
    
    if (currentViewMode === 'perStudent') {
        // Hide mastery grid and show per student content
        masteryGrid.style.display = 'none';
        perStudentContent.style.display = 'block';
        updatePerStudentView();
    } else {
        // Show mastery grid and hide per student content
        masteryGrid.style.display = 'block';
        perStudentContent.style.display = 'none';
        updateMasteryGrid();
    }
}

function updateViewHeader() {
    const titleElement = document.getElementById('viewTitle');
    const descriptionElement = document.getElementById('viewDescription');
    
    if (!titleElement || !descriptionElement) return;
    
    switch (currentViewMode) {
        case 'myProgress':
            titleElement.textContent = 'My Progress';
            descriptionElement.textContent = 'Your individual progress across all topics';
            break;
        case 'comparative':
            titleElement.textContent = 'Comparative View';
            descriptionElement.textContent = 'Your progress compared to class average';
            break;
        case 'classAverage':
            titleElement.textContent = 'Class Average';
            descriptionElement.textContent = 'Average class progress across all topics';
            break;
        case 'perStudent':
            titleElement.textContent = 'Student Progress Overview';
            descriptionElement.textContent = 'Individual student progress tracking';
            break;
    }
}

function updateMasteryGrid() {
    // Update grid headers
    const gridHeaders = document.getElementById('gridHeaders');
    while (gridHeaders.children.length > 1) {
        gridHeaders.removeChild(gridHeaders.lastChild);
    }
    
    // Add resource headers
    responseData.resources.forEach(resource => {
        const th = document.createElement('th');
        th.className = 'border-0 fw-bold text-center py-3';
        th.style.minWidth = '120px';
        th.innerHTML = `
            <div class="d-flex flex-column align-items-center">
                <i class="fas fa-tasks text-primary mb-1"></i>
                <span class="small text-break">${resource.name}</span>
            </div>
        `;
        gridHeaders.appendChild(th);
    });
    
    // Update grid body
    const gridBody = document.getElementById('gridBody');
    gridBody.innerHTML = '';
    
    // Get current data based on view mode
    let currentData;
    if (currentViewMode === 'myProgress') {
        currentData = responseData.learners.find(learner => learner.id === responseData.context.learnerId);
    } else if (currentViewMode === 'comparative') {
        // For comparative view, we'll calculate the difference between my progress and class average
        currentData = calculateComparativeData();
    } else {
        currentData = responseData.groups.find(group => group.name === 'Class Average');
    }
    
    if (!currentData) return;
    
    // Sort topics by order
    const sortedTopics = responseData.topics.sort((a, b) => a.order - b.order);
    
    // Create grid rows
    sortedTopics.forEach((topic, index) => {
        const row = document.createElement('tr');
        
        // Topic cell with gradient styling
        const topicProgress = getTopicProgress(currentData, topic.id);
        const progressPercent = Math.round(topicProgress * 100);
        const progressColor = getTextColor(topicProgress);
        const progressBarStyle = getProgressBarStyle(progressPercent);
        
        const topicCell = document.createElement('td');
        topicCell.className = 'border-0 py-2';
        topicCell.innerHTML = `
            <div class="d-flex align-items-center">
                <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 32px; height: 32px;">
                    <span class="text-white fw-bold small">${topic.order}</span>
                </div>
                <div class="flex-grow-1">
                    <div class="fw-bold mb-1">${topic.name}</div>
                    <div class="progress" style="height: 6px; background-color: rgba(0,0,0,0.1);">
                        <div class="progress-bar" role="progressbar" style="width: ${progressPercent}%; ${Object.entries(progressBarStyle).map(([key, value]) => `${key.replace(/([A-Z])/g, '-$1').toLowerCase()}: ${value}`).join('; ')}"></div>
                    </div>
                </div>
                <div class="ms-3">
                    <span class="badge fw-bold" style="${Object.entries(getBadgeStyle(progressPercent)).map(([key, value]) => `${key.replace(/([A-Z])/g, '-$1').toLowerCase()}: ${value}`).join('; ')}; min-width: 50px; text-align: center;">${progressPercent}%</span>
                </div>
            </div>
        `;
        row.appendChild(topicCell);
        
        // Resource cells with text gradient styling
        responseData.resources.forEach(resource => {
            const cell = document.createElement('td');
            const value = getCellValue(currentData, topic.id, resource.id);
            const textColor = getTextColor(value);
            
            cell.className = 'text-center border-0 py-2 progress-cell cursor-pointer';
            cell.style.cursor = 'pointer';
            cell.style.borderRadius = '0';
            cell.onclick = () => handleCellClick(topic.id, resource.id, topic.name, resource.name);
            
            // Store original colors for hover effect
            cell.dataset.originalTextColor = textColor;
            cell.dataset.originalBgColor = 'transparent';
            
            // Format the display value based on view mode
            let displayValue;
            if (currentViewMode === 'comparative') {
                const percentage = Math.round(value * 100);
                displayValue = percentage > 0 ? `+${percentage}%` : `${percentage}%`;
            } else {
                displayValue = `${Math.round(value * 100)}%`;
            }
            
            cell.innerHTML = `
                <div class="d-flex flex-column align-items-center">
                    <div class="fw-bold fs-6" style="color: ${textColor};">${displayValue}</div>
                </div>
            `;
            
            // Add hover event listeners for gentle highlight effect
            cell.addEventListener('mouseenter', function() {
                // Apply gentle background highlight to all cells
                this.style.backgroundColor = 'rgba(0, 0, 0, 0.1)';
                // Keep original text color but make it slightly darker for contrast
                if (textColor !== 'inherit') {
                    this.querySelector('.fw-bold').style.color = textColor;
                } else {
                    this.querySelector('.fw-bold').style.color = '#6c757d';
                }
            });
            
            cell.addEventListener('mouseleave', function() {
                // Restore original state for all cells
                this.style.backgroundColor = 'transparent';
                this.querySelector('.fw-bold').style.color = textColor;
            });
            
            row.appendChild(cell);
        });
        
        gridBody.appendChild(row);
    });
}

function updatePerStudentView() {
    const tableBody = document.getElementById('studentTableBody');
    tableBody.innerHTML = '';
    
    // Keep learners in their current order (already sorted by integer ID and mapped)
    const sortedLearners = responseData.learners
        .filter(learner => !learner.isHidden);

    sortedLearners.forEach((learner, index) => {
        // Calculate overall progress
        const topicProgresses = responseData.topics.map(topic => {
            const topicData = learner.state.topics[topic.id];
            const progress = topicData?.overall?.p || 
                           topicData?.values?.['Coding Problems']?.p || 
                           topicData?.p || 
                           0;
            return progress;
        });
        
        const overallProgress = topicProgresses.reduce((acc, val) => acc + val, 0) / (topicProgresses.length || 1);
        const progressPercent = Math.max(0, Math.min(100, Math.round(overallProgress * 100)));
        
        // Calculate topics completed
        const topicsCompleted = topicProgresses.filter(p => p >= 0.9).length;
        const totalTopics = responseData.topics.length;
        
        // Calculate performance (average of all topic progress)
        const performance = Math.round(overallProgress * 100);
        
        const row = document.createElement('tr');
        row.style.cursor = 'pointer';
        row.onclick = () => showStudentDetails(learner.id);
        
        row.innerHTML = `
            <td class="border-0 py-1 text-center">
                <div class="d-flex align-items-center justify-content-center">
                    <div class="bg-info rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 24px; height: 24px;">
                        <i class="fas fa-user text-white" style="font-size: 0.7rem;"></i>
                    </div>
                    <div class="fw-bold" style="font-size: 0.9rem;">${learner.id}</div>
                </div>
            </td>
            <td class="border-0 py-1 text-center">
                <div class="d-flex flex-column align-items-center">
                    <div class="fw-bold fs-6 mb-1">${progressPercent}%</div>
                    <div class="progress" style="width: 80px; height: 4px; border-radius: 2px;">
                        <div class="progress-bar" role="progressbar" style="width: ${progressPercent}%; ${Object.entries(getProgressBarStyle(progressPercent)).map(([key, value]) => `${key.replace(/([A-Z])/g, '-$1').toLowerCase()}: ${value}`).join('; ')}"></div>
                    </div>
                </div>
            </td>
            <td class="border-0 py-1 text-center">
                <div class="d-flex flex-column align-items-center">
                    <div class="fw-bold fs-6 mb-1">${topicsCompleted}/${totalTopics}</div>
                    <div class="text-muted" style="font-size: 0.7rem;">Topics</div>
                </div>
            </td>
            <td class="border-0 py-1 text-center">
                <div class="d-flex flex-column align-items-center">
                    <i class="fas fa-chart-line text-primary mb-1" style="font-size: 1rem;"></i>
                    <div class="text-muted" style="font-size: 0.7rem;">Analytics</div>
                </div>
            </td>
        `;
        
        tableBody.appendChild(row);
    });
}

function getTopicProgress(data, topicId) {
    if (!data?.state?.topics?.[topicId]) return 0;
    
    // Try overall progress first
    if (data.state.topics[topicId].overall?.p !== undefined) {
        return data.state.topics[topicId].overall.p;
    }
    
    // For class average, try to calculate from individual resources
    const topicData = data.state.topics[topicId];
    if (topicData.values) {
        const resourceValues = Object.values(topicData.values);
        if (resourceValues.length > 0) {
            const totalProgress = resourceValues.reduce((sum, resource) => sum + (resource.p || 0), 0);
            return totalProgress / resourceValues.length;
        }
    }
    
    return 0;
}

function calculateComparativeData() {
    // Get my progress data
    const myData = responseData.learners.find(learner => learner.id === responseData.context.learnerId);
    const classData = responseData.groups.find(group => group.name === 'Class Average');
    
    if (!myData || !classData) return null;
    
    // Create comparative data structure
    const comparativeData = {
        state: {
            topics: {}
        }
    };
    
    // Calculate differences for each topic
    responseData.topics.forEach(topic => {
        const myTopic = myData.state.topics[topic.id];
        const classTopic = classData.state.topics[topic.id];
        
        if (myTopic && classTopic) {
            comparativeData.state.topics[topic.id] = {
                values: {}
            };
            
            // Calculate differences for each resource
            responseData.resources.forEach(resource => {
                const myValue = myTopic.values?.[resource.id]?.p || 0;
                const classValue = classTopic.values?.[resource.id]?.p || 0;
                const difference = myValue - classValue; // Positive = ahead, Negative = behind
                
                comparativeData.state.topics[topic.id].values[resource.id] = {
                    p: difference
                };
            });
            
            // Calculate overall topic difference
            const myOverall = myTopic.overall?.p || 0;
            const classOverall = classTopic.overall?.p || 0;
            const overallDifference = myOverall - classOverall;
            
            comparativeData.state.topics[topic.id].overall = {
                p: overallDifference
            };
        }
    });
    
    return comparativeData;
}

function getCellValue(data, topicId, resourceId) {
    if (!data?.state?.topics?.[topicId]?.values?.[resourceId]) return 0;
    return data.state.topics[topicId].values[resourceId].p || 0;
}

function getTextColor(value) {
    // Handle comparative view (can be negative or positive)
    if (currentViewMode === 'comparative') {
        // Determine if we're in dark mode using the same logic as base.html
        const userPrefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        const savedTheme = localStorage.getItem('theme');
        const isDarkMode = savedTheme ? savedTheme === 'dark' : userPrefersDark;
        if (value === 0) {
            return '#6c757d'; // Bootstrap secondary color for neutral
        } else if (value > 0) {
            // Positive difference (ahead of class) - use green
            const intensity = Math.min(Math.abs(value), 1); // Cap at 1        
            if (isDarkMode) {
                // Green shade, with white base, for dark mode
                const r = Math.round(40 + (255 - 40) * (1 - intensity));
                const g = Math.round(167 + (255 - 167) * (1 - intensity));
                const b = Math.round(69 + (255 - 69) * (1 - intensity));
                return `rgb(${r}, ${g}, ${b})`;
            } else {
                // Green shade, with black base, for light mode
                const r = Math.round(40 * intensity);
                const g = Math.round(167 * intensity);
                const b = Math.round(69 * intensity);
                return `rgb(${r}, ${g}, ${b})`;
            }
        } else {
            // Negative difference (behind class) - use red
            const intensity = Math.min(Math.abs(value), 1); // Cap at 1
            if (isDarkMode) {
                // Red shade, with white base, for dark mode
                const r = Math.round(220 + (255 - 220) * (1 - intensity));
                const g = Math.round(53 + (255 - 53) * (1 - intensity));
                const b = Math.round(69 + (255 - 69) * (1 - intensity));
                return `rgb(${r}, ${g}, ${b})`;
            } else {
                // Red shade, with black base, for light mode
                const r = Math.round(220 * intensity);
                const g = Math.round(53 * intensity);
                const b = Math.round(69 * intensity);
                return `rgb(${r}, ${g}, ${b})`;
            }
        }
    }
    
    // Regular progress view
    const percent = Math.round(value * 100);
    
    // Return secondary color for 0%
    if (percent === 0) {
        return '#6c757d'; // Bootstrap secondary color
    }
    
    if (percent <= 50) {
        // Linear interpolation from Bootstrap danger to warning
        const ratio = percent / 50;
        // Bootstrap danger: #dc3545 (220, 53, 69) to warning: #ffc107 (255, 193, 7)
        const r = Math.round(220 + (255 - 220) * ratio);
        const g = Math.round(53 + (193 - 53) * ratio);
        const b = Math.round(69 + (7 - 69) * ratio);
        
        return `rgb(${r}, ${g}, ${b})`;
    } else {
        // Linear interpolation from warning to success
        const ratio = (percent - 50) / 50;
        // Warning: #ffc107 (255, 193, 7) to success: #28a745 (40, 167, 69)
        const r = Math.round(255 + (40 - 255) * ratio);
        const g = Math.round(193 + (167 - 193) * ratio);
        const b = Math.round(7 + (69 - 7) * ratio);
        
        return `rgb(${r}, ${g}, ${b})`;
    }
}

function getCellStyle(value) {
    // Keep this function for backward compatibility but return neutral styles
    return {
        backgroundColor: 'transparent',
        borderColor: '#dee2e6',
        color: getTextColor(value)
    };
}

function getProgressBarStyle(percent) {
    // Use the same three-point gradient logic for progress bars
    const value = percent / 100;
    const color = getTextColor(value);
    
    // For 0%, use default Bootstrap styling
    if (percent === 0) {
        return {
            backgroundColor: '#6c757d' // Bootstrap secondary color
        };
    }
    
    return {
        backgroundColor: color
    };
}

function getBadgeStyle(percent) {
    // Handle comparative view differently
    if (currentViewMode === 'comparative') {
        const value = percent / 100;
        if (value === 0) {
            return {
                backgroundColor: '#6c757d', // Bootstrap secondary color
                color: '#ffffff'
            };
        } else if (value > 0) {
            // Positive difference - green badge
            return {
                backgroundColor: '#28a745', // Bootstrap success color
                color: '#ffffff'
            };
        } else {
            // Negative difference - red badge
            return {
                backgroundColor: '#dc3545', // Bootstrap danger color
                color: '#ffffff'
            };
        }
    }
    
    // Regular progress view
    const value = percent / 100;
    const color = getTextColor(value);
    
    // For 0%, use default Bootstrap styling
    if (percent === 0) {
        return {
            backgroundColor: '#6c757d', // Bootstrap secondary color
            color: '#ffffff'
        };
    }
    
    return {
        backgroundColor: color,
        color: '#ffffff'
    };
}

function showStudentDetails(learnerId) {
    const learner = responseData.learners.find(l => l.id === learnerId);
    if (!learner) return;

    // Create a modern modal for student details
    const modalHtml = `
        <div class="modal fade" id="studentModal" tabindex="-1">
            <div class="modal-dialog modal-xl">
                <div class="modal-content border-0 shadow-lg">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title">
                            <i class="fas fa-user-graduate me-2"></i>
                            Student Details: ${learner.id}
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body p-4">
                        <div class="row g-4">
                            ${responseData.topics.sort((a,b) => a.order - b.order).map((topic, index) => {
                                const topicData = learner.state.topics[topic.id];
                                const progress = (topicData?.overall?.p || 
                                               topicData?.values?.['Coding Problems']?.p || 
                                               topicData?.p || 
                                               0) * 100;
                                const progressPercent = Math.max(0, Math.min(100, Math.round(progress)));
                                
                                return `
                                    <div class="col-md-6">
                                        <div class="card border-0 shadow-sm h-100">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between align-items-center mb-3">
                                                    <h6 class="card-title mb-0 fw-bold">${topic.name}</h6>
                                                    <span class="badge" style="${Object.entries(getBadgeStyle(progressPercent)).map(([key, value]) => `${key.replace(/([A-Z])/g, '-$1').toLowerCase()}: ${value}`).join('; ')}">${progressPercent}%</span>
                                                </div>
                                                <div class="progress mb-3" style="height: 8px;">
                                                    <div class="progress-bar" style="width: ${progressPercent}%; ${Object.entries(getProgressBarStyle(progressPercent)).map(([key, value]) => `${key.replace(/([A-Z])/g, '-$1').toLowerCase()}: ${value}`).join('; ')}"></div>
                                                </div>
                                                <div class="row g-2">
                                                    ${responseData.resources.map(resource => {
                                                        const resourceProgress = (topicData?.values?.[resource.id]?.p || 0) * 100;
                                                        const resourcePercent = Math.round(resourceProgress);
                                                        return `
                                                            <div class="col-6">
                                                                <div class="d-flex justify-content-between align-items-center">
                                                                    <small class="text-muted">${resource.name}</small>
                                                                    <small class="fw-semibold">${resourcePercent}%</small>
                                                                </div>
                                                                <div class="progress" style="height: 4px;">
                                                                    <div class="progress-bar" style="width: ${resourcePercent}%; ${Object.entries(getProgressBarStyle(resourcePercent)).map(([key, value]) => `${key.replace(/([A-Z])/g, '-$1').toLowerCase()}: ${value}`).join('; ')}"></div>
                                                                </div>
                                                            </div>
                                                        `;
                                                    }).join('')}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if any
    const existingModal = document.getElementById('studentModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add new modal to body
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('studentModal'));
    modal.show();
}

function handleCellClick(topicId, resourceId, topicName, resourceName) {
    console.log('Cell clicked:', { topicId, resourceId, topicName, resourceName });
    
    // Get class average data for this topic/resource
    const classAvgData = responseData.groups.find(g => g.name === 'Class Average');
    const classProgress = classAvgData?.state?.topics?.[topicId]?.values?.[resourceId]?.p || 0;
    const classProgressPercent = Math.round(classProgress * 100);
    
    // Get individual student data for this topic/resource
    const studentData = responseData.learners.map(learner => {
        const progress = learner.state.topics?.[topicId]?.values?.[resourceId]?.p || 0;
        const progressPercent = Math.round(progress * 100);
        return {
            id: learner.id,
            progress: progress,
            progressPercent: progressPercent,
            isAboveAverage: progress > classProgress,
            isStruggling: classProgress > 0 && progress < (classProgress * 0.5)
        };
    }).sort((a, b) => b.progress - a.progress); // Sort by progress (highest first)
    
    // Calculate statistics
    const totalStudents = studentData.length;
    const studentsAboveAverage = studentData.filter(s => s.isAboveAverage).length;
    const studentsStruggling = studentData.filter(s => s.isStruggling).length;
    const studentsCompleted = studentData.filter(s => s.progressPercent >= 90).length;
    const averageProgress = studentData.reduce((sum, s) => sum + s.progress, 0) / totalStudents;
    const averageProgressPercent = Math.round(averageProgress * 100);
    
    // Prepare activity definitions for this topic/resource
    const topicDef = responseData.topics.find(t => t.id === topicId);
    const activitiesList = topicDef?.activities?.[resourceId] || [];

    // Create comprehensive modal
    const modalHtml = `
        <div class="modal fade" id="cellModal" tabindex="-1">
            <div class="modal-dialog modal-xl">
                <div class="modal-content border-0 shadow-lg">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title">
                            <i class="fas fa-chart-bar me-2"></i>
                            ${topicName} → ${resourceName}
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body p-4">
                        <!-- Overview Cards -->
                        <div class="row g-3 mb-4">
                            <div class="col-md-3">
                                <div class="card border-0 shadow-sm h-100">
                                    <div class="card-body text-center">
                                        <div class="bg-primary rounded-circle d-inline-flex align-items-center justify-content-center mb-2" style="width: 40px; height: 40px;">
                                            <i class="fas fa-percentage text-white"></i>
                                        </div>
                                        <h6 class="fw-bold mb-1">Class Average</h6>
                                        <div class="h4 fw-bold text-primary">${classProgressPercent}%</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card border-0 shadow-sm h-100">
                                    <div class="card-body text-center">
                                        <div class="bg-success rounded-circle d-inline-flex align-items-center justify-content-center mb-2" style="width: 40px; height: 40px;">
                                            <i class="fas fa-check-circle text-white"></i>
                                        </div>
                                        <h6 class="fw-bold mb-1">Completed</h6>
                                        <div class="h4 fw-bold text-success">${studentsCompleted}</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card border-0 shadow-sm h-100">
                                    <div class="card-body text-center">
                                        <div class="bg-warning rounded-circle d-inline-flex align-items-center justify-content-center mb-2" style="width: 40px; height: 40px;">
                                            <i class="fas fa-exclamation-triangle text-white"></i>
                                        </div>
                                        <h6 class="fw-bold mb-1">Struggling</h6>
                                        <div class="h4 fw-bold text-warning">${studentsStruggling}</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card border-0 shadow-sm h-100">
                                    <div class="card-body text-center">
                                        <div class="bg-info rounded-circle d-inline-flex align-items-center justify-content-center mb-2" style="width: 40px; height: 40px;">
                                            <i class="fas fa-users text-white"></i>
                                        </div>
                                        <h6 class="fw-bold mb-1">Above Average</h6>
                                        <div class="h4 fw-bold text-info">${studentsAboveAverage}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Student Progress Breakdown (with expandable activity rows) -->
                        <div class="row">
                            <div class="col-12">
                                <h6 class="fw-bold mb-3">
                                    <i class="fas fa-list me-2"></i>Student Progress Breakdown
                                </h6>
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th class="fw-bold">Student</th>
                                                <th class="fw-bold text-center">Progress</th>
                                                <th class="fw-bold text-center">Status</th>
                                                <th class="fw-bold text-center">vs Class Avg</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${(() => {
                                                const learnerById = Object.fromEntries(responseData.learners.map(l => [l.id, l]));
                                                return studentData.map((student, idx) => {
                                                    const safeId = String(student.id).replace(/[^a-zA-Z0-9_-]/g, '') + '-' + idx;
                                                    const learner = learnerById[student.id];
                                                    const activityRows = activitiesList.map(activity => {
                                                        const aProg = learner?.state?.activities?.[topicId]?.[resourceId]?.[activity.id]?.values?.p || 0;
                                                        const aPerf = learner?.state?.activities?.[topicId]?.[resourceId]?.[activity.id]?.values?.k;
                                                        const aPct = Math.round(aProg * 100);
                                                        const status = aPct >= 90 ? 'Completed' : (aPct > 0 ? 'In Progress' : 'Not Started');
                                                        const linkHtml = activity.url ? `<a href="${activity.url}" target="_blank" rel="noopener">Open</a>` : '-';
                                                        return `
                                                            <tr>
                                                                <td class="text-break">${activity.name || activity.id}</td>
                                                                <td class="text-center">
                                                                    <div class="progress" style="width: 100px; height: 14px;">
                                                                        <div class="progress-bar" style="width: ${aPct}%; ${Object.entries(getProgressBarStyle(aPct)).map(([k,v]) => `${k.replace(/([A-Z])/g,'-$1').toLowerCase()}: ${v}`).join('; ')}"></div>
                                                                    </div>
                                                                </td>
                                                                <td class="text-center fw-semibold">${aPct}%</td>
                                                                <td class="text-center">
                                                                    ${status === 'Completed' ? '<span class="badge bg-success">Completed</span>' : status === 'In Progress' ? '<span class="badge bg-secondary">In Progress</span>' : '<span class="badge bg-light text-dark">Not Started</span>'}
                                                                </td>
                                                                <td class="text-center">${aPerf !== undefined ? aPerf : '-'}</td>
                                                                <td class="text-center">${linkHtml}</td>
                                                            </tr>`;
                                                    }).join('');
                                                    return `
                                                        <tr class="${student.isStruggling ? 'table-warning' : student.isAboveAverage ? 'table-success' : ''}">
                                                            <td class="fw-bold">
                                                                <button class="btn btn-sm btn-outline-secondary me-2" type="button" data-bs-toggle="collapse" data-bs-target="#act-${safeId}" aria-expanded="false" aria-controls="act-${safeId}">
                                                                    <i class="fas fa-chevron-down"></i>
                                                                </button>
                                                                ${student.id}
                                                            </td>
                                                            <td class="text-center">
                                                                <div class="d-flex align-items-center justify-content-center">
                                                                    <div class="progress me-2" style="width: 100px; height: 20px;">
                                                                        <div class="progress-bar" style="width: ${student.progressPercent}%; background-color: ${getTextColor(student.progress)};"></div>
                                                                    </div>
                                                                    <span class="fw-bold">${student.progressPercent}%</span>
                                                                </div>
                                                            </td>
                                                            <td class="text-center">
                                                                ${student.progressPercent >= 90 ? '<span class="badge bg-success">Completed</span>' : 
                                                                  student.isStruggling ? '<span class="badge bg-warning">Struggling</span>' : 
                                                                  '<span class="badge bg-secondary">In Progress</span>'}
                                                            </td>
                                                            <td class="text-center">
                                                                ${student.isAboveAverage ? 
                                                                    `<span class="text-success fw-bold">+${student.progressPercent - classProgressPercent}%</span>` :
                                                                    student.progress > 0 ? 
                                                                        `<span class="text-danger fw-bold">${student.progressPercent - classProgressPercent}%</span>` :
                                                                        '<span class="text-muted">-</span>'
                                                                }
                                                            </td>
                                                        </tr>
                                                        <tr class="collapse bg-light" id="act-${safeId}">
                                                            <td colspan="4">
                                                                ${activitiesList.length ? `
                                                                <div class="table-responsive">
                                                                    <table class="table table-sm align-middle mb-0">
                                                                        <thead>
                                                                            <tr>
                                                                                <th>Activity</th>
                                                                                <th class="text-center">Progress</th>
                                                                                <th class="text-center">%</th>
                                                                                <th class="text-center">Status</th>
                                                                                <th class="text-center">Performance</th>
                                                                                <th class="text-center">Link</th>
                                                                            </tr>
                                                                        </thead>
                                                                        <tbody>
                                                                            ${activityRows}
                                                                        </tbody>
                                                                    </table>
                                                                </div>` : '<div class="text-muted">No activities listed for this resource.</div>'}
                                                            </td>
                                                        </tr>`;
                                                }).join('');
                                            })()}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if any
    const existingModal = document.getElementById('cellModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add new modal to body
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('cellModal'));
    modal.show();
}

function showError(message) {
    // Create a modern toast notification
    const toastHtml = `
        <div class="toast align-items-center text-white bg-danger border-0" role="alert" aria-live="assertive" aria-atomic="true" style="position: fixed; top: 20px; right: 20px; z-index: 9999;">
            <div class="d-flex">
                <div class="toast-body">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', toastHtml);
    const toast = new bootstrap.Toast(document.querySelector('.toast'));
    toast.show();
    
    // Remove toast after it's hidden
    setTimeout(() => {
        const toastElement = document.querySelector('.toast');
        if (toastElement) {
            toastElement.remove();
        }
    }, 5000);
}
</script>
{% endblock %}