{% extends 'base.html' %}
{% load static %}

{% block title %}Professor Dashboard - ModuLearn{% endblock %}

{% block content %}
<div class="container-fluid py-2 py-md-4">

    <!-- Configuration Section (Initially Collapsed) -->
    <div class="accordion mb-4" id="configAccordion">
        <div class="accordion-item shadow-sm border-0">
            <h2 class="accordion-header" id="headingOne">
                <button class="accordion-button collapsed fw-bold" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="false" aria-controls="collapseOne">
                    <i class="fas fa-cog me-2"></i> Configuration Parameters
                </button>
            </h2>
            <div id="collapseOne" class="accordion-collapse collapse" aria-labelledby="headingOne" data-bs-parent="#configAccordion">
                <div class="accordion-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label for="usr" class="form-label fw-semibold">User ID</label>
                            <input type="text" class="form-control" id="usr" value="jab464">
                        </div>
                        <div class="col-md-3">
                            <label for="grp" class="form-label fw-semibold">Group ID</label>
                            <input type="text" class="form-control" id="grp" value="CMPINF0401Fall20242">
                        </div>
                        <div class="col-md-3">
                            <label for="sid" class="form-label fw-semibold">Session ID</label>
                            <input type="text" class="form-control" id="sid" value="5A195">
                        </div>
                        <div class="col-md-3">
                            <label for="cid" class="form-label fw-semibold">Course ID</label>
                            <input type="text" class="form-control" id="cid" value="417">
                        </div>
                    </div>
                    <div class="text-center mt-4">
                        <button class="btn btn-primary btn-lg px-5" id="fetchDataBtn" data-api-url="{% url 'dashboard:fetch_analytics_data' %}">
                            <span id="fetchBtnText">Load Dashboard</span>
                            <div class="spinner-border spinner-border-sm ms-2 d-none" id="fetchSpinner"></div>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Dashboard Content Area (Hidden until data is loaded) -->
    <div id="dashboardContent" class="d-none">
        <!-- 1. High-Level Course Overview -->
        <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm border-0">
                <div class="card-body">
                        <h1 id="courseTitle" class="h2 mb-3 fw-bold"></h1>
                        <div class="row g-3">
                            <!-- KPI Card: Overall Progress -->
                            <div class="col-sm-6 col-lg-3">
                                <div class="card h-100 border-0 shadow-sm" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                                    <div class="card-body text-center p-3">
                                        <h6 class="text-white-50 fw-bold mb-2">Overall Class Progress</h6>
                                        <div id="overallProgressContainer" class="mt-2" style="position: relative; height: 80px; width: 80px; margin: auto;">
                                             <canvas id="overallProgressChart"></canvas>
                                             <div id="overallProgressText" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 1.2rem; font-weight: bold; color: white;"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- KPI Card: Students Enrolled -->
                            <div class="col-sm-6 col-lg-3">
                                <div class="card h-100 border-0 shadow-sm" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white;">
                                    <div class="card-body text-center p-3">
                                        <h6 class="text-white-50 fw-bold mb-2">Students Enrolled</h6>
                                        <div class="display-5 fw-bold mt-2" id="studentsEnrolled">-</div>
                                    </div>
                                </div>
                            </div>
                            <!-- KPI Card: Topics Covered -->
                            <div class="col-sm-6 col-lg-3">
                                <div class="card h-100 border-0 shadow-sm" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white;">
                                    <div class="card-body text-center p-3">
                                        <h6 class="text-white-50 fw-bold mb-2">Topics Covered</h6>
                                        <div class="display-5 fw-bold mt-2" id="topicsCovered">-</div>
                             </div>
                             </div>
                         </div>
                            <!-- KPI Card: Most Active Topic -->
                            <div class="col-sm-6 col-lg-3">
                                <div class="card h-100 border-0 shadow-sm" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white;">
                                    <div class="card-body text-center p-3">
                                        <h6 class="text-white-50 fw-bold mb-2">Most Active Topic</h6>
                                        <div class="fw-bold mt-2" id="mostActiveTopic" style="font-size: 1rem; line-height: 1.2;">-</div>
                                    </div>
                             </div>
                             </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 2. Topic Breakdown & 4. Resource Usage -->
        <div class="row mb-4 g-3">
            <!-- Topic Progress Chart -->
            <div class="col-lg-8">
                <div class="card shadow-sm border-0 h-100">
                    <div class="card-body p-3 p-md-4">
                        <div class="d-flex align-items-center mb-3">
                            <div class="bg-primary rounded-circle p-2 me-3">
                                <i class="fas fa-chart-bar text-white"></i>
                            </div>
                            <h5 class="card-title fw-bold mb-0">Topic Progress Breakdown</h5>
                        </div>
                        <div style="position: relative; height: 400px;">
                            <canvas id="topicProgressChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Resource Usage Chart -->
            <div class="col-lg-4">
                <div class="card shadow-sm border-0 h-100">
                    <div class="card-body p-3 p-md-4">
                        <div class="d-flex align-items-center mb-3">
                            <div class="bg-success rounded-circle p-2 me-3">
                                <i class="fas fa-pie-chart text-white"></i>
                            </div>
                            <h5 class="card-title fw-bold mb-0">Resource Usage</h5>
                        </div>
                        <div style="position: relative; height: 250px;">
                            <canvas id="resourceUsageChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

        <!-- 3. Student Progress View -->
        <div class="row">
        <div class="col-12">
            <div class="card shadow-sm border-0">
                    <div class="card-body p-3 p-md-4">
                        <div class="d-flex align-items-center mb-4">
                            <div class="bg-info rounded-circle p-2 me-3">
                                <i class="fas fa-users text-white"></i>
                            </div>
                            <h5 class="card-title fw-bold mb-0">Student Progress Details</h5>
                        </div>
                    <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th class="fw-bold border-0">Student ID</th>
                                        <th class="fw-bold border-0 d-none d-sm-table-cell">Overall Progress</th>
                                        <th class="fw-bold border-0 d-sm-none">Progress</th>
                                </tr>
                            </thead>
                                <tbody id="studentTableBody">
                                    <!-- Student rows will be inserted here -->
                            </tbody>
                        </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Student Details Modal -->
    <div class="modal fade" id="studentDetailModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header bg-primary text-white border-0">
                    <h5 class="modal-title fw-bold" id="studentDetailModalLabel">
                        <i class="fas fa-user-graduate me-2"></i>Student Details
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                         </div>
                <div class="modal-body p-4" id="studentDetailModalBody">
                    <!-- Student-specific breakdown will be inserted here -->
            </div>
        </div>
    </div>
</div>

    <!-- Error Alert -->
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
        <div id="errorAlert" class="toast align-items-center text-white bg-danger border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body" id="errorMessage"></div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
<style>
.student-row {
    transition: all 0.2s ease;
}
.student-row:hover {
    background-color: rgba(13, 110, 253, 0.05) !important;
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
.card {
    transition: all 0.3s ease;
}
.card:hover {
    transform: translateY(-2px);
}
.progress {
    box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);
    overflow: visible;
}
.progress-bar {
    transition: width 0.6s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: visible;
}
@media (max-width: 576px) {
    .display-5 {
        font-size: 2rem !important;
    }
    .card-body {
        padding: 1rem !important;
    }
    .table th, .table td {
        padding: 0.75rem 0.5rem;
        font-size: 0.9rem;
    }
}
@media (max-width: 768px) {
    .container-fluid {
        padding-left: 1rem;
        padding-right: 1rem;
    }
}
.fade-in {
    animation: fadeIn 0.5s ease-in;
}
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Accordion styling for student details modal */
.accordion-button:not(.collapsed) {
    background-color: rgba(13, 110, 253, 0.1) !important;
    border-color: rgba(13, 110, 253, 0.2) !important;
}

.accordion-button:focus {
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25) !important;
}

.accordion-item {
    border-radius: 0.5rem !important;
    overflow: hidden;
}

.accordion-button {
    border-radius: 0.5rem !important;
}

.accordion-button:not(.collapsed) {
    border-bottom-left-radius: 0 !important;
    border-bottom-right-radius: 0 !important;
}

.accordion-body {
    background-color: #f8f9fa;
}

/* Activity cards styling */
.activity-card {
    transition: all 0.2s ease;
}

.activity-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
}
</style>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('fetchDataBtn').addEventListener('click', handleFetch);
});

let responseData = null;
let charts = {}; // To hold chart instances

function handleFetch() {
    const btn = document.getElementById('fetchDataBtn');
    const btnText = document.getElementById('fetchBtnText');
    const spinner = document.getElementById('fetchSpinner');
    
    btn.disabled = true;
    btnText.textContent = 'Loading...';
    spinner.classList.remove('d-none');
    
    const params = {
        usr: document.getElementById('usr').value,
        grp: document.getElementById('grp').value,
        sid: document.getElementById('sid').value,
        cid: document.getElementById('cid').value,
        mod: 'all',
        models: '-1',
        avgtop: '-1',
        removeZeroProgressUsers: 'true'
    };
    
    const apiUrl = btn.getAttribute('data-api-url');
    const url = `${apiUrl}?${new URLSearchParams(params)}`;

    fetch(url)
        .then(response => {
            if (!response.ok) throw new Error(`API Error: ${response.statusText}`);
            return response.json();
        })
        .then(data => {
            if (data.error) throw new Error(data.error);
            responseData = data;
            const dashboardContent = document.getElementById('dashboardContent');
            dashboardContent.classList.remove('d-none');
            dashboardContent.classList.add('fade-in');
            const configAccordion = new bootstrap.Collapse(document.getElementById('collapseOne'), { toggle: false });
            configAccordion.hide();
            renderDashboard();
        })
        .catch(error => {
            console.error('Fetch error:', error);
            showError(`Failed to load data: ${error.message}`);
        })
        .finally(() => {
            btn.disabled = false;
            btnText.textContent = 'Load Dashboard';
            spinner.classList.add('d-none');
        });
}

function renderDashboard() {
    if (!responseData) return;

    // Destroy old charts if they exist to prevent conflicts
    Object.values(charts).forEach(chart => chart.destroy());

    populateKPIs();
    renderTopicChart();
    renderResourceChart();
    populateStudentTable();
}

function populateKPIs() {
    const classAvgData = responseData.groups.find(g => g.name === 'Class Average');
    if (!classAvgData) return;

    // Course Title
    document.getElementById('courseTitle').textContent = responseData.context.group.name;

    // Overall Progress
    const topicProgresses = responseData.topics.map(topic => classAvgData.state.topics[topic.id]?.values['Coding Problems']?.p || 0);
    const overallProgress = topicProgresses.reduce((acc, val) => acc + val, 0) / (topicProgresses.length || 1);
    const overallProgressPercent = Math.round(overallProgress * 100);
    
    const progressCtx = document.getElementById('overallProgressChart').getContext('2d');
    charts.overallProgress = new Chart(progressCtx, {
        type: 'doughnut',
        data: {
            datasets: [{
                data: [overallProgressPercent, 100 - overallProgressPercent],
                backgroundColor: ['#0d6efd', '#e9ecef'],
                borderWidth: 0,
            }]
        },
        options: { 
            cutout: '70%', 
            responsive: true, 
            maintainAspectRatio: true, 
            plugins: { 
                legend: { display: false }, 
                tooltip: { enabled: false } 
            },
            animation: {
                animateRotate: true,
                duration: 1000
            }
        }
    });
    document.getElementById('overallProgressText').textContent = `${overallProgressPercent}%`;

    // Students Enrolled
    document.getElementById('studentsEnrolled').textContent = responseData.learners.length;

    // Topics Covered
    const topicsCovered = responseData.topics.filter(topic => (classAvgData.state.topics[topic.id]?.values['Coding Problems']?.p || 0) > 0).length;
    document.getElementById('topicsCovered').textContent = `${topicsCovered} / ${responseData.topics.length}`;

    // Most Active Topic (highest average progress)
    let mostActiveTopic = null;
    let highestProgress = 0;
    responseData.topics.forEach(topic => {
        const progress = classAvgData.state.topics[topic.id]?.values['Coding Problems']?.p || 0;
        if (progress > highestProgress) {
            highestProgress = progress;
            mostActiveTopic = topic;
        }
    });
    
    if (mostActiveTopic) {
        const progressPercent = Math.round(highestProgress * 100);
        // Truncate long topic names for display
        let displayName = mostActiveTopic.name;
        if (displayName.length > 30) {
            displayName = displayName.substring(0, 27) + '...';
        }
        document.getElementById('mostActiveTopic').innerHTML = `${displayName}<br><small class="text-white-50">${progressPercent}% progress</small>`;
    } else {
        document.getElementById('mostActiveTopic').textContent = 'No activity yet';
    }
}

function renderTopicChart() {
    const classAvgData = responseData.groups.find(g => g.name === 'Class Average');
    const topPerformerData = responseData.groups.find(g => g.name === 'Top 1');

    const labels = responseData.topics.sort((a,b) => a.order - b.order).map(t => t.name);
    const classAvgProgress = labels.map(label => {
        const topic = responseData.topics.find(t => t.name === label);
        return (classAvgData.state.topics[topic.id]?.values['Coding Problems']?.p || 0) * 100;
    });

    const ctx = document.getElementById('topicProgressChart').getContext('2d');
    charts.topicProgress = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Class Average Progress',
                data: classAvgProgress,
                backgroundColor: 'rgba(13, 110, 253, 0.6)',
                borderColor: 'rgba(13, 110, 253, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            layout: {
                padding: {
                    left: 10,
                    right: 10
                }
            },
            scales: { 
                x: { 
                    beginAtZero: true, 
                    max: 100, 
                    ticks: { 
                        callback: value => `${value}%`,
                        font: { size: 11 }
                    },
                    grid: { color: 'rgba(0,0,0,0.1)' }
                },
                y: {
                    grid: { display: false },
                    ticks: {
                        font: { size: 10 },
                        maxRotation: 0,
                        callback: function(value, index) {
                            const label = this.getLabelForValue(value);
                            // Truncate long labels and add ellipsis
                            if (label.length > 25) {
                                return label.substring(0, 22) + '...';
                            }
                            return label;
                        }
                    }
                }
            },
            plugins: { 
                legend: { display: false },
                tooltip: {
                    backgroundColor: 'rgba(0,0,0,0.8)',
                    titleColor: 'white',
                    bodyColor: 'white',
                    borderColor: 'rgba(255,255,255,0.2)',
                    borderWidth: 1,
                    callbacks: {
                        title: function(tooltipItems) {
                            // Show full topic name in tooltip
                            return tooltipItems[0].label;
                        }
                    }
                }
            }
        }
    });
}

function renderResourceChart() {
    const classAvgData = responseData.groups.find(g => g.name === 'Class Average');
    const resourceUsage = {};

    responseData.resources.forEach(res => {
        resourceUsage[res.name] = 0;
        responseData.topics.forEach(topic => {
            resourceUsage[res.name] += classAvgData.state.topics[topic.id]?.values[res.id]?.p || 0;
        });
    });

    const labels = Object.keys(resourceUsage);
    const data = Object.values(resourceUsage);

    const ctx = document.getElementById('resourceUsageChart').getContext('2d');
    charts.resourceUsage = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: ['#0d6efd', '#6c757d', '#198754', '#ffc107', '#dc3545'],
            }]
        },
        options: { 
            responsive: true, 
            maintainAspectRatio: false,
            plugins: { 
                legend: { 
                    position: 'bottom',
                    labels: {
                        usePointStyle: true,
                        padding: 20,
                        font: { size: 12 }
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0,0,0,0.8)',
                    titleColor: 'white',
                    bodyColor: 'white',
                    borderColor: 'rgba(255,255,255,0.2)',
                    borderWidth: 1
                }
            }
        }
    });
}

function populateStudentTable() {
    const tableBody = document.getElementById('studentTableBody');
    tableBody.innerHTML = '';
    
    // Sort learners alphanumerically by ID
    const sortedLearners = responseData.learners
        .filter(learner => !learner.isHidden)
        .sort((a, b) => {
            // Natural sort for human-readable ordering (handles numbers properly)
            return a.id.localeCompare(b.id, undefined, { numeric: true, sensitivity: 'base' });
        });

    sortedLearners.forEach(learner => {
        // Debug logging to understand data structure
        console.log(`\n=== Student ${learner.id} Debug Info ===`);
        console.log('Full learner object:', learner);
        console.log('Learner state:', learner.state);
        console.log('Available topics:', responseData.topics.map(t => ({ id: t.id, name: t.name })));
        
        if (responseData.topics[0]) {
            const firstTopic = responseData.topics[0];
            console.log(`First topic (${firstTopic.name}) data for student:`, learner.state.topics[firstTopic.id]);
        }

        // Try different possible data structures for progress
        const topicProgresses = responseData.topics.map(topic => {
            const topicData = learner.state.topics[topic.id];
            // Try multiple possible paths for progress data
            const progress = topicData?.overall?.p || 
                           topicData?.values?.['Coding Problems']?.p || 
                           topicData?.p || 
                           0;
            console.log(`Topic ${topic.name} progress:`, progress, 'from data:', topicData);
            return progress;
        });
        
        const overallProgress = topicProgresses.reduce((acc, val) => acc + val, 0) / (topicProgresses.length || 1);

        console.log(`Final calculations for ${learner.id}:`, {
            topicProgresses,
            overallProgress
        });
        console.log('=== End Debug Info ===\n');

        // Calculate percentages and ensure they're valid numbers
        const progressPercent = Math.max(0, Math.min(100, Math.round(overallProgress * 100)));
        
        console.log(`Progress bar values for ${learner.id}:`, {
            overallProgress,
            progressPercent
        });

        const row = document.createElement('tr');
        row.style.cursor = 'pointer';
        row.className = 'student-row';
        
        // Create progress bar with explicit debugging
        const progressBarHtml = `
            <div class="progress" style="height: 24px; border-radius: 12px; background-color: #f8f9fa; border: 1px solid #dee2e6;">
                <div class="progress-bar" role="progressbar" 
                     style="width: ${progressPercent}%; border-radius: 12px; background: linear-gradient(90deg, #0d6efd, #6610f2); min-width: ${progressPercent > 0 ? '2px' : '0'};" 
                     aria-valuenow="${progressPercent}" aria-valuemin="0" aria-valuemax="100">
                    <span class="fw-semibold text-white" style="padding: 0 8px; line-height: 24px;">${progressPercent}%</span>
                </div>
            </div>
        `;
        
        row.innerHTML = `
            <td class="fw-medium border-0">${learner.id}</td>
            <td class="border-0">
                ${progressBarHtml}
            </td>
        `;
        
        console.log(`Generated HTML for ${learner.id}:`, row.innerHTML);
        row.addEventListener('click', () => showStudentDetailsModal(learner.id));
        tableBody.appendChild(row);
    });
}

function showStudentDetailsModal(learnerId) {
    const learner = responseData.learners.find(l => l.id === learnerId);
    if (!learner) return;

    document.getElementById('studentDetailModalLabel').textContent = `Details for Student: ${learner.id}`;
    const modalBody = document.getElementById('studentDetailModalBody');
    
    let content = '<div class="accordion" id="topicAccordion">';
    responseData.topics.sort((a,b) => a.order - b.order).forEach((topic, index) => {
        const topicData = learner.state.topics[topic.id];
        // Try multiple possible paths for progress data
        const progress = (topicData?.overall?.p || 
                         topicData?.values?.['Coding Problems']?.p || 
                         topicData?.p || 
                         0) * 100;
        
        const progressPercent = Math.max(0, Math.min(100, Math.round(progress)));
        
        console.log(`Modal - Topic ${topic.name} for ${learner.id}:`, {
            topicData,
            rawProgress: progress / 100,
            progressPercent: progressPercent
        });
        
        // Generate activities list for this topic
        let activitiesContent = '';
        if (responseData.resources && responseData.resources.length > 0) {
            activitiesContent = '<div class="row g-2">';
            responseData.resources.forEach(resource => {
                const activityProgress = (topicData?.values?.[resource.id]?.p || 0) * 100;
                const activityProgressPercent = Math.max(0, Math.min(100, Math.round(activityProgress)));
                
                activitiesContent += `
                    <div class="col-12">
                        <div class="card border-0 bg-white shadow-sm activity-card">
                            <div class="card-body p-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <div class="d-flex align-items-center">
                                        <i class="bi bi-activity text-primary me-2"></i>
                                        <span class="fw-medium">${resource.name}</span>
                                        </div>
                                    <span class="badge bg-info rounded-pill px-2 py-1" style="font-size: 0.75rem;">
                                        ${activityProgressPercent}%
                                    </span>
                                </div>
                                <div class="progress" style="height: 8px; border-radius: 4px; background-color: #f8f9fa; border: 1px solid #dee2e6;">
                                    <div class="progress-bar" role="progressbar" 
                                         style="width: ${activityProgressPercent}%; background: linear-gradient(90deg, #17a2b8, #20c997); border-radius: 4px; min-width: ${activityProgressPercent > 0 ? '2px' : '0'};"></div>
                                </div>
                            </div>
                        </div>
            </div>
        `;
            });
            activitiesContent += '</div>';
    } else {
            activitiesContent = '<p class="text-muted mb-0">No activities available for this topic.</p>';
        }
        
        content += `
            <div class="accordion-item border-0 mb-3">
                <h2 class="accordion-header" id="heading${index}">
                    <button class="accordion-button collapsed bg-light border-0 rounded-3 shadow-sm" type="button" 
                            data-bs-toggle="collapse" data-bs-target="#collapse${index}" 
                            aria-expanded="false" aria-controls="collapse${index}"
                            style="transition: all 0.2s ease;">
                        <div class="d-flex justify-content-between align-items-center w-100 me-3">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-book text-primary me-2"></i>
                                <span class="fw-bold">${topic.name}</span>
                            </div>
                            <div class="d-flex align-items-center gap-3">
                                <span class="badge bg-primary rounded-pill px-3 py-2">${progressPercent}%</span>
                                <div class="progress" style="width: 100px; height: 8px; border-radius: 4px; background-color: #f8f9fa; border: 1px solid #dee2e6;">
                                    <div class="progress-bar" role="progressbar" 
                                         style="width: ${progressPercent}%; background: linear-gradient(90deg, #0d6efd, #6610f2); border-radius: 4px; min-width: ${progressPercent > 0 ? '2px' : '0'};"></div>
                                </div>
                            </div>
                        </div>
                    </button>
                </h2>
                <div id="collapse${index}" class="accordion-collapse collapse" 
                     aria-labelledby="heading${index}" data-bs-parent="#topicAccordion">
                    <div class="accordion-body pt-3 pb-4 px-4">
                        <h6 class="text-muted mb-3 fw-semibold">
                            <i class="bi bi-list-task me-1"></i>
                            Activities in this topic:
                        </h6>
                        ${activitiesContent}
                    </div>
                </div>
            </div>
        `;
    });
    content += '</div>';
    modalBody.innerHTML = content;
    
    const modal = new bootstrap.Modal(document.getElementById('studentDetailModal'));
    modal.show();
}

function showError(message) {
    const errorToastEl = document.getElementById('errorAlert');
    document.getElementById('errorMessage').textContent = message;
    const errorToast = new bootstrap.Toast(errorToastEl);
    errorToast.show();
}
</script>
{% endblock %}