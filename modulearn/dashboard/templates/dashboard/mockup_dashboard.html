{% extends 'base.html' %}
{% load static %}

{% block title %}Learning Analytics Dashboard - ModuLearn{% endblock %}

{% block content %}
<div class="container-fluid py-2 py-md-4">

    <!-- Modern Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-lg" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <div class="card-body text-white p-4">
                    <div class="d-flex align-items-center mb-4">
                        <div class="bg-white bg-opacity-20 rounded-circle p-3 me-3">
                            <i class="fas fa-chart-line text-dark fs-3"></i>
                        </div>
                        <div>
                            <h1 class="h2 mb-1 fw-bold">Learning Analytics Dashboard</h1>
                            <p class="mb-0 opacity-75">Advanced mastery tracking with interactive grid visualization</p>
                        </div>
                    </div>
                    
                    <!-- Configuration Form -->
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label for="usr" class="form-label fw-semibold text-white">User ID</label>
                            <input type="text" class="form-control form-control-lg" id="usr" value="jab464" placeholder="Enter user ID">
                        </div>
                        <div class="col-md-3">
                            <label for="grp" class="form-label fw-semibold text-white">Group ID</label>
                            <input type="text" class="form-control form-control-lg" id="grp" value="CMPINF0401Fall20242" placeholder="Enter group ID">
                        </div>
                        <div class="col-md-3">
                            <label for="sid" class="form-label fw-semibold text-white">Session ID</label>
                            <input type="text" class="form-control form-control-lg" id="sid" value="5A195" placeholder="Enter session ID">
                        </div>
                        <div class="col-md-3">
                            <label for="cid" class="form-label fw-semibold text-white">Course ID</label>
                            <input type="text" class="form-control form-control-lg" id="cid" value="417" placeholder="Enter course ID">
                        </div>
                    </div>
                    <div class="text-center mt-4">
                        <button class="btn btn-dark btn-lg px-5 fw-bold" id="fetchDataBtn" data-api-url="{% url 'dashboard:fetch_analytics_data' %}">
                            <i class="fas fa-rocket me-2"></i>
                            <span id="fetchBtnText">Launch Analytics</span>
                            <div class="spinner-border spinner-border-sm ms-2 d-none" id="fetchSpinner"></div>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Dashboard Content Area (Hidden until data is loaded) -->
    <div id="dashboardContent" class="d-none">
        <!-- Modern Analytics Overview -->
        <div class="row mb-4">
        <div class="col-12">
                <div class="card border-0 shadow-lg">
                    <div class="card-body p-4">
                        <div class="d-flex align-items-center mb-4">
                            <div class="bg-gradient-primary rounded-circle p-3 me-3">
                                <i class="fas fa-chart-line text-white fs-4"></i>
                            </div>
                            <div>
                                <h2 id="courseTitle" class="h3 mb-1 fw-bold">Course Analytics</h2>
                                <p class="text-muted mb-0">Interactive mastery grid with real-time progress tracking</p>
                            </div>
                        </div>
                        
                        <!-- KPI Cards Grid -->
                        <div class="row g-4">
                            <div class="col-lg-3 col-md-6">
                                <div class="card border-0 shadow-sm h-100" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                                    <div class="card-body text-white text-center p-4">
                                        <div class="bg-white bg-opacity-20 rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 60px; height: 60px;">
                                            <i class="fas fa-percentage fs-4"></i>
                                        </div>
                                        <h6 class="text-white-50 fw-bold mb-2">Overall Progress</h6>
                                        <div class="display-4 fw-bold" id="overallProgress">-</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-3 col-md-6">
                                <div class="card border-0 shadow-sm h-100" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                                    <div class="card-body text-white text-center p-4">
                                        <div class="bg-white bg-opacity-20 rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 60px; height: 60px;">
                                            <i class="fas fa-users fs-4"></i>
                                        </div>
                                        <h6 class="text-white-50 fw-bold mb-2">Students</h6>
                                        <div class="display-4 fw-bold" id="studentsEnrolled">-</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-3 col-md-6">
                                <div class="card border-0 shadow-sm h-100" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                                    <div class="card-body text-white text-center p-4">
                                        <div class="bg-white bg-opacity-20 rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 60px; height: 60px;">
                                            <i class="fas fa-book fs-4"></i>
                                        </div>
                                        <h6 class="text-white-50 fw-bold mb-2">Topics</h6>
                                        <div class="display-4 fw-bold" id="topicsCovered">-</div>
                             </div>
                             </div>
                         </div>
                            <div class="col-lg-3 col-md-6">
                                <div class="card border-0 shadow-sm h-100" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                                    <div class="card-body text-white text-center p-4">
                                        <div class="bg-white bg-opacity-20 rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 60px; height: 60px;">
                                            <i class="fas fa-fire fs-4"></i>
                                        </div>
                                        <h6 class="text-white-50 fw-bold mb-2">Active Topic</h6>
                                        <div class="fw-bold" id="mostActiveTopic" style="font-size: 1.1rem; line-height: 1.2;">-</div>
                                    </div>
                             </div>
                             </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modern Mastery Grid -->
        <div class="row">
            <div class="col-12">
                <div class="card border-0 shadow-lg">
                    <div class="card-header bg-white border-0 py-4">
                        <div class="d-flex align-items-center justify-content-between">
                            <div class="d-flex align-items-center">
                                <div class="bg-gradient-primary rounded-circle p-2 me-3">
                                    <i class="fas fa-th text-white"></i>
                                </div>
                                <div>
                                    <h4 class="mb-1 fw-bold">Mastery Grid</h4>
                                    <p class="text-muted mb-0">Click any cell to view detailed progress</p>
                                </div>
                            </div>
                            <div class="d-flex gap-2">
                                <div class="btn-group" role="group">
                                    <input type="radio" class="btn-check" name="viewMode" id="myProgress" value="myProgress" checked>
                                    <label class="btn btn-outline-secondary" for="myProgress">
                                        <i class="fas fa-user me-1"></i>My Progress
                                    </label>
                                    <input type="radio" class="btn-check" name="viewMode" id="classAverage" value="classAverage">
                                    <label class="btn btn-outline-success" for="classAverage">
                                        <i class="fas fa-users me-1"></i>Class Average
                                    </label>
                                    <input type="radio" class="btn-check" name="viewMode" id="perStudent" value="perStudent">
                                    <label class="btn btn-outline-primary" for="perStudent">
                                        <i class="fas fa-list me-1"></i>Per Student
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0" id="masteryGrid">
                                <thead class="table-light">
                                    <tr id="gridHeaders">
                                        <th class="border-0 fw-bold py-3" style="min-width: 300px;">
                                            <div class="d-flex align-items-center">
                                                <i class="fas fa-graduation-cap text-primary me-2"></i>
                                                Topics
                </div>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="gridBody">
                                    <!-- Dynamic grid content will be inserted here -->
                                </tbody>
                            </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

        <!-- Per Student View -->
        <div class="row" id="perStudentView" style="display: none;">
            <div class="col-12">
                <div class="card border-0 shadow-lg">
                    <div class="card-header bg-white border-0 py-4">
                        <div class="d-flex align-items-center justify-content-between">
                            <div class="d-flex align-items-center">
                                <div class="bg-gradient-info rounded-circle p-2 me-3">
                                    <i class="fas fa-users text-white"></i>
                                </div>
                                <div>
                                    <h4 class="mb-1 fw-bold">Student Progress Overview</h4>
                                    <p class="text-muted mb-0">Individual student progress tracking</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0" id="studentTable">
                                <thead class="table-light">
                                    <tr>
                                        <th class="border-0 fw-bold py-3">
                                            <div class="d-flex align-items-center">
                                                <i class="fas fa-user-graduate text-primary me-2"></i>
                                                Student ID
                                            </div>
                                        </th>
                                        <th class="border-0 fw-bold py-3 text-center">
                                            <div class="d-flex align-items-center justify-content-center">
                                                <i class="fas fa-chart-line text-primary me-2"></i>
                                                Overall Progress
                                            </div>
                                        </th>
                                        <th class="border-0 fw-bold py-3 text-center">
                                            <div class="d-flex align-items-center justify-content-center">
                                                <i class="fas fa-book text-primary me-2"></i>
                                                Topics Completed
                                            </div>
                                        </th>
                                        <th class="border-0 fw-bold py-3 text-center">
                                            <div class="d-flex align-items-center justify-content-center">
                                                <i class="fas fa-star text-primary me-2"></i>
                                                Performance
                                            </div>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="studentTableBody">
                                    <!-- Dynamic student rows will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modern Legend -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <h6 class="fw-bold mb-3">
                            <i class="fas fa-info-circle text-primary me-2"></i>
                            Progress Legend
                        </h6>
                        <div class="row g-3">
                            <div class="col-md-2">
                                <div class="d-flex align-items-center">
                                    <div class="cell-not-started me-3" style="width: 24px; height: 24px;"></div>
                                    <div>
                                        <div class="fw-semibold">Not Started</div>
                                        <small class="text-muted">0% progress</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="d-flex align-items-center">
                                    <div class="cell-low me-3" style="width: 24px; height: 24px;"></div>
                                    <div>
                                        <div class="fw-semibold">Getting Started</div>
                                        <small class="text-muted">1-25% progress</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="d-flex align-items-center">
                                    <div class="cell-medium-low me-3" style="width: 24px; height: 24px;"></div>
                                    <div>
                                        <div class="fw-semibold">Making Progress</div>
                                        <small class="text-muted">26-50% progress</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="d-flex align-items-center">
                                    <div class="cell-medium me-3" style="width: 24px; height: 24px;"></div>
                                    <div>
                                        <div class="fw-semibold">Good Progress</div>
                                        <small class="text-muted">51-75% progress</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="d-flex align-items-center">
                                    <div class="cell-high me-3" style="width: 24px; height: 24px;"></div>
                                    <div>
                                        <div class="fw-semibold">Almost There</div>
                                        <small class="text-muted">76-90% progress</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="d-flex align-items-center">
                                    <div class="cell-complete me-3" style="width: 24px; height: 24px;"></div>
                                    <div>
                                        <div class="fw-semibold">Complete</div>
                                        <small class="text-muted">91-100% progress</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Student Details Modal -->
    <div class="modal fade" id="studentDetailModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header bg-primary text-white border-0">
                    <h5 class="modal-title fw-bold" id="studentDetailModalLabel">
                        <i class="fas fa-user-graduate me-2"></i>Student Details
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                         </div>
                <div class="modal-body p-4" id="studentDetailModalBody">
                    <!-- Student-specific breakdown will be inserted here -->
            </div>
        </div>
    </div>
</div>

    <!-- Error Alert -->
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
        <div id="errorAlert" class="toast align-items-center text-white bg-danger border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body" id="errorMessage"></div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
<style>
/* Modern Dashboard Styling */
.student-row {
    transition: all 0.2s ease;
}
.student-row:hover {
    background-color: rgba(13, 110, 253, 0.05) !important;
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.card {
    transition: all 0.3s ease;
    background-color: #ffffff !important;
    border: 1px solid #e9ecef !important;
    color: #212529 !important;
}
.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.1) !important;
}

.progress {
    box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);
    overflow: visible;
    background-color: #e9ecef !important;
}

.progress-bar {
    transition: width 0.6s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: visible;
}

/* Fix toggle buttons - CRITICAL FIX */
.btn-group .btn-check:checked + .btn-outline-primary {
    background-color: #0d6efd !important;
    border-color: #0d6efd !important;
    color: white !important;
}

.btn-outline-primary {
    color: #0d6efd !important;
    border-color: #0d6efd !important;
    background-color: white !important;
    border: 2px solid #0d6efd !important;
    font-weight: 500 !important;
}

.btn-outline-primary:hover {
    background-color: #0d6efd !important;
    border-color: #0d6efd !important;
    color: white !important;
}

.btn-outline-primary:focus {
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25) !important;
}

/* Ensure all text is visible */
.text-primary {
    color: #0d6efd !important;
}
.text-white {
    color: white !important;
}
.text-muted {
    color: #6c757d !important;
}

/* Fix button styling */
.btn {
    background-color: white;
    border: 2px solid #0d6efd;
    color: #0d6efd;
    font-weight: 500;
}

.btn-primary {
    background-color: #0d6efd !important;
    border-color: #0d6efd !important;
    color: white !important;
}

.btn-primary:hover {
    background-color: #0b5ed7 !important;
    border-color: #0a58ca !important;
    color: white !important;
}

/* Fix card backgrounds */
.card {
    background-color: #ffffff !important;
    border: 1px solid #dee2e6 !important;
    color: #212529 !important;
}

.card-header {
    background-color: #f8f9fa !important;
    border-bottom: 1px solid #dee2e6 !important;
    color: #212529 !important;
}

/* Fix table backgrounds */
.table {
    background-color: #ffffff !important;
    color: #212529 !important;
}

.table th {
    background-color: #f8f9fa !important;
    color: #212529 !important;
    border-bottom: 2px solid #dee2e6 !important;
    font-weight: 600 !important;
}

.table td {
    background-color: #ffffff !important;
    color: #212529 !important;
    border-bottom: 1px solid #dee2e6 !important;
}

.table-light {
    background-color: #f8f9fa !important;
}

.table tbody tr:hover {
    background-color: rgba(13, 110, 253, 0.05) !important;
}

/* Fix form controls */
.form-control {
    background-color: #ffffff !important;
    border: 1px solid #ced4da !important;
    color: #212529 !important;
}

.form-control:focus {
    background-color: #ffffff !important;
    border-color: #86b7fe !important;
    color: #212529 !important;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25) !important;
}

.form-label {
    color: #212529 !important;
    font-weight: 600 !important;
}

/* Modern grid cell styling with improved color scale */
.cell-not-started {
    background-color: #f8f9fa !important;
    border: 2px solid #e9ecef !important;
    color: #6c757d !important;
    font-weight: 600 !important;
}

.cell-low {
    background-color: #fff3cd !important;
    border: 2px solid #ffc107 !important;
    color: #856404 !important;
    font-weight: 600 !important;
}

.cell-medium-low {
    background-color: #d1ecf1 !important;
    border: 2px solid #17a2b8 !important;
    color: #0c5460 !important;
    font-weight: 600 !important;
}

.cell-medium {
    background-color: #d4edda !important;
    border: 2px solid #28a745 !important;
    color: #155724 !important;
    font-weight: 600 !important;
}

.cell-high {
    background-color: #cce5ff !important;
    border: 2px solid #007bff !important;
    color: #004085 !important;
    font-weight: 600 !important;
}

.cell-complete {
    background-color: #28a745 !important;
    border: 2px solid #1e7e34 !important;
    color: #ffffff !important;
    font-weight: 700 !important;
}

/* Dark mode support for grid cells - improved contrast */
@media (prefers-color-scheme: dark) {
    .cell-not-started {
        background-color: #2d3748 !important;
        border-color: #4a5568 !important;
        color: #a0aec0 !important;
    }
    
    .cell-low {
        background-color: #744210 !important;
        border-color: #ffc107 !important;
        color: #ffffff !important;
    }
    
    .cell-medium-low {
        background-color: #0c5460 !important;
        border-color: #17a2b8 !important;
        color: #ffffff !important;
    }
    
    .cell-medium {
        background-color: #155724 !important;
        border-color: #28a745 !important;
        color: #ffffff !important;
    }
    
    .cell-high {
        background-color: #004085 !important;
        border-color: #007bff !important;
        color: #ffffff !important;
    }
    
    .cell-complete {
        background-color: #28a745 !important;
        border-color: #1e7e34 !important;
        color: #ffffff !important;
    }
}

.cursor-pointer:hover {
    transform: scale(1.02);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

/* Progress bar color scale - improved visibility */
.progress-minimal {
    background-color: #6c757d !important;
}

.progress-low {
    background-color: #ffc107 !important;
}

.progress-medium {
    background-color: #17a2b8 !important;
}

.progress-high {
    background-color: #007bff !important;
}

.progress-complete {
    background-color: #28a745 !important;
}

/* Badge color scale - improved visibility */
.badge-minimal {
    background-color: #6c757d !important;
    color: white !important;
    font-weight: 600 !important;
}

.badge-low {
    background-color: #ffc107 !important;
    color: #212529 !important;
    font-weight: 600 !important;
}

.badge-medium {
    background-color: #17a2b8 !important;
    color: white !important;
    font-weight: 600 !important;
}

.badge-high {
    background-color: #007bff !important;
    color: white !important;
    font-weight: 600 !important;
}

.badge-complete {
    background-color: #28a745 !important;
    color: white !important;
    font-weight: 700 !important;
}

/* Badge styling - improved visibility */
.badge {
    font-size: 0.75em;
    padding: 0.5em 0.75em;
    font-weight: 600;
    border-radius: 0.375rem;
}

/* Grid cell improvements */
.cursor-pointer {
    cursor: pointer !important;
    transition: all 0.2s ease;
}

.cursor-pointer:hover {
    transform: scale(1.02);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 10;
    position: relative;
}

/* Ensure all text is readable */
h1, h2, h3, h4, h5, h6 {
    color: #212529 !important;
}

p, span, div {
    color: inherit;
}

/* Icon improvements */
.fas, .far, .fab {
    color: inherit !important;
}

/* Ensure proper spacing and alignment */
.d-flex {
    align-items: center;
}

/* Improve form styling */
.form-control {
    border-radius: 0.375rem;
    font-weight: 500;
}

.form-control:focus {
    border-color: #86b7fe;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}

/* Table styling improvements */
.table th {
    background-color: #f8f9fa;
    border-bottom: 2px solid #dee2e6;
    font-weight: 600;
}

.table td {
    vertical-align: middle;
}

/* Responsive design */
@media (max-width: 576px) {
    .display-5 {
        font-size: 2rem !important;
    }
    .card-body {
        padding: 1rem !important;
    }
    .table th, .table td {
        padding: 0.75rem 0.5rem;
        font-size: 0.9rem;
    }
}

@media (max-width: 768px) {
    .container-fluid {
        padding-left: 1rem;
        padding-right: 1rem;
    }
}

.fade-in {
    animation: fadeIn 0.5s ease-in;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Gradient backgrounds for better visual appeal */
.bg-gradient-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
}

.bg-gradient-info {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%) !important;
}

/* Enhanced button styling - improved visibility */
.btn-group .btn {
    border-radius: 0.375rem;
    font-weight: 600;
    transition: all 0.2s ease;
}

.btn-group .btn:first-child {
    border-top-right-radius: 0;
    border-bottom-right-radius: 0;
}

.btn-group .btn:last-child {
    border-top-left-radius: 0;
    border-bottom-left-radius: 0;
}

.btn-group .btn:not(:first-child):not(:last-child) {
    border-radius: 0;
}

/* Ensure button group visibility */
.btn-group .btn-check:checked + .btn-outline-primary {
    background-color: #0d6efd !important;
    border-color: #0d6efd !important;
    color: white !important;
    font-weight: 600 !important;
}

.btn-group .btn-outline-primary {
    color: #0d6efd !important;
    border-color: #0d6efd !important;
    background-color: white !important;
    font-weight: 600 !important;
}

.btn-group .btn-outline-primary:hover {
    background-color: #0d6efd !important;
    border-color: #0d6efd !important;
    color: white !important;
}

/* Modal enhancements */
.modal-content {
    border-radius: 0.75rem;
}

.modal-header {
    border-radius: 0.75rem 0.75rem 0 0;
}

/* Remove rounded corners for modern look */
.progress {
    border-radius: 0;
}

.progress-bar {
    border-radius: 0;
}

.card {
    border-radius: 0;
}

.btn {
    border-radius: 0;
}

.modal-content {
    border-radius: 0;
}

.modal-header {
    border-radius: 0;
}

/* Card hover effects */
.card:hover {
    box-shadow: 0 8px 25px rgba(0,0,0,0.1) !important;
}

/* Table row hover effects */
.table tbody tr:hover {
    background-color: rgba(13, 110, 253, 0.05) !important;
}

/* Dark mode support for overall theme - improved contrast */
@media (prefers-color-scheme: dark) {
    /* Body and main backgrounds */
    body {
        background-color: #1a202c !important;
        color: #e2e8f0 !important;
    }
    
    /* Cards */
    .card {
        background-color: #2d3748 !important;
        border-color: #4a5568 !important;
        color: #e2e8f0 !important;
    }
    
    .card-header {
        background-color: #4a5568 !important;
        border-color: #718096 !important;
        color: #e2e8f0 !important;
    }
    
    /* Tables */
    .table {
        background-color: #2d3748 !important;
        color: #e2e8f0 !important;
    }
    
    .table th {
        background-color: #4a5568 !important;
        border-color: #718096 !important;
        color: #e2e8f0 !important;
    }
    
    .table td {
        background-color: #2d3748 !important;
        border-color: #4a5568 !important;
        color: #e2e8f0 !important;
    }
    
    .table tbody tr:hover {
        background-color: rgba(66, 153, 225, 0.1) !important;
    }
    
    .table-light {
        background-color: #4a5568 !important;
    }
    
    /* Buttons - improved visibility */
    .btn-outline-primary {
        color: #63b3ed !important;
        border-color: #63b3ed !important;
        background-color: transparent !important;
        border-width: 2px !important;
    }
    
    .btn-outline-primary:hover {
        background-color: #63b3ed !important;
        border-color: #63b3ed !important;
        color: #1a202c !important;
    }
    
    .btn-group .btn-check:checked + .btn-outline-primary {
        background-color: #63b3ed !important;
        border-color: #63b3ed !important;
        color: #1a202c !important;
    }
    
    .btn-primary {
        background-color: #63b3ed !important;
        border-color: #63b3ed !important;
        color: #1a202c !important;
    }
    
    .btn-primary:hover {
        background-color: #4299e1 !important;
        border-color: #4299e1 !important;
        color: #1a202c !important;
    }
    
    /* Text colors */
    .text-primary {
        color: #63b3ed !important;
    }
    
    .text-muted {
        color: #a0aec0 !important;
    }
    
    .text-white {
        color: white !important;
    }
    
    /* Background colors */
    .bg-primary {
        background-color: #63b3ed !important;
    }
    
    .bg-info {
        background-color: #0bc5ea !important;
    }
    
    .bg-white {
        background-color: #2d3748 !important;
    }
    
    /* Modals */
    .modal-content {
        background-color: #2d3748 !important;
        color: #e2e8f0 !important;
    }
    
    .modal-header {
        background-color: #4a5568 !important;
        border-color: #718096 !important;
        color: #e2e8f0 !important;
    }
    
    .modal-body {
        background-color: #2d3748 !important;
        color: #e2e8f0 !important;
    }
    
    /* Form elements */
    .form-control {
        background-color: #4a5568 !important;
        border-color: #718096 !important;
        color: #e2e8f0 !important;
    }
    
    .form-control:focus {
        background-color: #4a5568 !important;
        border-color: #63b3ed !important;
        color: #e2e8f0 !important;
        box-shadow: 0 0 0 0.25rem rgba(99, 179, 237, 0.25) !important;
    }
    
    .form-label {
        color: #e2e8f0 !important;
    }
    
    /* Progress bars */
    .progress {
        background-color: #4a5568 !important;
    }
    
    /* Badges */
    .badge {
        color: white !important;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('fetchDataBtn').addEventListener('click', handleFetch);
    
    // View mode change listeners
    document.querySelectorAll('input[name="viewMode"]').forEach(radio => {
        radio.addEventListener('change', function() {
            currentViewMode = this.value;
            updateGrid();
        });
    });
});

let responseData = null;
let currentViewMode = 'myProgress';

function handleFetch() {
    const btn = document.getElementById('fetchDataBtn');
    const btnText = document.getElementById('fetchBtnText');
    const spinner = document.getElementById('fetchSpinner');
    
    btn.disabled = true;
    btnText.textContent = 'Loading...';
    spinner.classList.remove('d-none');
    
    const params = {
        usr: document.getElementById('usr').value,
        grp: document.getElementById('grp').value,
        sid: document.getElementById('sid').value,
        cid: document.getElementById('cid').value,
        mod: 'all',
        models: '-1',
        avgtop: '-1',
        removeZeroProgressUsers: 'true'
    };
    
    const apiUrl = btn.getAttribute('data-api-url');
    const url = `${apiUrl}?${new URLSearchParams(params)}`;

    fetch(url)
        .then(response => {
            if (!response.ok) throw new Error(`API Error: ${response.statusText}`);
            return response.json();
        })
        .then(data => {
            if (data.error) throw new Error(data.error);
            responseData = data;
            const dashboardContent = document.getElementById('dashboardContent');
            dashboardContent.classList.remove('d-none');
            dashboardContent.classList.add('fade-in');
            renderDashboard();
        })
        .catch(error => {
            console.error('Fetch error:', error);
            showError(`Failed to load data: ${error.message}`);
        })
        .finally(() => {
            btn.disabled = false;
            btnText.textContent = 'Launch Analytics';
            spinner.classList.add('d-none');
        });
}

function renderDashboard() {
    if (!responseData) return;
    
    populateKPIs();
    updateGrid();
}

function populateKPIs() {
    const classAvgData = responseData.groups.find(g => g.name === 'Class Average');
    if (!classAvgData) return;

    // Course Title
    document.getElementById('courseTitle').textContent = responseData.context.group.name;

    // Overall Progress
    const topicProgresses = responseData.topics.map(topic => classAvgData.state.topics[topic.id]?.values['Coding Problems']?.p || 0);
    const overallProgress = topicProgresses.reduce((acc, val) => acc + val, 0) / (topicProgresses.length || 1);
    const overallProgressPercent = Math.round(overallProgress * 100);
    document.getElementById('overallProgress').textContent = `${overallProgressPercent}%`;

    // Students Enrolled
    document.getElementById('studentsEnrolled').textContent = responseData.learners.length;

    // Topics Covered
    const topicsCovered = responseData.topics.filter(topic => (classAvgData.state.topics[topic.id]?.values['Coding Problems']?.p || 0) > 0).length;
    document.getElementById('topicsCovered').textContent = `${topicsCovered} / ${responseData.topics.length}`;

    // Most Active Topic
    let mostActiveTopic = null;
    let highestProgress = 0;
    responseData.topics.forEach(topic => {
        const progress = classAvgData.state.topics[topic.id]?.values['Coding Problems']?.p || 0;
        if (progress > highestProgress) {
            highestProgress = progress;
            mostActiveTopic = topic;
        }
    });
    
    if (mostActiveTopic) {
        const progressPercent = Math.round(highestProgress * 100);
        let displayName = mostActiveTopic.name;
        if (displayName.length > 25) {
            displayName = displayName.substring(0, 22) + '...';
        }
        document.getElementById('mostActiveTopic').innerHTML = `${displayName}<br><small class="text-white-50">${progressPercent}%</small>`;
    } else {
        document.getElementById('mostActiveTopic').textContent = 'No activity yet';
    }
}

function updateGrid() {
    if (!responseData) return;
    
    // Show/hide views based on current mode
    const masteryGrid = document.getElementById('masteryGrid').closest('.row');
    const perStudentView = document.getElementById('perStudentView');
    
    if (currentViewMode === 'perStudent') {
        masteryGrid.style.display = 'none';
        perStudentView.style.display = 'block';
        updatePerStudentView();
    } else {
        masteryGrid.style.display = 'block';
        perStudentView.style.display = 'none';
        updateMasteryGrid();
    }
}

function updateMasteryGrid() {
    // Update grid headers
    const gridHeaders = document.getElementById('gridHeaders');
    while (gridHeaders.children.length > 1) {
        gridHeaders.removeChild(gridHeaders.lastChild);
    }
    
    // Add resource headers
    responseData.resources.forEach(resource => {
        const th = document.createElement('th');
        th.className = 'border-0 fw-bold text-center py-3';
        th.style.minWidth = '120px';
        th.innerHTML = `
            <div class="d-flex flex-column align-items-center">
                <i class="fas fa-tasks text-primary mb-1"></i>
                <span class="small text-break">${resource.name}</span>
            </div>
        `;
        gridHeaders.appendChild(th);
    });
    
    // Update grid body
    const gridBody = document.getElementById('gridBody');
    gridBody.innerHTML = '';
    
    // Get current data based on view mode
    const currentData = currentViewMode === 'myProgress' 
        ? responseData.learners.find(learner => learner.id === responseData.context.learnerId)
        : responseData.groups.find(group => group.name === 'Class Average');
    
    if (!currentData) return;
    
    // Sort topics by order
    const sortedTopics = responseData.topics.sort((a, b) => a.order - b.order);
    
    // Create grid rows
    sortedTopics.forEach((topic, index) => {
        const row = document.createElement('tr');
        row.className = index % 2 === 0 ? 'table-light' : '';
        
        // Topic cell with modern styling
        const topicCell = document.createElement('td');
        topicCell.className = 'border-0 py-3';
        topicCell.innerHTML = `
            <div class="d-flex align-items-center">
                <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 32px; height: 32px;">
                    <span class="text-white fw-bold small">${topic.order}</span>
                </div>
                <div class="flex-grow-1">
                    <div class="fw-bold mb-1">${topic.name}</div>
                    <div class="progress" style="height: 6px; background-color: rgba(0,0,0,0.1);">
                        <div class="progress-bar bg-primary" role="progressbar" style="width: ${getTopicProgress(currentData, topic.id) * 100}%"></div>
                    </div>
                </div>
                <div class="ms-3">
                    <span class="badge bg-primary">${Math.round(getTopicProgress(currentData, topic.id) * 100)}%</span>
                </div>
            </div>
        `;
        row.appendChild(topicCell);
        
        // Resource cells with modern grid styling
        responseData.resources.forEach(resource => {
            const cell = document.createElement('td');
            const value = getCellValue(currentData, topic.id, resource.id);
            const cellClass = getCellClass(value);
            
            cell.className = `text-center border-0 py-3 ${cellClass} cursor-pointer`;
            cell.style.cursor = 'pointer';
            cell.style.transition = 'all 0.2s ease';
            cell.style.borderRadius = '0';
            cell.onclick = () => handleCellClick(topic.id, resource.id, topic.name, resource.name);
            
            cell.innerHTML = `
                <div class="d-flex flex-column align-items-center">
                    <div class="fw-bold fs-5">${Math.round(value * 100)}%</div>
                </div>
            `;
            
            row.appendChild(cell);
        });
        
        gridBody.appendChild(row);
    });
}

function updatePerStudentView() {
    const tableBody = document.getElementById('studentTableBody');
    tableBody.innerHTML = '';
    
    // Sort learners alphanumerically by ID
    const sortedLearners = responseData.learners
        .filter(learner => !learner.isHidden)
        .sort((a, b) => {
            return a.id.localeCompare(b.id, undefined, { numeric: true, sensitivity: 'base' });
        });

    sortedLearners.forEach((learner, index) => {
        // Calculate overall progress
        const topicProgresses = responseData.topics.map(topic => {
            const topicData = learner.state.topics[topic.id];
            const progress = topicData?.overall?.p || 
                           topicData?.values?.['Coding Problems']?.p || 
                           topicData?.p || 
                           0;
            return progress;
        });
        
        const overallProgress = topicProgresses.reduce((acc, val) => acc + val, 0) / (topicProgresses.length || 1);
        const progressPercent = Math.max(0, Math.min(100, Math.round(overallProgress * 100)));
        
        // Calculate topics completed
        const topicsCompleted = topicProgresses.filter(p => p >= 0.9).length;
        const totalTopics = responseData.topics.length;
        
        // Calculate performance (average of all topic progress)
        const performance = Math.round(overallProgress * 100);
        
        const row = document.createElement('tr');
        row.className = index % 2 === 0 ? 'table-light' : '';
        row.style.cursor = 'pointer';
        row.onclick = () => showStudentDetails(learner.id);
        
        row.innerHTML = `
            <td class="border-0 py-3">
                <div class="d-flex align-items-center">
                    <div class="bg-info rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 32px; height: 32px;">
                        <i class="fas fa-user text-white"></i>
                    </div>
                    <div class="fw-bold">${learner.id}</div>
                </div>
            </td>
            <td class="border-0 py-3 text-center">
                <div class="d-flex flex-column align-items-center">
                    <div class="fw-bold fs-5 mb-2">${progressPercent}%</div>
                    <div class="progress" style="width: 120px; height: 8px; border-radius: 4px;">
                        <div class="progress-bar ${getProgressBarClass(progressPercent)}" role="progressbar" style="width: ${progressPercent}%"></div>
                    </div>
                </div>
            </td>
            <td class="border-0 py-3 text-center">
                <div class="d-flex flex-column align-items-center">
                    <div class="fw-bold fs-5 mb-1">${topicsCompleted}/${totalTopics}</div>
                    <div class="small text-muted">Topics</div>
                </div>
            </td>
            <td class="border-0 py-3 text-center">
                <div class="d-flex flex-column align-items-center">
                    <span class="badge ${getPerformanceBadgeClass(performance)} fs-6">${performance}%</span>
                    <div class="small text-muted mt-1">Performance</div>
                </div>
            </td>
        `;
        
        tableBody.appendChild(row);
    });
}

function getTopicProgress(data, topicId) {
    if (!data?.state?.topics?.[topicId]?.overall) return 0;
    return data.state.topics[topicId].overall.p || 0;
}

function getCellValue(data, topicId, resourceId) {
    if (!data?.state?.topics?.[topicId]?.values?.[resourceId]) return 0;
    return data.state.topics[topicId].values[resourceId].p || 0;
}

function getCellClass(value) {
    // Smooth color scale based on value
    if (value === 0) return 'cell-not-started';
    if (value <= 0.25) return 'cell-low';
    if (value <= 0.5) return 'cell-medium-low';
    if (value <= 0.75) return 'cell-medium';
    if (value <= 0.9) return 'cell-high';
    return 'cell-complete';
}

function getProgressBarClass(percent) {
    if (percent >= 90) return 'progress-complete';
    if (percent >= 70) return 'progress-high';
    if (percent >= 50) return 'progress-medium';
    if (percent >= 25) return 'progress-low';
    return 'progress-minimal';
}

function getPerformanceBadgeClass(percent) {
    if (percent >= 90) return 'badge-complete';
    if (percent >= 70) return 'badge-high';
    if (percent >= 50) return 'badge-medium';
    if (percent >= 25) return 'badge-low';
    return 'badge-minimal';
}

function showStudentDetails(learnerId) {
    const learner = responseData.learners.find(l => l.id === learnerId);
    if (!learner) return;

    // Create a modern modal for student details
    const modalHtml = `
        <div class="modal fade" id="studentModal" tabindex="-1">
            <div class="modal-dialog modal-xl">
                <div class="modal-content border-0 shadow-lg">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title">
                            <i class="fas fa-user-graduate me-2"></i>
                            Student Details: ${learner.id}
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body p-4">
                        <div class="row g-4">
                            ${responseData.topics.sort((a,b) => a.order - b.order).map((topic, index) => {
                                const topicData = learner.state.topics[topic.id];
                                const progress = (topicData?.overall?.p || 
                                               topicData?.values?.['Coding Problems']?.p || 
                                               topicData?.p || 
                                               0) * 100;
                                const progressPercent = Math.max(0, Math.min(100, Math.round(progress)));
                                
                                return `
                                    <div class="col-md-6">
                                        <div class="card border-0 shadow-sm h-100">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between align-items-center mb-3">
                                                    <h6 class="card-title mb-0 fw-bold">${topic.name}</h6>
                                                    <span class="badge ${getPerformanceBadgeClass(progressPercent)}">${progressPercent}%</span>
                                                </div>
                                                <div class="progress mb-3" style="height: 8px;">
                                                    <div class="progress-bar ${getProgressBarClass(progressPercent)}" style="width: ${progressPercent}%"></div>
                                                </div>
                                                <div class="row g-2">
                                                    ${responseData.resources.map(resource => {
                                                        const resourceProgress = (topicData?.values?.[resource.id]?.p || 0) * 100;
                                                        const resourcePercent = Math.round(resourceProgress);
                                                        return `
                                                            <div class="col-6">
                                                                <div class="d-flex justify-content-between align-items-center">
                                                                    <small class="text-muted">${resource.name}</small>
                                                                    <small class="fw-semibold">${resourcePercent}%</small>
                                                                </div>
                                                                <div class="progress" style="height: 4px;">
                                                                    <div class="progress-bar ${getProgressBarClass(resourcePercent)}" style="width: ${resourcePercent}%"></div>
                                                                </div>
                                                            </div>
                                                        `;
                                                    }).join('')}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if any
    const existingModal = document.getElementById('studentModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add new modal to body
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('studentModal'));
    modal.show();
}

function handleCellClick(topicId, resourceId, topicName, resourceName) {
    console.log('Cell clicked:', { topicId, resourceId, topicName, resourceName });
    
    // Create a modern modal for cell details
    const modalHtml = `
        <div class="modal fade" id="cellModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content border-0 shadow-lg">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title">
                            <i class="fas fa-chart-bar me-2"></i>
                            ${topicName}  ${resourceName}
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                    <div class="modal-body p-4">
                        <div class="text-center py-5">
                            <div class="bg-light rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 64px; height: 64px;">
                                <i class="fas fa-chart-pie text-primary fs-3"></i>
                            </div>
                            <h6 class="fw-bold">Detailed Progress Information</h6>
                            <p class="text-muted">This feature will show detailed progress breakdown for the selected topic and resource combination.</p>
                        </div>
                    </div>
                    </div>
                </div>
            </div>
        `;
    
    // Remove existing modal if any
    const existingModal = document.getElementById('cellModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add new modal to body
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('cellModal'));
    modal.show();
}

function showError(message) {
    // Create a modern toast notification
    const toastHtml = `
        <div class="toast align-items-center text-white bg-danger border-0" role="alert" aria-live="assertive" aria-atomic="true" style="position: fixed; top: 20px; right: 20px; z-index: 9999;">
            <div class="d-flex">
                <div class="toast-body">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', toastHtml);
    const toast = new bootstrap.Toast(document.querySelector('.toast'));
    toast.show();
    
    // Remove toast after it's hidden
    setTimeout(() => {
        const toastElement = document.querySelector('.toast');
        if (toastElement) {
            toastElement.remove();
        }
    }, 5000);
}
</script>
{% endblock %}